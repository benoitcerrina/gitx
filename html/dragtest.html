<html>
	<head>
		
		<link rel="stylesheet" href="css/GitX.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<link rel="stylesheet" href="css/diff.css" type="text/css" media="screen" title="no title" charset="utf-8">
		<script src="lib/GitX.js" type="text/javascript" charset="utf-8"></script>
		<script src="lib/diffHighlighter.js" type="text/javascript" charset="utf-8"></script>
		
		<style type="text/css" media="screen">
			#lijstmetdingen {
				font-size: 50%;
			}
			.line {
			}
                        #selected {
				background-color: #B5D5FE !important;
/*				-webkit-border-radius: 3px;
				-webkit-box-sizing: border-box;/*
				width: 100%;
/*				border: 1px solid red;*/
/*				padding-left: 3px !important;/*
/*				padding-right: 3px !important;/*
/*				margin-left: -3px !important;
				margin-right: -3px !important;
*/			}
                        #selected div {
				background-color: #B5D5FE;
                        }
			#stageButton {
			    float: right;
			    display: block;
			    height: 1.25em;
			    padding: 4px;
			    -webkit-border-radius: 4px;
			    background-color: white !important;
			    border: 1px solid blue;
			    margin-top: .5em;
			    margin-right: .5em;
			    z-index: -100;
			}
                        #stageButton.disabled {
			    display: none;
                        }
			
		</style>

		<script type="text/javascript" charset="utf-8">


    
var findsubhunk = function(start) {
  var bounds=[{node:null,move:"previousSibling"},{node:null,move:"nextSibling"}];
  for (var b in bounds) {
    b=bounds[b];
    var out=false;
    var place=start;
    for(var next=place[b.move]; next; next=next[b.move]) {
      if(!(cls=next.getAttribute("class")) || cls=="hunkheader") break;
      if(cls=="noopline") {
	out=true; // Out of the add/del region
      } else if (out) break;
      place=next; // It's a good position
    }
    b.node=place;
  }
  return bounds;
}

var nodeIndex = function(list, element) {
    for (i = 0; i < list.childNodes.length; ++i)
	if (list.childNodes[i] == element)
	    return i;
    return -1;
}

var deselect = function() {
    var selection = document.getElementById("selected");
    if (selection) {
	while (selection.childNodes[1])
	    selection.parentNode.insertBefore(selection.childNodes[1], selection);
	selection.parentNode.removeChild(selection);
    }
}
  
var showSelection = function(list, from, to)
{
    var startIndex = nodeIndex(list, from);
    var endIndex = nodeIndex(list, to);
    if (startIndex == -1 || endIndex == -1)
	return;
    
    // new Array().slice() doesn't work with elementnodes :(
    // So we create an array ourselves
    var elementList = [];
    var goodselection=false;
    var up=startIndex<endIndex?true:false;
    var addelem=up?"push":"unshift";
    for (i = startIndex; up?(i <= endIndex):(i >= endIndex); up?++i:--i) {
	var cls=from.parentNode.childNodes[i].getAttribute("class");
	if(cls=="hunkheader") break; // Stay in hunk
	elementList[addelem](from.parentNode.childNodes[i]);
	if(!goodselection && (cls=="addline" || cls=="delline"))
	    goodselection=true;
    }
    var selection = document.createElement("div");
    selection.setAttribute("id", "selected");

    var button = document.createElement("div");
    button.appendChild(document.createTextNode("Stage lines"));
    button.setAttribute("id", "stageButton");
    
    if (goodselection) {
	button.onmousedown = function() {
	    while (selection.firstChild)
		selection.removeChild(selection.firstChild);
	    return false;
	}
    } else {
	button.setAttribute("class","disabled");
    }
    selection.appendChild(button);
    
    list.insertBefore(selection, from);
    for (i = 0; i < elementList.length; i++)
	selection.appendChild(elementList[i]);
}
  
var load = function()
{
    document.onmousedown = function(event) {
	if(event.which!=1) return false;
	deselect();
    }
    document.onselectstart = function () {return false;};
    
    highlightDiff($("orig_diff").value,
		  $("lijstmetdingen"),  { });
  
    var list = document.getElementsByClassName("lines");

    document.onmouseup = function(event) { // Handle button releases outside of lines list
	for (i = 0; i < list.length; ++i) {
	    file=list[i];
	    file.onmouseover=null;
	    file.onmouseup=null;
	}
    }

    for (i = 0; i < list.length; ++i) {
	var file = list[i];
	file.ondblclick = function (event) {
	    deselect();
	    var file=event.target.parentNode;
	    var start=event.target;
	    var cls=start.getAttribute("class");
	    if(!cls || !(cls=="addline" | cls=="delline")) return; 
	    var bounds=findsubhunk(start)
	    showSelection(file,bounds[0].node,bounds[1].node,true);
	    return false;
	};

	
	file.onmousedown = function(event) {
	    if (event.which!=1) return false;
	    deselect();
	    var file=event.target.parentNode;
	    if (event.srcElement.getAttribute("class") == "hunkheader")
		return false;
	    
	    file.onmouseup = function(event) {
		file.onmouseover = null;
		file.onmouseup = null;
		event.stopPropagation();
		return false;
	    };
	
	    file.onmouseover = function(event2) {
		deselect();
		showSelection(file, event.srcElement, event2.target);
		return false;
	    };
	    showSelection(file, event.srcElement, event.srcElement);
	    event.stopPropagation();
	    return false;
	}
    }
}
</script>
	</head>
	<body onload="load()">
<textarea style='display:none' id="orig_diff" rows="8" cols="40">
diff --git a/.gitignore b/.gitignore
new file mode 100644
index 0000000..496616a
--- /dev/null
+++ b/.gitignore
@@ -0,0 +1,4 @@
+*.elc
+\#*
+.\#*
+*~
\ No newline at end of file
diff --git a/CHANGES b/CHANGES
index 12f7408..858dc34 100644
--- a/CHANGES
+++ b/CHANGES
@@ -1,9 +1,83 @@
-This is the CHANGES file of the IDLWAVE distribution, version VERSIONTAG 
+This is the CHANGES file of the IDLWAVE distribution, version 6.2pre2 
 
 The file covers only the changes for Revision 3.0 and later.  Earlier
 changes are documented in the (obsolete) files idl.el and
 idl-shell.el, available at idlwave.org.
 
+Revision 6.2 (incorporating changes to version 6.1 for Emacs 22)
+================================================================
+   - Support for the new Eclipse-based help system, including direct
+     keyword linking.
+   - Structure tag completion now enabled by default.
+   - Improved fontification handling of keywords, especially in
+     continued statements and routine definitions (routine keywords
+     stay fontified as you edit!).
+   - Fails gracefully if no help is installed (e.g. for IDL <6.1
+     without any HTML help module).
+   - A new "help with topic" (C-M-?) to lookup inidividual help topics
+     in the IDL help system, with completion.
+   - Better handling of spaces and IDL formatting quirks for syncing
+     the current working directory.
+   - HideShow support.  Just add `hs-minor-mode' to the mode hook (or
+     type M-x hs-minor-mode), and you can quickly hide and show
+     logical blocks, entire routines, etc.  Very useful for long files
+     filled with many routines.
+   - Trim out spurious "None" superclasses in routine information of
+     classes without inheritance.  You may need to rebuild your XML
+     Help catalog to accomplish this (IDLWAVE->Routine Info->Rescan
+     XML Help Catalog).
+   - Automatically list the enclosing routine name in the
+     ChangeLog (C-x 4 a append a new ChangeLog entry).
+   - Changing the break condition or repeat count on a disabled
+     breakpoint now works correctly.
+   - Can customize the height of the shell buffer when it is displayed
+     in the same frame (see `idlwave-shell-buffer-height-frac').
+   - Default command (C-c C-d C-y) prompts for the default command to
+     execute, if it hasn't yet been set.  It also no longer resets IDL.
+   - Direct support in the shell for multi-line commands ending in '&'
+     executed as a single statement (e.g. FOR loops).  Use C-c SPACE
+     to add a new command line at the IDL> prompt.
+   - When using up/down arrows to cycle through history in the Shell,
+     first move through multi-line commands line by line.  Only when
+     at the beginning or end is the next history item recalled.  This
+     makes editing and re-executing multi-line commands much easier.
+     Hold shift when hitting up/down arrow to skip through the full
+     multi-line command with one keypress (the old behavior).
+
+Revision 6.0
+=============
+   - Use the new HTML help and XML routine info catalog distributed
+     with IDL starting with version 6.2.  Help is now available
+     without a separate download, and is always in sync with IDLWAVE's
+     routine information.
+   - Use the new IDL Assistant directly by default to display bundled
+     HTML help.
+   - Fall back on class help for methods without any help entry.
+   - Allow keyword inheritence on system classes, in addition to user
+     classes with *_EXTRA keywords.
+   - Much better handling of >, <, >=, <=, ->, &, and && for space
+     padding with optional idlwave-surround-by-blank and
+     idlwave-do-actions.
+   - Limit the total length printed when examining long arrays, using
+     'idlwave_print_safe'.  Default limit 200.
+   - Read-only prompt in the shell with Emacs 22.
+   - No more complaints when compiling filenames with space.
+   - New convience command "e" in Electric Debug Mode, which prompts
+     for an expression to print.
+   - Better caching of path and system directory info gleaned from the
+     shell.
+   - Better checking/recompilation for idlwave_* helper routines
+     (e.g. if you are a frequent .full_reset_session user).
+   - Made default block indent 3 and main level indent 2 (users who
+     like the old defaults can customize and set
+     idlwave-main-block-indent to 0, idlwave-block-indent to 3,
+     idlwave-end-offset to -3, and idlwave-continuation-indent to 2).
+   - When stepping through code, the highlight color of the line where
+     IDL is currently stopped changes to gray temporarily, until IDL
+     stops at another line, to give feedback for long operations.
+   - When compiling files, the routine info for routines in that file
+     alone are updated from the shell, to avoid slow-down for very
+     large numbers of routines.  C-c TAB updates all of them.
 
 
 Revision 5.6
diff --git a/INSTALL b/INSTALL
index 93092f3..553af6a 100644
--- a/INSTALL
+++ b/INSTALL
@@ -38,9 +38,14 @@ in /usr/local/share/emacs/site-lisp/, which is a fine place.
 HTML Help packages
 ---------------------------------------------------------------------------
 
+As of IDL 6.2 and IDLWAVE 6.0, all HTML help is provided by default
+with your installation of IDL, and nothing further needs to be
+installed.  For systems older than IDL 6.2, HTML help can be installed
+separately.
+
 Note that you do *not* need to update your help package with each
 version of IDLWAVE, but only when you change IDL versions -- there is
-only one help package per IDL version.
+only one help package per IDL version (v5.6-v6.1).
 
 To install the HTML Help (needed for context-aware online help), get:
 
@@ -107,12 +112,12 @@ in your startup scripts.
 ========================
 
 In order to install IDLWAVE by hand, put the files `idlwave.el',
-`idlw-rinfo.el', `idlw-shell.el', `idlw-help.el', and
-`idlw-toolbar.el', and, optionally, `idlw-roprompt.el' and
-`idlw-complete-structtag.el' into the chosen load-path directory and
-byte-compile them (from within Emacs, execute `M-x byte-compile-file'
-followed by the name of the Lisp files).  You can ignore the warnings
-produced by the byte compiler.
+`idlw-rinfo.el' (if in the distribution), `idlw-shell.el',
+`idlw-help.el', and `idlw-toolbar.el', and, optionally,
+`idlw-roprompt.el' and `idlw-complete-structtag.el' into the chosen
+load-path directory and byte-compile them (from within Emacs, execute
+`M-x byte-compile-file' followed by the name of the Lisp files).  You
+can ignore the warnings produced by the byte compiler.
 
 Copy the info file `idlwave' into the directory where Emacs info files
 are kept and (optionally) add an entry to the `dir' file.
@@ -121,22 +126,28 @@ are kept and (optionally) add an entry to the `dir' file.
 ===========================
 
 In order to install IDLWAVE with the make utility, examine the header
-of the file `Makefile', and change any defaults necessary.  You need
-to specify the Lisp installation directory and the directory where the
-Info files are installed (see note under 2a).  Also, check the name of
-the Emacs executable (usually either `emacs' or `xemacs').
+of the file `Makefile', and change any default directory locations as
+necessary.  You need to specify the Lisp installation directory and
+the directory where the Info files are installed (see note under 2a).
+Also, check the name of the Emacs executable (usually either `emacs'
+or `xemacs').
 
 Then, type 
 
    make
    make install
    make install-info
+
+and, for manually installed HTML help (only necessary with IDL 6.1 or
+earlier):
+
    make install-help
 
 to compile and install the code, the info files, and the HTML help (if
-updating it).  Note that the help installation requires downloading
-the separate help package, and needs to be performed only when your
-version of IDL changes.
+installing or updating it).  Note that the help installation requires
+downloading the separate help package, and needs to be performed only
+when your version of IDL changes, and is unnecessary starting with IDL
+v6.2.
 
 
 2c. PRE-BUILT XEMACS PACKAGE
@@ -153,6 +164,11 @@ system-wide installation):
 
 M-x package-admin-add-binary-package [Ret] /path/to/idlwave-xemacs.tar.gz
 
+Note that if you install IDLWAVE by hand under XEmacs, you need to
+ensure that the following XEmacs packages are also installed:
+
+fsf-compat xemacs-base mail-lib
+
 See INSTALLING ONLINE HELP below for information on adding the online
 help package to your installation.
 
@@ -199,7 +215,10 @@ OPTIONAL STEPS
 
 N.B. THE HELP PACKAGE ONLY NEEDS TO BE UPDATED WHEN NEW VERSIONS OF
 IDL ARE RELEASED AND THE DOCUMENTATION IS SCANNED.  IDLWAVE CAN BE
-UPDATED SEPARATELY.
+UPDATED SEPARATELY.  
+
+AS OF IDL v6.2, NO ADDITIONAL HELP PACKAGES NEED TO BE INSTALLED,
+SINCE ALL NECESSARY HELP FILES ARE PROVIDED WITH IDL.
 
 If you want IDLWAVE to display online help for built-in IDL routines,
 you need the HTML version of the IDL documentation.  This package is
diff --git a/Makefile b/Makefile
index baf309b..1125ced 100644
--- a/Makefile
+++ b/Makefile
@@ -68,30 +68,30 @@ CP = cp -p
 ##----------------------------------------------------------------------
 
 # The following variables need to be defined by the maintainer
-LISPFILES  = idlwave.el idlw-help.el idlw-shell.el idlw-rinfo.el \
+LISPFILES  = idlwave.el idlw-help.el idlw-shell.el\
 	     idlw-toolbar.el idlw-complete-structtag.el idlw-roprompt.el 
 ELCFILES   = $(LISPFILES:.el=.elc)
 TEXIFILES  = idlwave.texi
 INFOFILES  = idlwave
 RINFOFILES = idlw-rinfo.el
 HTMLHELPDIR  = idl_html_help
-DLDIR     = /var/www/html/idlwave/download
-HTMLDIR    = /var/www/html/idlwave/
+DLDIR     = /Volumes/www/idlwave/download
+HTMLDIR    = /Volumes/www/idlwave/
 XEMACSDIR  = packages/xemacs-packages/idlwave
 
 .SUFFIXES: .el .elc .texi
 SHELL = /bin/sh
 
-DISTFILES= README INSTALL CHANGES ChangeLog COPYING Makefile\
+DISTFILES= README INSTALL CHANGES COPYING Makefile\
 	$(LISPFILES) $(TEXIFILES) $(INFOFILES) lpath.el\
-	get_html_rinfo idlwave_catalog tutorial.pro
+	idlwave_catalog tutorial.pro
 
 WEBDISTFILES= idlwave.ps idlwave.pdf idlwave.html CHANGES
 HELPDISTFILES= $(HTMLHELPDIR)
 HELPDISTFILE=idlwave-idlv$(IDL)-help.tar.bz2
-XEMACSDISTFILES= README INSTALL CHANGES ChangeLog COPYING\
+XEMACSDISTFILES= README INSTALL CHANGES COPYING\
 	$(LISPFILES) $(TEXIFILES) $(INFOFILES)\
-	get_html_rinfo idlwave_catalog tutorial.pro
+	idlwave_catalog tutorial.pro
 
 EMACSDISTFILES= $(LISPFILES) $(TEXIFILES) ChangeLog
 
diff --git a/README b/README
index 3c3fa8f..52c1f00 100644
--- a/README
+++ b/README
@@ -12,28 +12,24 @@ lpath.el            A file needed to compile the lisp files
 
 idlwave.el          The Lisp code for idlwave-mode
 idlw-shell.el       The Lisp code for idlwave-shell-mode
-idlw-rinfo.el       The Lisp constant for routine-info and help links
 idlw-help.el        The Lisp code for the help system
 idlw-toolbar.el     The Lisp code for the toolbar
 idlw-complete-structtag.el 
 		    The Lisp code for optional structure tag completion
-idlw-roprompt.el    The Lisp code for the optional read-only prompt
+idlw-roprompt.el    The Lisp code for the optional read-only prompt 
+		    (unnecessary with Emacs >= 22)
 
 idlwave.texi        The TeX-Info documentation source
-idlwave    \
-idlwave-1   >       The Info files (the documentation in Info format)
-idlwave-2  /
-idlwave-3 /
+idlwave             The Info files (the documentation in Info format)
 
-idlwave_catalog     A Perl program to produce library catalog 
+idlwave_catalog     A Perl program to produce your own library catalog 
                     ".idlwave_catalog" files.
-get_html_rinfo      A Perl program to scan the IDL documentation and
-                    produce several files used by IDLWAVE online help.
 
-tutorial.pro        Intentionally buggy source code for the tutorial.  
-                    See the`Getting Started' section in the manual.
+tutorial.pro        Intentionally buggy practice source code for the 
+		    tutorial.  See the`Getting Started' section in the 
+	            manual.
 
 The most recent version of IDLWAVE and associated help files are
 available at:
 
-    http://idlwave.org
\ No newline at end of file
+    http://idlwave.org
diff --git a/doclicense.texi b/doclicense.texi
new file mode 100644
index 0000000..83e9d6b
--- /dev/null
+++ b/doclicense.texi
@@ -0,0 +1,416 @@
+@c -*-texinfo-*-
+@center Version 1.2, November 2002
+
+@display
+Copyright (C) 2000,2001,2002  Free Software Foundation, Inc.
+51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+
+Everyone is permitted to copy and distribute verbatim copies
+of this license document, but changing it is not allowed.
+@end display
+@sp 1
+@enumerate 0
+@item
+PREAMBLE
+
+The purpose of this License is to make a manual, textbook, or other
+functional and useful document ``free'' in the sense of freedom: to
+assure everyone the effective freedom to copy and redistribute it,
+with or without modifying it, either commercially or noncommercially.
+Secondarily, this License preserves for the author and publisher a way
+to get credit for their work, while not being considered responsible
+for modifications made by others.
+
+This License is a kind of ``copyleft,'' which means that derivative
+works of the document must themselves be free in the same sense.  It
+complements the GNU General Public License, which is a copyleft
+license designed for free software.
+
+We have designed this License in order to use it for manuals for free
+software, because free software needs free documentation: a free
+program should come with manuals providing the same freedoms that the
+software does.  But this License is not limited to software manuals;
+it can be used for any textual work, regardless of subject matter or
+whether it is published as a printed book.  We recommend this License
+principally for works whose purpose is instruction or reference.
+
+@sp 1
+@item
+APPLICABILITY AND DEFINITIONS
+
+This License applies to any manual or other work, in any medium, that
+contains a notice placed by the copyright holder saying it can be
+distributed under the terms of this License.  Such a notice grants a
+world-wide, royalty-free license, unlimited in duration, to use that
+work under the conditions stated herein.  The ``Document,'' below,
+refers to any such manual or work.  Any member of the public is a
+licensee, and is addressed as ``you.''  You accept the license if you
+copy, modify or distribute the work in a way requiring permission
+under copyright law.
+
+A ``Modified Version'' of the Document means any work containing the
+Document or a portion of it, either copied verbatim, or with
+modifications and/or translated into another language.
+
+A ``Secondary Section'' is a named appendix or a front-matter section of
+the Document that deals exclusively with the relationship of the
+publishers or authors of the Document to the Document's overall subject
+(or to related matters) and contains nothing that could fall directly
+within that overall subject.  (Thus, if the Document is in part a
+textbook of mathematics, a Secondary Section may not explain any
+mathematics.)  The relationship could be a matter of historical
+connection with the subject or with related matters, or of legal,
+commercial, philosophical, ethical or political position regarding
+them.
+
+The ``Invariant Sections'' are certain Secondary Sections whose titles
+are designated, as being those of Invariant Sections, in the notice
+that says that the Document is released under this License.  If a
+section does not fit the above definition of Secondary then it is not
+allowed to be designated as Invariant.  The Document may contain zero
+Invariant Sections.  If the Document does not identify any Invariant
+Sections then there are none.
+
+The ``Cover Texts'' are certain short passages of text that are listed,
+as Front-Cover Texts or Back-Cover Texts, in the notice that says that
+the Document is released under this License.  A Front-Cover Text may
+be at most 5 words, and a Back-Cover Text may be at most 25 words.
+
+A ``Transparent'' copy of the Document means a machine-readable copy,
+represented in a format whose specification is available to the
+general public, that is suitable for revising the document
+straightforwardly with generic text editors or (for images composed of
+pixels) generic paint programs or (for drawings) some widely available
+drawing editor, and that is suitable for input to text formatters or
+for automatic translation to a variety of formats suitable for input
+to text formatters.  A copy made in an otherwise Transparent file
+format whose markup, or absence of markup, has been arranged to thwart
+or discourage subsequent modification by readers is not Transparent.
+An image format is not Transparent if used for any substantial amount
+of text.  A copy that is not ``Transparent'' is called ``Opaque.''
+
+
+Examples of suitable formats for Transparent copies include plain
+ASCII without markup, Texinfo input format, LaTeX input format, SGML
+or XML using a publicly available DTD, and standard-conforming simple
+HTML, PostScript or PDF designed for human modification.  Examples of
+transparent image formats include PNG, XCF and JPG.  Opaque formats
+include proprietary formats that can be read and edited only by
+proprietary word processors, SGML or XML for which the DTD and/or
+processing tools are not generally available, and the
+machine-generated HTML, PostScript or PDF produced by some word
+processors for output purposes only.
+
+The ``Title Page'' means, for a printed book, the title page itself,
+plus such following pages as are needed to hold, legibly, the material
+this License requires to appear in the title page.  For works in
+formats which do not have any title page as such, ``Title Page'' means
+the text near the most prominent appearance of the work's title,
+preceding the beginning of the body of the text.
+
+A section ``Entitled XYZ'' means a named subunit of the Document whose
+title either is precisely XYZ or contains XYZ in parentheses following
+text that translates XYZ in another language.  (Here XYZ stands for a
+specific section name mentioned below, such as ``Acknowledgements,''
+``Dedications,'' ``Endorsements,'' or ``History.'')  To ``Preserve the Title''
+of such a section when you modify the Document means that it remains a
+section ``Entitled XYZ'' according to this definition.
+
+The Document may include Warranty Disclaimers next to the notice which
+states that this License applies to the Document.  These Warranty
+Disclaimers are considered to be included by reference in this
+License, but only as regards disclaiming warranties: any other
+implication that these Warranty Disclaimers may have is void and has
+no effect on the meaning of this License.
+@sp 1
+@item
+VERBATIM COPYING
+
+You may copy and distribute the Document in any medium, either
+commercially or noncommercially, provided that this License, the
+copyright notices, and the license notice saying this License applies
+to the Document are reproduced in all copies, and that you add no other
+conditions whatsoever to those of this License.  You may not use
+technical measures to obstruct or control the reading or further
+copying of the copies you make or distribute.  However, you may accept
+compensation in exchange for copies.  If you distribute a large enough
+number of copies you must also follow the conditions in section 3.
+
+You may also lend copies, under the same conditions stated above, and
+you may publicly display copies.
+@sp 1
+@item
+COPYING IN QUANTITY
+
+If you publish printed copies (or copies in media that commonly have
+printed covers) of the Document, numbering more than 100, and the
+Document's license notice requires Cover Texts, you must enclose the
+copies in covers that carry, clearly and legibly, all these Cover
+Texts: Front-Cover Texts on the front cover, and Back-Cover Texts on
+the back cover.  Both covers must also clearly and legibly identify
+you as the publisher of these copies.  The front cover must present
+the full title with all words of the title equally prominent and
+visible.  You may add other material on the covers in addition.
+Copying with changes limited to the covers, as long as they preserve
+the title of the Document and satisfy these conditions, can be treated
+as verbatim copying in other respects.
+
+If the required texts for either cover are too voluminous to fit
+legibly, you should put the first ones listed (as many as fit
+reasonably) on the actual cover, and continue the rest onto adjacent
+pages.
+
+If you publish or distribute Opaque copies of the Document numbering
+more than 100, you must either include a machine-readable Transparent
+copy along with each Opaque copy, or state in or with each Opaque copy
+a computer-network location from which the general network-using
+public has access to download using public-standard network protocols
+a complete Transparent copy of the Document, free of added material.
+If you use the latter option, you must take reasonably prudent steps,
+when you begin distribution of Opaque copies in quantity, to ensure
+that this Transparent copy will remain thus accessible at the stated
+location until at least one year after the last time you distribute an
+Opaque copy (directly or through your agents or retailers) of that
+edition to the public.
+
+It is requested, but not required, that you contact the authors of the
+Document well before redistributing any large number of copies, to give
+them a chance to provide you with an updated version of the Document.
+@sp 1
+@item
+MODIFICATIONS
+
+You may copy and distribute a Modified Version of the Document under
+the conditions of sections 2 and 3 above, provided that you release
+the Modified Version under precisely this License, with the Modified
+Version filling the role of the Document, thus licensing distribution
+and modification of the Modified Version to whoever possesses a copy
+of it.  In addition, you must do these things in the Modified Version:
+
+A. Use in the Title Page (and on the covers, if any) a title distinct
+   from that of the Document, and from those of previous versions
+   (which should, if there were any, be listed in the History section
+   of the Document).  You may use the same title as a previous version
+   if the original publisher of that version gives permission.@*
+B. List on the Title Page, as authors, one or more persons or entities
+   responsible for authorship of the modifications in the Modified
+   Version, together with at least five of the principal authors of the
+   Document (all of its principal authors, if it has fewer than five),
+   unless they release you from this requirement.@*
+C. State on the Title page the name of the publisher of the
+   Modified Version, as the publisher.@*
+D. Preserve all the copyright notices of the Document.@*
+E. Add an appropriate copyright notice for your modifications
+   adjacent to the other copyright notices.@*
+F. Include, immediately after the copyright notices, a license notice
+   giving the public permission to use the Modified Version under the
+   terms of this License, in the form shown in the Addendum below.@*
+G. Preserve in that license notice the full lists of Invariant Sections
+   and required Cover Texts given in the Document's license notice.@*
+H. Include an unaltered copy of this License.@*
+I. Preserve the section Entitled ``History,'' Preserve its Title, and add
+   to it an item stating at least the title, year, new authors, and
+   publisher of the Modified Version as given on the Title Page.  If
+   there is no section Entitled ``History'' in the Document, create one
+   stating the title, year, authors, and publisher of the Document as
+   given on its Title Page, then add an item describing the Modified
+   Version as stated in the previous sentence.@*
+J. Preserve the network location, if any, given in the Document for
+   public access to a Transparent copy of the Document, and likewise
+   the network locations given in the Document for previous versions
+   it was based on.  These may be placed in the ``History'' section.
+   You may omit a network location for a work that was published at
+   least four years before the Document itself, or if the original
+   publisher of the version it refers to gives permission.@*
+K. For any section Entitled ``Acknowledgements'' or ``Dedications,''
+   Preserve the Title of the section, and preserve in the section all
+   the substance and tone of each of the contributor acknowledgements
+   and/or dedications given therein.@*
+L. Preserve all the Invariant Sections of the Document,
+   unaltered in their text and in their titles.  Section numbers
+   or the equivalent are not considered part of the section titles.@*
+M. Delete any section Entitled ``Endorsements.''  Such a section
+   may not be included in the Modified Version.@*
+N. Do not retitle any existing section to be Entitled ``Endorsements''
+   or to conflict in title with any Invariant Section.@*
+O. Preserve any Warranty Disclaimers.@*
+@sp 1
+If the Modified Version includes new front-matter sections or
+appendices that qualify as Secondary Sections and contain no material
+copied from the Document, you may at your option designate some or all
+of these sections as invariant.  To do this, add their titles to the
+list of Invariant Sections in the Modified Version's license notice.
+These titles must be distinct from any other section titles.
+
+You may add a section Entitled ``Endorsements,'' provided it contains
+nothing but endorsements of your Modified Version by various
+parties--for example, statements of peer review or that the text has
+been approved by an organization as the authoritative definition of a
+standard.
+
+You may add a passage of up to five words as a Front-Cover Text, and a
+passage of up to 25 words as a Back-Cover Text, to the end of the list
+of Cover Texts in the Modified Version.  Only one passage of
+Front-Cover Text and one of Back-Cover Text may be added by (or
+through arrangements made by) any one entity.  If the Document already
+includes a cover text for the same cover, previously added by you or
+by arrangement made by the same entity you are acting on behalf of,
+you may not add another; but you may replace the old one, on explicit
+permission from the previous publisher that added the old one.
+
+The author(s) and publisher(s) of the Document do not by this License
+give permission to use their names for publicity for or to assert or
+imply endorsement of any Modified Version.
+@sp 1
+@item
+COMBINING DOCUMENTS
+
+You may combine the Document with other documents released under this
+License, under the terms defined in section 4 above for modified
+versions, provided that you include in the combination all of the
+Invariant Sections of all of the original documents, unmodified, and
+list them all as Invariant Sections of your combined work in its
+license notice, and that you preserve all their Warranty Disclaimers.
+
+The combined work need only contain one copy of this License, and
+multiple identical Invariant Sections may be replaced with a single
+copy.  If there are multiple Invariant Sections with the same name but
+different contents, make the title of each such section unique by
+adding at the end of it, in parentheses, the name of the original
+author or publisher of that section if known, or else a unique number.
+Make the same adjustment to the section titles in the list of
+Invariant Sections in the license notice of the combined work.
+
+In the combination, you must combine any sections Entitled ``History''
+in the various original documents, forming one section Entitled
+``History''; likewise combine any sections Entitled ``Acknowledgements,''
+and any sections Entitled ``Dedications.''  You must delete all sections
+Entitled ``Endorsements.''
+@sp 1
+@item
+COLLECTIONS OF DOCUMENTS
+
+You may make a collection consisting of the Document and other documents
+released under this License, and replace the individual copies of this
+License in the various documents with a single copy that is included in
+the collection, provided that you follow the rules of this License for
+verbatim copying of each of the documents in all other respects.
+
+You may extract a single document from such a collection, and distribute
+it individually under this License, provided you insert a copy of this
+License into the extracted document, and follow this License in all
+other respects regarding verbatim copying of that document.
+@sp 1
+@item
+AGGREGATION WITH INDEPENDENT WORKS
+
+A compilation of the Document or its derivatives with other separate
+and independent documents or works, in or on a volume of a storage or
+distribution medium, is called an ``aggregate'' if the copyright
+resulting from the compilation is not used to limit the legal rights
+of the compilation's users beyond what the individual works permit.
+When the Document is included in an aggregate, this License does not
+apply to the other works in the aggregate which are not themselves
+derivative works of the Document.
+
+If the Cover Text requirement of section 3 is applicable to these
+copies of the Document, then if the Document is less than one half of
+the entire aggregate, the Document's Cover Texts may be placed on
+covers that bracket the Document within the aggregate, or the
+electronic equivalent of covers if the Document is in electronic form.
+Otherwise they must appear on printed covers that bracket the whole
+aggregate.
+@sp 1
+@item
+TRANSLATION
+
+Translation is considered a kind of modification, so you may
+distribute translations of the Document under the terms of section 4.
+Replacing Invariant Sections with translations requires special
+permission from their copyright holders, but you may include
+translations of some or all Invariant Sections in addition to the
+original versions of these Invariant Sections.  You may include a
+translation of this License, and all the license notices in the
+Document, and any Warranty Disclaimers, provided that you also include
+the original English version of this License and the original versions
+of those notices and disclaimers.  In case of a disagreement between
+the translation and the original version of this License or a notice
+or disclaimer, the original version will prevail.
+
+If a section in the Document is Entitled ``Acknowledgements,''
+``Dedications,'' or ``History,'' the requirement (section 4) to Preserve
+its Title (section 1) will typically require changing the actual
+title.
+@sp 1
+@item
+TERMINATION
+
+You may not copy, modify, sublicense, or distribute the Document except
+as expressly provided for under this License.  Any other attempt to
+copy, modify, sublicense or distribute the Document is void, and will
+automatically terminate your rights under this License.  However,
+parties who have received copies, or rights, from you under this
+License will not have their licenses terminated so long as such
+parties remain in full compliance.
+@sp 1
+@item
+FUTURE REVISIONS OF THIS LICENSE
+
+The Free Software Foundation may publish new, revised versions
+of the GNU Free Documentation License from time to time.  Such new
+versions will be similar in spirit to the present version, but may
+differ in detail to address new problems or concerns.  See
+http://www.gnu.org/copyleft/.
+
+Each version of the License is given a distinguishing version number.
+If the Document specifies that a particular numbered version of this
+License ``or any later version'' applies to it, you have the option of
+following the terms and conditions either of that specified version or
+of any later version that has been published (not as a draft) by the
+Free Software Foundation.  If the Document does not specify a version
+number of this License, you may choose any version ever published (not
+as a draft) by the Free Software Foundation.
+
+@end enumerate
+
+@unnumberedsec ADDENDUM: How to use this License for your documents
+
+To use this License in a document you have written, include a copy of
+the License in the document and put the following copyright and
+license notices just after the title page:
+
+@smallexample
+@group
+Copyright (C)  @var{year}  @var{your name}.
+Permission is granted to copy, distribute and/or modify this document
+under the terms of the GNU Free Documentation License, Version 1.2
+or any later version published by the Free Software Foundation;
+with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
+A copy of the license is included in the section entitled ``GNU
+Free Documentation License.''
+@end group
+@end smallexample
+
+If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts,
+replace the ``with...Texts.'' line with this:
+
+@smallexample
+@group
+with the Invariant Sections being @var{list their titles}, with the
+Front-Cover Texts being @var{list}, and with the Back-Cover Texts being
+@var{list}.
+@end group
+@end smallexample
+
+If you have Invariant Sections without Cover Texts, or some other
+combination of the three, merge those two alternatives to suit the
+situation.
+
+If your document contains nontrivial examples of program code, we
+recommend releasing these examples in parallel under your choice of
+free software license, such as the GNU General Public License,
+to permit their use in free software.
+
+@ignore
+   arch-tag: c1679162-1d8a-4f02-bc52-2e71765f0165
+@end ignore
diff --git a/get_html_rinfo b/get_html_rinfo
index 3c48145..c431bd7 100755
--- a/get_html_rinfo
+++ b/get_html_rinfo
@@ -188,9 +188,9 @@
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
-# along with GNU Emacs; see the file COPYING.  If not, write to the
-# Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-# Boston, MA 02111-1307, USA.
+# along with this file; see the file COPYING.  If not, write to the
+# Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+# Boston, MA 02110-1301, USA.
 #============================================================================
 
 require 5.004;
@@ -204,6 +204,8 @@ GetOptions("-debug"     => \$debug,
 	   "-xclass=s"  => \$ignore_class_re)
   or usage();
 
+$emacs=1;
+
 my (%special_topics,%e,%special_sections,%sysvars,%txt_kwds,%properties,
     %executive_commands,@syntax_kwds,@rejects,@complaints,@add_keywords,
     @enter);
@@ -305,6 +307,7 @@ foreach $file (@files) {
 		    my ($link,$prop,$txt)=@_;
 		    return if $prop=~/^\s*$/;
 		    foreach $prop (split(/,\s*/,$prop)) {
+		      $prop=~s/ *$//;
 		      $properties{$prop_class}{kwds}{$prop}{link}=$link;
 		      foreach (qw(Get Set Init)) {
 			if ($txt=~ m{$_:(?:<.*?>\s*)*\s*Yes}i) {
@@ -1167,7 +1170,7 @@ sub write_rinfo_header {
   print RINFO <<EOF;
 ;;; idlw-rinfo.el --- Routine Information for IDLWAVE
 ;; Copyright (c) 1999 Carsten Dominik
-;; Copyright (c) 1999, 2000, 2001, 2002, 2003, 2004 Free Software Foundation
+;; Copyright (c) 1999,2000,2001,2002,2003,2004,2005 Free Software Foundation
 
 ;; Author: J.D. Smith <jdsmith\@as.arizona.edu>
 ;; Version: VERSIONTAG
diff --git a/idlw-complete-structtag.el b/idlw-complete-structtag.el
index 7ea022d..cb763c8 100644
--- a/idlw-complete-structtag.el
+++ b/idlw-complete-structtag.el
@@ -1,10 +1,10 @@
 ;;; idlw-complete-structtag.el --- Completion of structure tags.
-;; Copyright (c) 2001,2002 Free Software Foundation
+;; Copyright (c) 2001,2002,2003,2004,2005,2006 Free Software Foundation
 
-;; Author: Carsten Dominik <dominik@astro.uva.nl>
-;; Maintainer: J.D. Smith <jdsmith@as.arizona.edu>
+;; Author: Carsten Dominik <dominik _AT_ astro.uva.nl>
+;; Maintainer: J.D. Smith <jdtsmith _AT_ gmail.com>
 ;; Version: 1.2
-;; Date: $Date: 2005/05/06 22:53:56 $
+;; Date: $Date: 2006/08/22 05:15:50 $
 ;; Keywords: languages
 
 ;; This file is part of GNU Emacs.
@@ -21,8 +21,8 @@
 
 ;; You should have received a copy of the GNU General Public License
 ;; along with GNU Emacs; see the file COPYING.  If not, write to the
-;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-;; Boston, MA 02111-1307, USA.
+;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+;; Boston, MA 02110-1301, USA.
 
 ;;; Commentary:
 
@@ -88,6 +88,7 @@
 ;;  - You can force an update of the tag list with the usual command
 ;;    to update routine info in IDLWAVE: C-c C-i
 
+(require 'idlwave)
 
 ;; Some variables to identify the previously used structure
 (defvar idlwave-current-tags-var nil)
@@ -106,7 +107,7 @@
 (add-hook 'idlwave-update-rinfo-hook 'idlwave-structtag-reset)
 
 ;;; The main code follows below
-
+(defvar idlwave-completion-help-info)
 (defun idlwave-complete-structure-tag ()
   "Complete a structure tag.
 This works by looking in the current file for a structure assignment to a
@@ -143,7 +144,7 @@ an up-to-date completion list."
 	  (if (or (not (string= var (or idlwave-current-tags-var "@")))
 		  (not (eq (current-buffer) idlwave-current-tags-buffer))
                   (not (equal start idlwave-current-tags-completion-pos)))
-	      (idlwave-prepare-structure-tag-completion var))
+	      (idlwave-prepare-structure-tag-completion var ))
           (setq idlwave-current-tags-completion-pos start)
 	  (setq idlwave-completion-help-info 
 		(list 'idlwave-complete-structure-tag-help))
@@ -208,25 +209,29 @@ an up-to-date completion list."
    'idlwave-complete-structure-tag-get-tags-from-help
    'hide 'wait))
 
+(defvar idlwave-shell-prompt-pattern)
+(defvar idlwave-shell-command-output)
 (defun idlwave-complete-structure-tag-get-tags-from-help ()
   "Filter structure tag name output, result to `idlwave-current-struct-tags'."
     (setq idlwave-current-struct-tags
 	  (if (string-match (concat "tag_names(.*) *\n"
-				    "\\(\\(.*[\r\n]?\\)*\\)"
-				    "\\(" idlwave-shell-prompt-pattern "\\)")
+				    "\\(\\(.*[\r\n]?\\)*\\)")
 			    idlwave-shell-command-output)
 	      (split-string (match-string 1 idlwave-shell-command-output)))))
 
 
 ;; Fake help in the source buffer for structure tags.
 ;; kwd and name are global-variables here.
+(defvar name)
+(defvar kwd)
 (defvar idlwave-help-do-struct-tag)
 (defun idlwave-complete-structure-tag-help (mode word)
   (cond
    ((eq mode 'test)
     ;; fontify only in source buffers, not in the shell.
-    (not (equal idlwave-current-tags-buffer
-                (get-buffer (idlwave-shell-buffer)))))
+    (or (not (fboundp 'idlwave-shell-buffer))
+	(not (equal idlwave-current-tags-buffer
+		    (get-buffer (idlwave-shell-buffer))))))
    ((eq mode 'set)
     (setq kwd word
 	  idlwave-help-do-struct-tag idlwave-structtag-struct-location))
diff --git a/idlw-help.el b/idlw-help.el
index 709a83c..1f79151 100644
--- a/idlw-help.el
+++ b/idlw-help.el
@@ -1,10 +1,10 @@
 ;;; idlw-help.el --- HTML Help code for IDLWAVE
-;; Copyright (c) 2000 Carsten Dominik
-;; Copyright (c) 2001, 2002 J.D. Smith
-;; Copyright (c) 2003,2004 Free Software Foundation
+
+;; Copyright (c) 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007
+;;   Free Software Foundation
 ;;
 ;; Authors: J.D. Smith <jdsmith@as.arizona.edu>
-;;          Carsten Dominik <dominik@astro.uva.nl>
+;;          Carsten Dominik <dominik@science.uva.nl>
 ;; Maintainer: J.D. Smith <jdsmith@as.arizona.edu>
 ;; Version: VERSIONTAG
 
@@ -22,8 +22,8 @@
 
 ;; You should have received a copy of the GNU General Public License
 ;; along with GNU Emacs; see the file COPYING.  If not, write to the
-;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-;; Boston, MA 02111-1307, USA.
+;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+;; Boston, MA 02110-1301, USA.
 
 ;;; Commentary:
 
@@ -61,22 +61,31 @@
 (defvar idlwave-html-link-sep 
   (if idlwave-html-help-pre-v6 "#" "#wp"))
 
+(defcustom idlwave-html-system-help-location   "help/"
+  "The directory, relative to idlwave-system-directory, where the
+idl HTML help files live, for IDL 7.0 and later.  This location,
+if found, is used in preference to the old
+idlwave-html-help-location.  Note that IDL v6.3-v7.0 used
+help/online_help."
+  :group 'idlwave-online-help
+  :type 'directory)
+
 (defcustom idlwave-html-help-location 
-  (if (memq system-type '(ms-dos windows-nt))
+   (if (memq system-type '(ms-dos windows-nt))
       nil
     "/usr/local/etc/")
-  "The directory where the idl_html_help/ dir or idl.chm help file
-(Windows only) lives."
+  "The directory where the idl_html_help/ dir lives.  Obsolete for IDL
+6.2 or later (see idlwave-html-system-help-location)."
   :group 'idlwave-online-help
   :type 'directory)
 
-(defcustom idlwave-help-use-hh nil
-  "Whether to use the HTMLHelp viewer with idl.chm (Windows only)."
+(defvar idlwave-help-use-hh nil
+  "Obsolete variable.") 
+
+(defcustom idlwave-help-use-assistant t
+  "Whether to use the IDL Assistant as the help browser (<IDL v6.4)."
   :group 'idlwave-online-help
-  :type '(choice :tag "use help viewer"
-		 (const :tag "<none>" nil)
-		 (const :tag "hh" 'hh)
-		 (const :tag "keyhh" 'keyhh)))
+  :type 'boolean)
 
 (defcustom idlwave-help-browser-function browse-url-browser-function
   "Function to use to display html help.
@@ -89,6 +98,8 @@ Defaults to `browse-url-browser-function', which see."
   :group 'idlwave-online-help
   :type 'string)
 
+(defvar browse-url-generic-args)
+
 (defcustom idlwave-help-browser-generic-args 
   (if (boundp 'browse-url-generic-args)
       browse-url-generic-args "")
@@ -158,7 +169,7 @@ probably a good idea to still call this function as a fallback."
   :group 'idlwave-online-help
   :type 'symbol)
 
-(defcustom idlwave-help-fontify-source-code nil
+(defcustom idlwave-help-fontify-source-code t
   "*Non-nil means, fontify source code displayed as help like normal code."
   :group 'idlwave-online-help
   :type 'boolean)
@@ -188,7 +199,7 @@ support."
   :group 'idlwave-online-help
   :type 'string)
 
-(defface idlwave-help-link-face
+(defface idlwave-help-link
   '((((class color)) (:foreground "Blue"))
     (t (:weight bold)))
   "Face for highlighting links into IDLWAVE online help."
@@ -245,6 +256,10 @@ support."
     "--"
     ["Quit" idlwave-help-quit t]))
 
+(defvar idlwave-help-def-pos)
+(defvar idlwave-help-args)
+(defvar idlwave-help-in-header)
+
 (defun idlwave-help-mode ()
   "Major mode for displaying IDL Help.
 
@@ -285,19 +300,6 @@ Here are all keybindings.
   (set (make-local-variable 'idlwave-help-in-header) nil)
   (run-hooks 'idlwave-help-mode-hook))
 
-(defun idlwave-html-help-location ()
-  "Return the help directory where HTML files are, or nil if that is unknown."
-  (or (and (stringp idlwave-html-help-location)
-	   (> (length idlwave-html-help-location) 0)
-	   (file-directory-p idlwave-html-help-location)
-	   idlwave-html-help-location)
-      (getenv "IDLWAVE_HELP_LOCATION")
-      (and (memq system-type '(ms-dos windows-nt)) ; Base it on sysdir
-	   idlwave-help-use-hh
-	   (stringp idlwave-system-directory)
-	   (> (length idlwave-system-directory) 0)
-	   (file-directory-p idlwave-system-directory)
-	   (expand-file-name "HELP" idlwave-system-directory))))
 
 (defvar idlwave-current-obj_new-class)
 (defvar idlwave-help-diagnostics)
@@ -324,7 +326,11 @@ It collects and prints the diagnostics messages."
 				   "; "))))))
 
 (defvar idlwave-help-do-class-struct-tag nil)
+(defvar idlwave-structtag-struct-location)
 (defvar idlwave-help-do-struct-tag nil)
+(defvar idlwave-system-variables-alist)
+(defvar idlwave-executive-commands-alist)
+(defvar idlwave-system-class-info)
 (defun idlwave-do-context-help1 (&optional arg)
   "The work-horse version of `idlwave-context-help', which see."
   (save-excursion
@@ -338,8 +344,8 @@ It collects and prints the diagnostics messages."
 	   (beg (save-excursion (skip-chars-backward chars) (point)))
 	   (end (save-excursion (skip-chars-forward chars) (point)))
 	   (this-word (buffer-substring-no-properties beg end))
-	   (st-ass (assoc (downcase this-word) 
-			  idlwave-help-special-topic-words))
+	   (st-ass (assoc-ignore-case this-word
+				      idlwave-help-special-topic-words))
 	   (classtag (and (string-match "self\\." this-word)
 			  (< beg (- end 4))))
 	   (structtag (and (fboundp 'idlwave-complete-structure-tag)
@@ -347,8 +353,7 @@ It collects and prints the diagnostics messages."
 			   (< beg (- end 4))))
 	   module keyword cw mod1 mod2 mod3)
       (if (or arg 
-	      (and (not st-ass)
-		   (not classtag)
+	      (and (not classtag)
 		   (not structtag)
 		   (not (member (string-to-char this-word) '(?! ?.)))))
 	  ;; Need the module information
@@ -369,7 +374,8 @@ It collects and prints the diagnostics messages."
        (arg (setq mod1 module))
        
        ;; A special topic -- only system help
-       (st-ass (setq mod1 (list (cdr st-ass))))
+       ((and st-ass (not (memq cw '(function-keyword procedure-keyword))))
+	(setq mod1 (list (cdr st-ass))))
        
        ;; A system variable -- only system help
        ((string-match 
@@ -590,12 +596,12 @@ Needs additional info stored in global `idlwave-completion-help-info'."
 (defun idlwave-highlight-linked-completions ()
   "Highlight all completions for which help is available and attach link.
 Those words in `idlwave-completion-help-links' have links.  The
-`idlwave-help-link-face' face is used for this."
+`idlwave-help-link' face is used for this."
   (if idlwave-highlight-help-links-in-completion      
       (with-current-buffer (get-buffer "*Completions*")
 	(save-excursion
 	  (let* ((case-fold-search t)
-		 (props (list 'face 'idlwave-help-link-face))
+		 (props (list 'face 'idlwave-help-link))
 		 (info idlwave-completion-help-info) ; global passed in
 		 (what (nth 0 info))  ; what was completed, or a func
 		 (class (nth 3 info)) ; any class
@@ -612,7 +618,7 @@ Those words in `idlwave-completion-help-links' have links.  The
 		  (setq doit (funcall what 'test word))
 		;; Look for special link property passed in help-links
 		(if idlwave-completion-help-links
-		    (setq doit (assoc-ignore-case 
+		    (setq doit (assoc-ignore-case
 				word idlwave-completion-help-links))))
 	      (when doit
 		(if (consp doit)
@@ -657,7 +663,7 @@ Those words in `idlwave-completion-help-links' have links.  The
 (defvar default-toolbar-visible-p)
 
 (defun idlwave-help-display-help-window (&optional pos-or-func)
-  "Display the help window.  
+  "Display the (source-based) help window.  
 Move window start to POS-OR-FUNC, if passed as a position, or call it
 if passed as a function.  See `idlwave-help-use-dedicated-frame'."
   (let ((cw (selected-window))
@@ -681,7 +687,7 @@ if passed as a function.  See `idlwave-help-use-dedicated-frame'."
     (select-window cw)))
 
 (defun idlwave-help-select-help-frame ()
-  "Select the help frame."
+  "Select the (source-based) help frame."
   (if (and (frame-live-p idlwave-help-frame)
 	   (not (eq (selected-frame) idlwave-help-frame)))
       (progn
@@ -701,16 +707,29 @@ Either loads an HTML link, if LINK is non-nil, or gets special-help on
 the optional arguments, if any special help is defined.  If LINK is
 `t', first look up the optional arguments in the routine info list to
 see if a link is set for it.  Try extra help functions if necessary."
+
   ;; Lookup link
   (if (eq link t) 
       (let ((entry (idlwave-best-rinfo-assoc name type class 
 					     (idlwave-routines) nil t)))
-	(cond
-	 ;; Try keyword link
-	 ((and keyword 
-	       (setq link (cdr (idlwave-entry-find-keyword entry keyword)))))
-	 ;; Default, regular entry link
-	 (t (setq link (idlwave-entry-has-help entry))))))
+	(if entry
+	    (cond
+	     ;; Try keyword link
+	     ((and keyword 
+		   (setq link (cdr 
+			       (idlwave-entry-find-keyword entry keyword)))))
+	     ;; Default, regular entry link
+	     (t (setq link (idlwave-entry-has-help entry))))
+	  (if (and 
+	       class
+	       ;; Check for system class help
+	       (setq entry (assq (idlwave-sintern-class class)
+				 idlwave-system-class-info)
+		     link (nth 1 (assq 'link entry))))
+	      (message 
+	       (concat "No routine info for %s"
+		       ", falling back on class help.")
+	       (idlwave-make-full-name class name))))))
 
   (cond
    ;; An explicit link
@@ -738,51 +757,45 @@ see if a link is set for it.  Try extra help functions if necessary."
       (idlwave-help-error name type class keyword))
     (select-window cw)))
 
+
 (defun idlwave-help-html-link (link)
   "Get html help on a given LINK."
   (let ((browse-url-browser-function idlwave-help-browser-function)
-	(help-loc (idlwave-html-help-location))
 	(browse-url-generic-program idlwave-help-browser-generic-program)
 	;(browse-url-generic-args idlwave-help-browser-generic-args)
+	help-loc (idlwave-html-help-location)
 	full-link)
     
-    (unless idlwave-help-browse-url-available
-      (error "browse-url is not available -- install it to use HTML help."))
+    ;; Just a regular file name (+ anchor name)
+    (unless (or idlwave-help-use-eclipse-help
+		(and (stringp help-loc)
+		     (file-directory-p help-loc)))
+      (error "Invalid help request."))
+    
+    (if (not (or idlwave-help-use-eclipse-help
+		 idlwave-help-use-assistant))
+	(setq 
+	 full-link (browse-url-file-url (expand-file-name link help-loc))))
+
+    ;; Select the browser
+    (cond
+     (idlwave-help-use-eclipse-help
+      (idlwave-help-eclipse-help-open-link link))
+     
+     (idlwave-help-use-assistant
+      (idlwave-help-assistant-open-link link))
 
-    (if (and (memq system-type '(ms-dos windows-nt))
-	     idlwave-help-use-hh)
-	(progn
-	  (setq browse-url-browser-function 'browse-url-generic
-		full-link (concat (expand-file-name "idl.chm" help-loc)
-				  "::/"
-				  link))
-	  (if (memq 'keyhh idlwave-help-use-hh)
-	      (setq browse-url-generic-program "KEYHH"
-		    browse-url-generic-args '("-IDLWAVE"))
-	    (setq browse-url-generic-program "HH")))
-      ;; Just a regular file name (+ anchor name)
-      (unless (and (stringp help-loc)
-		   (file-directory-p help-loc))
-	(error 
-	 "Invalid help location; customize `idlwave-html-help-location'."))
-      (setq full-link (concat 
-		       "file://"
-		       (expand-file-name 
-			link 
-			(expand-file-name "idl_html_help" help-loc)))))
-
-    ;; Check for a local browser
-    (if (or idlwave-help-browser-is-local
-	    (string-match "w3" (symbol-name idlwave-help-browser-function)))
-	(idlwave-help-display-help-window '(lambda () (browse-url full-link)))
-      (browse-url full-link))))
+     ((or idlwave-help-browser-is-local
+	  (string-match "w3" (symbol-name idlwave-help-browser-function)))
+      (idlwave-help-display-help-window '(lambda () (browse-url full-link))))
+
+     (t (browse-url full-link)))))
 
 ;; A special help routine for source-level syntax help in files.
-(defvar idlwave-help-def-pos)
-(defvar idlwave-help-args)
-(defvar idlwave-help-in-header)
 (defvar idlwave-help-fontify-source-code)
 (defvar idlwave-help-source-try-header)
+(defvar idlwave-current-tags-buffer)
+(defvar idlwave-current-tags-class)
 (defun idlwave-help-with-source (name type class keyword)
   "Provide help for routines not documented in the IDL manuals.  Works
 by loading the routine source file into the help buffer.  Depending on
@@ -824,13 +837,14 @@ This function can be used as `idlwave-extra-help-function'."
 	  (if in-buf
 	      (progn
 		(setq file (buffer-file-name in-buf))
-		(erase-buffer)
-		(insert-buffer in-buf))
+		(erase-buffer)		
+		(insert-buffer-substring in-buf))
 	    (if (file-exists-p file) ;; otherwise just load the file
 		(progn
 		  (erase-buffer)
 		  (insert-file-contents file nil nil nil 'replace))
 	      (idlwave-help-error name type class keyword)))
+	  (goto-char (point-min))
 	  (if (and idlwave-help-fontify-source-code (not in-buf))
 	      (idlwave-help-fontify)))
       (idlwave-help-error name type class keyword))
@@ -1180,6 +1194,221 @@ Useful when source code is displayed as help.  See the option
   (let ((entry (idlwave-best-rinfo-assoc name type class (idlwave-routines))))
     (idlwave-entry-has-help entry)))
 
+(defvar idlwave-help-with-topic-history nil
+  "The history of help topics selected with the minibuffer.")
+
+(defun idlwave-help-with-topic (&optional topic)
+  "Prompt for and provide help with TOPIC."
+  (interactive)
+  (let (list)
+    (unless topic
+      (idlwave-routines)
+      (setq list (append (mapcar (lambda (x)
+				   (concat (nth 2 x) (car x)))
+				 idlwave-system-routines)
+			 (mapcar (lambda (x)
+				   (concat "." (car x)))
+				 idlwave-executive-commands-alist)
+			 idlwave-system-class-info))
+      (setq topic 
+	    (idlwave-completing-read 
+	     "Help Topic: " list
+	     nil nil nil
+	     'idlwave-help-with-topic-history)))
+    (if (and topic (not (string= topic "")))
+	(idlwave-help-html-link (concat topic ".html")))))
+
+
+
+(defun idlwave-html-help-location ()
+  "Return the help directory where HTML files are, or nil if that is unknown."
+  ;; Note that starting with IDL 7, the HTML files are not included directly,
+  ;; so this becomes vestigial.
+  (let ((syshelp-dir (expand-file-name 
+		      (if (file-directory-p idlwave-html-system-help-location)
+			  idlwave-html-system-help-location
+			(concat (file-name-as-directory 
+				 idlwave-html-system-help-location)
+				"online_help"))
+		      (idlwave-sys-dir)))
+	(help-dir (or (and (stringp idlwave-html-help-location)
+			   (> (length idlwave-html-help-location) 0)
+			   idlwave-html-help-location)
+		      (getenv "IDLWAVE_HELP_LOCATION"))))
+    (if (and syshelp-dir (file-directory-p syshelp-dir))
+	syshelp-dir
+      (if help-dir 
+	  (progn
+	    (setq help-dir (expand-file-name "idl_html_help" help-dir))
+	    (if (file-directory-p help-dir) help-dir))))))
+      
+(defvar idlwave-help-assistant-available nil) 
+(defvar idlwave-help-use-eclipse-help nil)
+(defun idlwave-help-check-locations ()
+  ;; Check help locations and assistant.
+  (let ((sys-dir (idlwave-sys-dir))
+	idl_uses_assistant)
+    (if (not (file-directory-p sys-dir))
+	(message "IDL system directory not found: try setting `idlwave-system-directory' or IDL_DIR.")
+      (setq idl_uses_assistant  ; "online_help/" only existed for the 
+	    (file-directory-p   ;  IDL Assistant-based versions of IDL
+	     (expand-file-name "online_help" 
+			       (concat (file-name-as-directory sys-dir) 
+				       "help"))))
+      (if idl_uses_assistant
+	  (let ((help-loc (idlwave-html-help-location)))
+	    (if (or (not help-loc)
+		    (not (file-directory-p help-loc)))
+		(message "HTML help location not found: try setting `idlwave-html-help-location'."))
+	    ;; see if we have the assistant
+	    (when (and idlwave-help-use-assistant
+		       (not (eq (idlwave-help-assistant-available) t)))
+	      (message "Cannot locate IDL Assistant, enabling default browser.")
+	      (setq idlwave-help-use-assistant nil)
+	      (unless idlwave-help-browse-url-available
+		(error "browse-url is not available; install it or IDL Assistant to use HTML help."))))
+	;; No assistant, check for and record eclipse-based help
+	;; (use new location of idl_catalog as indicator).
+	(setq idlwave-help-use-eclipse-help 
+	      (file-exists-p (expand-file-name "idl_catalog.xml" 
+					       (expand-file-name 
+						"help" sys-dir))))))))
+
+
+
+;;---- Control the idlhelp Eclipse-based help front-end, which shipped
+;;---- with IDL v7.0
+
+;; The Windows version does not have a !DIR/bin/* set of front-end
+;; scripts, but instead only links directly to bin.x86.  As a result,
+;; we must pass the -profile argument as well.
+(defvar idlwave-help-eclipse-help-command 
+  (if (memq system-type '(ms-dos windows-nt))
+      "idlde/idlhelp.exe"
+    "bin/idlhelp")
+  "The command, rooted at idlwave-system-directory, which invokes the
+the idlhelp script.")
+
+(defun idlwave-help-eclipse-help-command ()
+  (expand-file-name idlwave-help-eclipse-help-command (idlwave-sys-dir)))
+
+(defun idlwave-help-eclipse-help-open-link (&optional link)
+  "Start IDL Eclipse-Help (if needed), loading link FULL-LINK, if passed."
+  (let ((command (idlwave-help-eclipse-help-command)))
+    (if (string-match "\.html$" link) ;; Strop HTML, unless anchored
+	(setq link (substring link 0 (match-beginning 0))))
+    (apply 'call-process command nil 0 nil (if link `("-topic" ,link)))))
+  
+
+;;----- Control the IDL Assistant, which shipped with IDL v6.2
+(defvar idlwave-help-assistant-process nil)
+(defvar idlwave-help-assistant-socket nil)
+
+;; The Windows version does not have a !DIR/bin/* set of front-end
+;; scripts, but instead only links directly to bin.x86.  As a result,
+;; we must pass the -profile argument as well.
+(defvar idlwave-help-assistant-command 
+  (if (memq system-type '(ms-dos windows-nt))
+      "bin/bin.x86/idl_assistant.exe"
+    "bin/idl_assistant")
+  "The command, rooted at idlwave-system-directory, which invokes the
+IDL assistant.")
+
+(defun idlwave-help-assistant-available ()
+  (if idlwave-help-assistant-available
+      (eq idlwave-help-assistant-available t)
+    (setq idlwave-help-assistant-available
+	  (if (file-executable-p (idlwave-help-assistant-command))
+	      t
+	    'not-available))))
+
+(defun idlwave-help-assistant-command ()
+  (expand-file-name idlwave-help-assistant-command (idlwave-sys-dir)))
+
+(defun idlwave-help-assistant-start (&optional full-link)
+  "Start the IDL Assistant, loading link FULL-LINK, if passed."
+  (when (or (not idlwave-help-assistant-socket)
+	    (not (eq (process-status idlwave-help-assistant-socket) 'open)))
+    (let* ((help-loc (idlwave-html-help-location))
+	   (command (idlwave-help-assistant-command))
+	   (extra-args 
+	    (nconc
+	     (if (memq system-type '(ms-dos windows-nt))
+		 `("-profile" ,(expand-file-name "idl.adp" help-loc)))
+	     (if full-link `("-file" ,full-link))))
+	   port)
+      (if idlwave-help-assistant-socket 
+	  (delete-process idlwave-help-assistant-socket))
+	
+      (setq idlwave-help-assistant-process 
+	    (apply 'start-process 
+		   "IDL_ASSISTANT_PROC" nil command "-server" extra-args))
+      
+      (set-process-filter idlwave-help-assistant-process
+			  (lambda (proc string)
+			    (setq port (string-to-number string))))
+      (unless (accept-process-output idlwave-help-assistant-process 15)
+	(error "Failed binding IDL_ASSISTANT socket"))
+      (if (not port)
+	  (error "Unable to open IDL_ASSISTANT.")
+	(set-process-filter idlwave-help-assistant-process nil)
+	(setq idlwave-help-assistant-socket 
+	      (open-network-stream "IDL_ASSISTANT_SOCK" 
+				   nil "localhost" port))
+	(if (eq (process-status idlwave-help-assistant-socket) 'open)
+	    (progn
+	      (process-send-string  idlwave-help-assistant-socket
+				    (concat "setHelpPath " help-loc "\n"))
+	      t)
+	  (idlwave-help-assistant-close)
+	  (error "Cannot communicate with IDL_ASSISTANT"))))))
+
+(defun idlwave-help-assistant-raise ()
+  (idlwave-help-assistant-start)
+  (process-send-string idlwave-help-assistant-socket "raise\n"))
+
+(defun idlwave-help-assistant-open-link (&optional link)
+  ;; Open a link (file name with anchor, no leading path) in the assistant.
+  (let ((help-loc (idlwave-html-help-location))
+	topic anchor file just-started exists full-link)
+    
+    (if (string-match "\.html" link)
+	(setq topic (substring link 0 (match-beginning 0))
+	      anchor (substring link (match-end 0)))
+      (error "Malformed help link."))
+    
+    (setq file (expand-file-name (concat topic ".html") help-loc))
+    (if (file-exists-p file)
+	(setq exists t)
+      (setq file (expand-file-name 
+		  (concat (upcase topic) ".html") help-loc))
+      (setq exists (file-exists-p file)))
+    
+    (setq full-link    (concat file anchor)
+	  just-started (idlwave-help-assistant-start (if exists full-link)))
+    (if exists
+	(progn
+	  (if (not just-started)
+	      (process-send-string idlwave-help-assistant-socket
+				   (concat "openLink " full-link "\n")))
+	  (process-send-string idlwave-help-assistant-socket
+			       (concat "searchIndexNoOpen " topic "\n")))
+      (process-send-string idlwave-help-assistant-socket
+			   (concat "searchIndexAndOpen " topic "\n"))))
+  (idlwave-help-assistant-raise))
+
+(defun idlwave-help-assistant-close ()
+  (when (and idlwave-help-assistant-process
+	     (eq (process-status idlwave-help-assistant-process) 'run))
+    (when idlwave-help-assistant-socket
+      (process-send-string idlwave-help-assistant-socket "quit\n")
+      (delete-process idlwave-help-assistant-socket))
+    (stop-process idlwave-help-assistant-process)
+    (delete-process idlwave-help-assistant-process)
+    (setq idlwave-help-assistant-socket nil
+	  idlwave-help-assistant-process nil)))
+
+
 (provide 'idlw-help)
 (provide 'idlwave-help)
 
diff --git a/idlw-shell.el b/idlw-shell.el
index ada3338..634d486 100644
--- a/idlw-shell.el
+++ b/idlw-shell.el
@@ -1,12 +1,14 @@
 ;; idlw-shell.el --- run IDL as an inferior process of Emacs.
-;; Copyright (c) 1999,2000,2001,2002,2003,2004 Free Software Foundation
 
-;; Authors: J.D. Smith <jdsmith@as.arizona.edu>
-;;          Carsten Dominik <dominik@astro.uva.nl>
-;;          Chris Chase <chase@att.com>
-;; Maintainer: J.D. Smith <jdsmith@as.arizona.edu>
+;; Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007
+;;    Free Software Foundation, Inc.
+
+;; Authors: J.D. Smith 
+;;          Carsten Dominik 
+;;          Chris Chase 
+;; Maintainer: J.D. Smith
 ;; Version: VERSIONTAG
-;; Date: $Date: 2005/05/09 20:08:45 $
+;; Date: $Date: 2008/01/25 20:53:53 $
 ;; Keywords: processes
 
 ;; This file is part of GNU Emacs.
@@ -23,15 +25,15 @@
 
 ;; You should have received a copy of the GNU General Public License
 ;; along with GNU Emacs; see the file COPYING.  If not, write to the
-;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-;; Boston, MA 02111-1307, USA.
+;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+;; Boston, MA 02110-1301, USA.
 
 ;;; Commentary:
 ;;
 ;; This mode is for IDL version 5 or later.  It should work on
 ;; Emacs>20.3 or XEmacs>20.4.
 ;;
-;; Runs IDL as an inferior process of Emacs, much like the emacs
+;; Runs IDL as an inferior process of Emacs, much like the Emacs
 ;; `shell' or `telnet' commands.  Provides command history and
 ;; searching.  Provides debugging commands available in buffers
 ;; visiting IDL procedure files, e.g., breakpoint setting, stepping,
@@ -138,6 +140,11 @@ process output is made by surrounding this name with `*'s."
 
 ;; (defcustom idlwave-shell-automatic-start...)  See idlwave.el
 
+(defcustom idlwave-shell-use-dedicated-window nil
+  "*Non-nil means, never replace the shell frame with another buffer."
+  :group 'idlwave-shell-general-setup
+  :type 'boolean) 
+
 (defcustom idlwave-shell-use-dedicated-frame nil
   "*Non-nil means, IDLWAVE should use a special frame to display shell buffer."
   :group 'idlwave-shell-general-setup
@@ -152,6 +159,15 @@ The default makes the frame splittable, so that completion works correctly."
   :type '(repeat
 	  (cons symbol sexp)))
 
+(defcustom idlwave-shell-buffer-height-frac nil
+  "The fraction of the current frame height to allocate to a
+non-dedicated shell buffer window.  Only relevant if
+`idlwave-shell-use-dedicated-frame' is nil"
+  :group 'idlwave-shell-general-setup
+  :type '(choice
+	  (const :tag "Default" nil)
+	  (float :tag "Fraction")))
+
 (defcustom idlwave-shell-raise-frame t
   "*Non-nil means, `idlwave-shell' raises the frame showing the shell window."
   :group 'idlwave-shell-general-setup
@@ -247,7 +263,7 @@ to set this option to nil."
   :group 'idlwave-shell-general-setup
   :type 'boolean)
 
-(defcustom idlwave-shell-file-name-chars "~/A-Za-z0-9+:_.$#%={}\\-"
+(defcustom idlwave-shell-file-name-chars "~/A-Za-z0-9+:_.$#%={}\\- "
   "The characters allowed in file names, as a string.
 Used for file name completion. Must not contain `'', `,' and `\"'
 because these are used as separators by IDL."
@@ -313,8 +329,15 @@ the copious shell traffic to be displayed."
 	       (const :tag "All debug and stepping commands" 	   debug)
 	       (const :tag "Close, window, retall, etc. commands"  misc))))
 
+(defcustom idlwave-shell-max-print-length 200
+  "Maximum number of array elements to print when examining."
+  :group 'idlwave-shell-command-setup
+  :type 'integer)
+
 (defcustom idlwave-shell-examine-alist 
-  '(("Print"          	. "print,___")
+  `(("Print"          	. ,(concat "idlwave_print_safe,___," 
+				   (number-to-string 
+				    idlwave-shell-max-print-length)))
     ("Help"           	. "help,___")
     ("Structure Help"  	. "help,___,/STRUCTURE")
     ("Dimensions"     	. "print,size(___,/DIMENSIONS)")
@@ -322,6 +345,7 @@ the copious shell traffic to be displayed."
     ("N_Elements"     	. "print,n_elements(___)")
     ("All Size Info"  	. "help,(__IWsz__=size(___,/STRUCTURE)),/STRUCTURE & print,__IWsz__.DIMENSIONS")
     ("Ptr Valid"      	. "print,ptr_valid(___)")
+    ("Arg Present"      . "print,arg_present(___)")
     ("Widget Valid"     . "print,widget_info(___,/VALID)")
     ("Widget Geometry"  . "help,widget_info(___,/GEOMETRY)"))
   "Alist of special examine commands for popup selection.  
@@ -346,7 +370,8 @@ expression being examined."
 (defcustom idlwave-shell-comint-settings
   '((comint-scroll-to-bottom-on-input . t)
     (comint-scroll-to-bottom-on-output . t)
-    (comint-scroll-show-maximum-output . nil))
+    (comint-scroll-show-maximum-output . nil)
+    (comint-prompt-read-only . t))
 
   "Alist of special settings for the comint variables in the IDLWAVE Shell.
 Each entry is a cons cell with the name of a variable and a value.
@@ -436,6 +461,11 @@ popup help text on the line."
   :group 'idlwave-shell-command-setup
   :type 'boolean)
 
+(defcustom idlwave-shell-reset-no-prompt nil
+  "If non-nil, skip the yes/no prompt when resetting the IDL session."
+  :group 'idlwave-shell-command-setup
+  :type 'boolean)
+
 ;; Breakpoint Overlays etc
 (defgroup idlwave-shell-highlighting-and-faces nil
   "Highlighting and Faces used by the IDLWAVE Shell mode."
@@ -487,11 +517,11 @@ line where IDL is stopped.  See also `idlwave-shell-mark-stop-line'."
 
 (defcustom idlwave-shell-electric-stop-line-face 
   (prog1
-      (copy-face 'modeline 'idlwave-shell-electric-stop-line-face)
-    (set-face-background 'idlwave-shell-electric-stop-line-face 
+      (copy-face 'modeline 'idlwave-shell-electric-stop-line)
+    (set-face-background 'idlwave-shell-electric-stop-line 
 			 idlwave-shell-electric-stop-color)
     (condition-case nil
-	(set-face-foreground 'idlwave-shell-electric-stop-line-face nil)
+	(set-face-foreground 'idlwave-shell-electric-stop-line nil)
       (error nil)))
   "*The face for `idlwave-shell-stop-line-overlay' when in electric debug mode.
 Allows you to choose the font, color and other properties for the line
@@ -517,40 +547,40 @@ t          Glyph when possible, otherwise face (same effect as 'glyph)."
 (defvar idlwave-shell-use-breakpoint-glyph t
   "Obsolete variable.  See `idlwave-shell-mark-breakpoints.")
 
-(defcustom idlwave-shell-breakpoint-face 'idlwave-shell-bp-face
+(defcustom idlwave-shell-breakpoint-face 'idlwave-shell-bp
   "*The face for breakpoint lines in the source code.
 Allows you to choose the font, color and other properties for
 lines which have a breakpoint.  See also `idlwave-shell-mark-breakpoints'."
   :group 'idlwave-shell-highlighting-and-faces
   :type 'symbol)
 
-(if idlwave-shell-have-new-custom
-    ;; We have the new customize - use it to define a customizable face
-    (defface idlwave-shell-bp-face
-      '((((class color)) (:foreground "Black" :background "Pink"))
-	(t (:underline t)))
-      "Face for highlighting lines with breakpoints."
-      :group 'idlwave-shell-highlighting-and-faces)
-  ;; Just copy the underline face to be on the safe side.
-  (copy-face 'underline 'idlwave-shell-bp-face))
+(if (not idlwave-shell-have-new-custom)
+    ;; Just copy the underline face to be on the safe side.
+    (copy-face 'underline 'idlwave-shell-bp)
+  ;; We have the new customize - use it to define a customizable face
+  (defface idlwave-shell-bp
+    '((((class color)) (:foreground "Black" :background "Pink"))
+      (t (:underline t)))
+    "Face for highlighting lines with breakpoints."
+    :group 'idlwave-shell-highlighting-and-faces))
 
 (defcustom idlwave-shell-disabled-breakpoint-face 
-  'idlwave-shell-disabled-bp-face
+  'idlwave-shell-disabled-bp
   "*The face for disabled breakpoint lines in the source code.
 Allows you to choose the font, color and other properties for
 lines which have a breakpoint.  See also `idlwave-shell-mark-breakpoints'."
   :group 'idlwave-shell-highlighting-and-faces
   :type 'symbol)
 
-(if idlwave-shell-have-new-custom
-    ;; We have the new customize - use it to define a customizable face
-    (defface idlwave-shell-disabled-bp-face
-      '((((class color)) (:foreground "Black" :background "gray"))
-	(t (:underline t)))
-      "Face for highlighting lines with breakpoints."
-      :group 'idlwave-shell-highlighting-and-faces)
-  ;; Just copy the underline face to be on the safe side.
-  (copy-face 'underline 'idlwave-shell-disabled-bp-face))
+(if (not idlwave-shell-have-new-custom)
+    ;; Just copy the underline face to be on the safe side.
+    (copy-face 'underline 'idlwave-shell-disabled-bp)
+  ;; We have the new customize - use it to define a customizable face
+  (defface idlwave-shell-disabled-bp
+    '((((class color)) (:foreground "Black" :background "gray"))
+      (t (:underline t)))
+    "Face for highlighting lines with breakpoints."
+    :group 'idlwave-shell-highlighting-and-faces))
 
 
 (defcustom idlwave-shell-expression-face 'secondary-selection
@@ -652,7 +682,7 @@ the directory stack.")
   "The overlay for where IDL is currently stopped.")
 (defvar idlwave-shell-is-stopped nil)
 (defvar idlwave-shell-expression-overlay nil
-  "The overlay for where IDL is currently stopped.")
+  "The overlay for the examined expression.")
 (defvar idlwave-shell-output-overlay nil
   "The overlay for the last IDL output.")
 
@@ -700,10 +730,21 @@ the directory stack.")
 (setq idlwave-shell-expression-overlay (make-overlay 1 1))
 (overlay-put idlwave-shell-expression-overlay
 	     'face idlwave-shell-expression-face)
+(overlay-put idlwave-shell-expression-overlay
+	     'priority 1)
 (setq idlwave-shell-output-overlay (make-overlay 1 1))
 (overlay-put idlwave-shell-output-overlay
 	     'face idlwave-shell-output-face)
 
+(copy-face idlwave-shell-stop-line-face 
+	   'idlwave-shell-pending-stop)
+(copy-face idlwave-shell-electric-stop-line-face 
+	   'idlwave-shell-pending-electric-stop)
+(set-face-background 'idlwave-shell-pending-stop "gray70")
+(set-face-background 'idlwave-shell-pending-electric-stop "gray70")
+
+
+
 (defvar idlwave-shell-bp-query "help,/breakpoints"
   "Command to obtain list of breakpoints")
 
@@ -823,6 +864,7 @@ IDL has currently stepped.")
   ?          Help on expression near point or in region ([C-u ?]).
   x          Examine expression near point or in region ([C-u x]) with 
              letter completion of the examine type.
+  e          Prompt for an expression to print.
 
  Miscellaneous:
   q   	     Quit - end debugging session and return to the Shell's main level.
@@ -842,6 +884,7 @@ IDL has currently stepped.")
 (defvar idlwave-shell-error-buffer)
 (defvar idlwave-shell-error-last)
 (defvar idlwave-shell-bp-buffer)
+(defvar idlwave-shell-command-buffer)
 (defvar idlwave-shell-sources-query)
 (defvar idlwave-shell-mode-map)
 (defvar idlwave-shell-calling-stack-index)
@@ -949,6 +992,8 @@ IDL has currently stepped.")
   (set (make-local-variable 'completion-ignore-case) t)
   (setq comint-completion-addsuffix '("/" . ""))
   (setq comint-input-ignoredups t)
+  (setq comint-input-sender (function idlwave-shell-sender))
+  
   (setq major-mode 'idlwave-shell-mode)
   (setq mode-name "IDL-Shell")
   (setq idlwave-shell-mode-line-info nil)
@@ -994,7 +1039,8 @@ IDL has currently stepped.")
   (setq idlwave-shell-ready nil)
   (setq idlwave-shell-bp-alist nil)
   (idlwave-shell-update-bp-overlays) ; Throw away old overlays
-  (setq idlwave-shell-sources-alist nil)
+  (setq idlwave-shell-post-command-hook nil ;clean up any old stuff
+	idlwave-shell-sources-alist nil)
   (setq idlwave-shell-default-directory default-directory)
   (setq idlwave-shell-hide-output nil)
 
@@ -1030,12 +1076,6 @@ IDL has currently stepped.")
 		'append 'local)
     (add-hook 'comint-output-filter-functions 'comint-strip-ctrl-m nil 'local))
 
-  ;; Python-mode, bundled with many Emacs installs, quite cavalierly
-  ;; adds this function to the global default hook.  It interferes
-  ;; with overlay-arrows.
-  (remove-hook 'comint-output-filter-functions 'py-pdbtrack-track-stack-file)
-
-
   ;; IDLWAVE syntax, and turn on abbreviations
   (setq local-abbrev-table idlwave-mode-abbrev-table)
   (set-syntax-table idlwave-mode-syntax-table)
@@ -1065,23 +1105,25 @@ IDL has currently stepped.")
   (idlwave-shell-send-command 
    (format "defsysv,'!idlwave_version','%s',1" idlwave-mode-version)
    nil 'hide)
-  ;; Get the paths if they weren't read in from file
-  (if (and (not idlwave-path-alist)
-	   (or (not (stringp idlwave-system-directory))
-	       (eq (length idlwave-system-directory) 0)))
-      (idlwave-shell-send-command idlwave-shell-path-query
-				  'idlwave-shell-get-path-info
-				  'hide)))
+  ;; Read the paths, and save if they changed
+  (idlwave-shell-send-command idlwave-shell-path-query
+			      'idlwave-shell-get-path-info
+			      'hide))
 
+(defvar idlwave-system-directory)
 (defun idlwave-shell-get-path-info (&optional no-write)
   "Get the path lists, writing to file unless NO-WRITE is set."
   (let* ((rpl (idlwave-shell-path-filter))
 	 (sysdir (car rpl))
 	 (dirs (cdr rpl))
-	 (old-path-alist idlwave-path-alist))
+	 (old-path-alist idlwave-path-alist)
+	 (old-sys-dir idlwave-system-directory)
+	 path-changed sysdir-changed)
     (when sysdir
       (setq idlwave-system-directory sysdir)
-      (put 'idlwave-system-directory 'from-shell t))
+      (if (setq sysdir-changed 
+		(not (string= idlwave-system-directory old-sys-dir)))
+	  (put 'idlwave-system-directory 'from-shell t)))
     ;; Preserve any existing flags
     (setq idlwave-path-alist 
 	  (mapcar (lambda (x)
@@ -1090,11 +1132,13 @@ IDL has currently stepped.")
 			  (cons x (cdr old-entry))
 			(list x))))
 		  dirs))
-    (put 'idlwave-path-alist 'from-shell t)
+    (if (setq path-changed (not (equal idlwave-path-alist old-path-alist)))
+	(put 'idlwave-path-alist 'from-shell t))
     (if idlwave-path-alist 
-	(if (and idlwave-auto-write-paths
-		 (not idlwave-library-path)
-		 (not no-write) )
+	(if (and (not no-write)
+		 idlwave-auto-write-paths
+		 (or sysdir-changed path-changed)
+		 (not idlwave-library-path))
 	    (idlwave-write-paths))
       ;; Fall back
       (setq idlwave-path-alist old-path-alist))))
@@ -1199,16 +1243,19 @@ See also the variable `idlwave-shell-prompt-pattern'.
 	(set-buffer buf)
 	(idlwave-shell-mode)))
     (let ((window (idlwave-display-buffer (idlwave-shell-buffer) nil
-					  (idlwave-shell-shell-frame)))
+					  (idlwave-shell-shell-frame)
+					  idlwave-shell-buffer-height-frac))
 	  (current-window (selected-window)))
       (select-window window)
       (goto-char (point-max))
+      (if idlwave-shell-use-dedicated-window
+	  (set-window-dedicated-p window t))
       (select-window current-window)
       (if idlwave-shell-ready
 	  (raise-frame (window-frame window)))
       (if (eq (selected-frame) (window-frame window))
 	  (select-window window))))
-  ;; Save the paths at the end
+  ;; Save the paths at the end, if they are from the Shell and new.
   (add-hook 'idlwave-shell-sentinel-hook 
 	    (lambda ()
 	      (if (and 
@@ -1265,7 +1312,7 @@ output to complete and the next prompt to arrive before returning
 \(useful if you need an answer now\). IDL is considered ready if the
 prompt is present and if `idlwave-shell-ready' is non-nil.  
 
-If SHOW-IF-ERROR is non-nil, show the output it it contains an error
+If SHOW-IF-ERROR is non-nil, show the output if it contains an error
 message, independent of what HIDE is set to."
 
 ;  (setq hide nil)  ;  FIXME: turn this on for debugging only
@@ -1424,21 +1471,21 @@ when the IDL prompt gets displayed again after the current IDL command."
 	   (and (eq idlwave-shell-char-mode-active 'exit)
 		(throw 'exit "Single char loop exited"))))))))
 
-(defun idlwave-shell-move-or-history (up &optional arg)
+(defun idlwave-shell-move-or-history (up &optional arg noblock-move)
   "When in last line of process buffer, do `comint-previous-input'.
-Otherwise just move the line.  Move down unless UP is non-nil."
+Otherwise just move the line.  Move down unless UP is non-nil.
+Move normally inside of blocks, unless NOBLOCK-MOVE is non-nil."
   (let* ((proc-pos (marker-position
 		    (process-mark (get-buffer-process (current-buffer)))))
 	 (arg (or arg 1))
 	 (arg (if up arg (- arg))))
     (if (eq t idlwave-shell-arrows-do-history) (goto-char proc-pos))
     (if (and idlwave-shell-arrows-do-history
-	     (>= (1+ (save-excursion (end-of-line) (point))) proc-pos))
-	(progn
-	  ;;(goto-char proc-pos)
-	  (goto-char (point-max))
-	  ;;(and (not (eolp)) (kill-line nil))
-	  (comint-previous-input arg))
+	     (or noblock-move
+		 (if up
+		     (= (line-number-at-pos) (line-number-at-pos proc-pos))
+		   (= (line-number-at-pos) (line-number-at-pos (point-max))))))
+	(comint-previous-input arg)
       (previous-line arg))))
 
 (defun idlwave-shell-up-or-history (&optional arg)
@@ -1453,6 +1500,15 @@ Otherwise just move the line.  Move down unless UP is non-nil."
   (interactive "p")
   (idlwave-shell-move-or-history nil arg))
 
+(defun idlwave-shell-noblock-up-or-history (&optional arg)
+  (interactive "p")
+  (idlwave-shell-move-or-history t arg 'noblock))
+
+(defun idlwave-shell-noblock-down-or-history (&optional arg)
+  (interactive "p")
+  (idlwave-shell-move-or-history nil arg 'noblock))
+
+
 ;; Newer versions of comint.el changed the name of comint-filter to
 ;; comint-output-filter.
 (defun idlwave-shell-comint-filter (process string) nil)
@@ -1464,6 +1520,33 @@ Otherwise just move the line.  Move down unless UP is non-nil."
   "Return t if the shell process is running."
   (eq (process-status idlwave-shell-process-name) 'run))
 
+(defun idlwave-shell-accumulate ()
+  "Split line for accumulation, adding &"
+  (interactive)
+  (end-of-line)
+  (insert " &")
+  (comint-accumulate))
+
+(defun idlwave-shell-sender (proc string)
+  "Send the command, stripping newlines after non-quoted
+ampersands beforehand."
+  (if (string-match "&\\s-*\n" string)
+      (save-excursion
+	(set-buffer (get-buffer-create idlwave-shell-command-buffer))
+	(if (not (eq major-mode 'idlwave-mode)) (idlwave-mode))
+	(erase-buffer)
+	(insert string)
+	(goto-char (point-min))
+	(while (and (re-search-forward "&\\s-*\n" nil t)
+		    (progn (goto-char (match-beginning 0))
+			   (not  (or 
+				  (idlwave-in-comment)
+				  (idlwave-in-quote)))))
+	  (goto-char (match-end 0))
+	  (delete-char -1))
+	(setq string (buffer-string))))
+  (comint-simple-send proc string))
+
 (defun idlwave-shell-filter-hidden-output (output)
   "Filter hidden output, leaving the good stuff.
 
@@ -1522,10 +1605,10 @@ and then calls `idlwave-shell-send-command' for any pending commands."
 	    
 	    
 ;;; Test/Debug code
-;	      (save-excursion (set-buffer
-;			       (get-buffer-create "*idlwave-shell-output*"))
-;			      (goto-char (point-max))
-;			      (insert "\nSTRING===>\n" string "\n<====\n"))
+;; 	      (with-current-buffer
+;; 	      	  (get-buffer-create "*idlwave-shell-output*")
+;; 	      	(goto-char (point-max))
+;; 	      	(insert "\nReceived STRING\n===>\n" string "\n<====\n"))
 	    
 	      ;; Check for prompt in current accumulating output
 	      (when (setq idlwave-shell-ready
@@ -1533,24 +1616,32 @@ and then calls `idlwave-shell-send-command' for any pending commands."
 					idlwave-shell-accumulation))
 		;; Gather the command output
 		(if idlwave-shell-hide-output
+		    ;; Hidden output
 		    (save-excursion
 		      (set-buffer idlwave-shell-hidden-output-buffer)
 		      (setq full-output (buffer-string))
 		      (goto-char (point-max))
 		      (re-search-backward idlwave-shell-prompt-pattern nil t)
-		      (goto-char (match-end 0))
+		      ;;(goto-char (match-end 0))
 		      (setq idlwave-shell-command-output
-		      (buffer-substring (point-min) (point)))
+			    (buffer-substring-no-properties 
+			     (point-min) (point)))
 		      (delete-region (point-min) (point)))
+		  ;; In-shell output
 		  (setq idlwave-shell-command-output
 			(with-current-buffer (process-buffer proc)
-			(buffer-substring
+			(buffer-substring-no-properties
 			 (save-excursion
 			   (goto-char (process-mark proc))
 			   (forward-line 0) ; Emacs 21 (beginning-of-line nil)
 			   (point))
 			 comint-last-input-end))))
 
+ ;;		(with-current-buffer
+ ;;		    (get-buffer-create "*idlwave-shell-output*")
+ ;;		  (insert "\nFull output registered:\n===>\n" 
+ ;;			  idlwave-shell-command-output "\n<====\n"))
+
 		;; Scan for state and do post commands - bracket
 		;; them with idlwave-shell-ready=nil since they may
 		;; call idlwave-shell-send-command themselves.
@@ -1574,10 +1665,10 @@ and then calls `idlwave-shell-send-command' for any pending commands."
 		  ;; Call the post-command hook
 		  (if (listp idlwave-shell-post-command-hook)
 		      (progn
-					;(message "Calling list")
-					;(prin1 idlwave-shell-post-command-hook)
+			;;(message "Calling list")
+			;;(prin1 idlwave-shell-post-command-hook)
 			(eval idlwave-shell-post-command-hook))
-					;(message "Calling command function")
+		    ;;(message "Calling command function")
 		    (funcall idlwave-shell-post-command-hook))
 
 		  ;; Reset to default state for next command.
@@ -1636,7 +1727,7 @@ The 1st pair matches the file name, the second pair matches the line
 number.")
 
 (defvar idlwave-shell-other-error
-  "^% .*\n\\s-*At:\\s-*\\(.*\\),\\s-*Line\\s-*\\(.*\\)"
+  "^% .*\\(?:\n[^%].*\\)*\n\\s-*At:\\s-*\\(.*\\),\\s-*Line\\s-*\\(.*\\)"
   "A regular expression to match any IDL error.")
 
 (defvar idlwave-shell-halting-error 
@@ -1661,8 +1752,8 @@ number.")
    "\\)"                                 ; end line number group (3)
    "[ \t\n]+"                            ; white space
    "\\("                                 ; file name group (5)
-   "[^ \t\n]+"                           ; file names can contain any non-white
-   "\\([ \t]*\n[ \t]*[^ \t\n]+\\)*"      ; continuation lines file name (6)
+   "[^\t\n]+"                            ; file names can contain any non-tab/new-line
+   "\\(\n[ \t]*[^\t\n]+\\)*"             ; continuation line(s) file name (6)
    "\\)"                                 ; end line number group (5)
    )
   "*A regular expression to parse out the file name and line number.
@@ -1672,6 +1763,8 @@ The 5th group is the file name.
 All parts may contain linebreaks surrounded by spaces.  This is important
 in IDL5 which inserts random linebreaks in long module and file names.")
 
+(defvar idlwave-shell-electric-debug-mode) ; defined by easy-mmode
+
 (defun idlwave-shell-scan-for-state ()
   "Scan for state info.  Looks for messages in output from last IDL
 command indicating where IDL has stopped. The types of messages we are
@@ -1692,9 +1785,8 @@ the above."
 		     idlwave-shell-command-output)
        (string-match idlwave-shell-other-error
 		     idlwave-shell-command-output))
-      (save-excursion
-	(set-buffer
-	 (get-buffer-create idlwave-shell-error-buffer))
+      (with-current-buffer
+	  (get-buffer-create idlwave-shell-error-buffer)
 	(erase-buffer)
 	(insert idlwave-shell-command-output)
 	(goto-char (point-min))
@@ -1727,8 +1819,10 @@ the above."
 	     (substring idlwave-shell-command-output (match-end 0))))
       (setq idlwave-shell-current-state 'halt)
       ;; Don't debug trace messages
-      (idlwave-shell-display-line (idlwave-shell-pc-frame) nil
-				  (if trace 'no-debug)))
+      (idlwave-shell-display-line 
+       (idlwave-shell-pc-frame) nil
+       (if trace 'disable
+	 (if idlwave-shell-electric-debug-mode 'force))))
      
      ;; Fourth Priority: Breakpoints 
      ((string-match idlwave-shell-break-message
@@ -1767,29 +1861,29 @@ the above."
 
 
 (defun idlwave-shell-parse-line (string &optional skip-main)
-  "Parse IDL message for the subroutine, file name and line number.
-We need to work hard here to remove the stupid line breaks inserted by
-IDL5.  These line breaks can be right in the middle of procedure
-or file names.
-It is very difficult to come up with a robust solution.  This one seems
-to be pretty good though.  
-
-Here is in what ways it improves over the previous solution:
-
-1. The procedure name can be split and will be restored.
-2. The number can be split.  I have never seen this, but who knows.
-3. We do not require the `.pro' extension for files.
-
-This function can still break when the file name ends on a end line
-and the message line contains an additional line with garbage.  Then
-the first part of that garbage will be added to the file name.
-However, the function checks the existence of the files with and
-without this last part - thus the function only breaks if file name
-plus garbage match an existing regular file.  This is hopefully very
-unlikely.
-
-If optional arg SKIP-MAIN is non-nil, don't parse $MAIN$ routine stop
-statements."
+  "Parse IDL message for the subroutine, file name and line number."
+;We need to work hard here to remove the stupid line breaks inserted by
+;IDL5.  These line breaks can be right in the middle of procedure
+;or file names.
+;It is very difficult to come up with a robust solution.  This one seems
+;to be pretty good though.  
+;
+;Here is in what ways it improves over the previous solution:
+;
+;1. The procedure name can be split and will be restored.
+;2. The number can be split.  I have never seen this, but who knows.
+;3. We do not require the `.pro' extension for files.
+;
+;This function can still break when the file name ends on an end line
+;and the message line contains an additional line with garbage.  Then
+;the first part of that garbage will be added to the file name.
+;However, the function checks the existence of the files with and
+;without this last part - thus the function only breaks if file name
+;plus garbage match an existing regular file.  This is hopefully very
+;unlikely.
+;
+;If optional arg SKIP-MAIN is non-nil, don't parse $MAIN$ routine stop
+;statements.
 
   (let (number procedure file)
     (when (and (not (if skip-main (string-match ":\\s-*\\$MAIN" string)))
@@ -1817,29 +1911,44 @@ statements."
     (setq string (replace-match "" t t string)))
   string)
 
+(defun idlwave-shell-check-file-spaces (file-pieces)
+  "Recursively check through file pieces combining with and without a space.
+IDL can swallow a space when splitting a file name on
+halt/breakpoint/etc.  We check all combinations for a valid file.
+This has some small chance of selecting the incorrect file, but
+there's no way around it.  FILE-PIECES is a list of file
+portions."
+  (idlwave-shell-check-file-spaces-recurs (cdr file-pieces) (car file-pieces)))
+		     
+(defun idlwave-shell-check-file-spaces-recurs (file-pieces file)
+  "Helper recursive function for check-file-spaces."
+  (if (null file-pieces) ; we've reached a leaf
+      (if (file-regular-p file) file) ; if it's a file, return it
+    (let ((list '(nil t)) newfile); not a leaf, recurs over both options
+      (while (and
+	      (not (setq newfile
+			 (idlwave-shell-check-file-spaces-recurs 
+			  (cdr file-pieces)
+			  (concat file (if (car list) " ") (car file-pieces)))))
+	      (setq list (cdr list))))
+      newfile)))
+
 (defun idlwave-shell-repair-file-name (file)
   "Repair a file name string by taking out all linebreaks.
-The last line of STRING may be garbage - we check which one makes a valid
-file name."
-  (let ((file1 "") (file2 "") (start 0))
+IDL can convert a single space to a newline, so we must check all options."
+  (let ((start 0) file-pieces)
     ;; We scan no further than to the next "^%" line
-    (if (string-match "^%" file) 
+    (if (string-match "\n%" file) 
 	(setq file (substring file 0 (match-beginning 0))))
-    ;; Take out the line breaks
-    (while (string-match "[ \t]*\n[ \t]*" file start)
-      (setq file1 (concat file1 (substring file start (match-beginning 0)))
-	    start (match-end 0)))
-    (setq file2 (concat file1 (substring file start)))
-    (cond
-     ((file-regular-p file2) file2)
-     ((file-regular-p file1) file1)
-     ;; If we cannot veryfy the existence of the file, we return the shorter
-     ;; name.  The idea behind this is that this may be a relative file name
-     ;; and our idea about the current working directory may be wrong.
-     ;; If it is a relative file name, it hopefully is short.
-     ((not (string= "" file1)) file1)
-     ((not (string= "" file2)) file2)
-     (t nil))))
+    ;; Take out the line breaks (newline followed by two spaces)
+    (while (string-match "[\t]*\n  " file start)
+      (push (substring file start (match-beginning 0)) file-pieces)
+      (setq start (match-end 0)))
+    (if file-pieces
+	(progn
+	  (push (substring file start) file-pieces)
+	  (idlwave-shell-check-file-spaces (nreverse file-pieces)))
+      file)))
 
 (defun idlwave-shell-cleanup ()
   "Do necessary cleanup for a terminated IDL process."
@@ -1855,6 +1964,7 @@ file name."
   (idlwave-shell-update-bp-overlays) ; kill old overlays
   (idlwave-shell-kill-buffer idlwave-shell-hidden-output-buffer)
   (idlwave-shell-kill-buffer idlwave-shell-bp-buffer)
+  (idlwave-shell-kill-buffer idlwave-shell-command-buffer)
   (idlwave-shell-kill-buffer idlwave-shell-error-buffer)
   ;; (idlwave-shell-kill-buffer (idlwave-shell-buffer))
   (and (get-buffer (idlwave-shell-buffer))
@@ -1930,14 +2040,17 @@ CLOSE, /ALL
 HEAP_GC, /VERBOSE"
   ;; OBJ_DESTROY, OBJ_VALID()  FIXME: should this be added?
   (interactive "P")
-  (message "Resetting IDL")
-  (setq idlwave-shell-calling-stack-index 0)
-  (idlwave-shell-send-command "retall" nil hidden)
-  (idlwave-shell-send-command "widget_control,/reset" nil hidden)
-  (idlwave-shell-send-command "close,/all" nil hidden)
-  ;; (idlwave-shell-send-command "obj_destroy, obj_valid()" nil hidden)
-  (idlwave-shell-send-command "heap_gc,/verbose" nil hidden)
-  (idlwave-shell-display-line nil))
+  (when (or idlwave-shell-reset-no-prompt 
+	    (yes-or-no-p "Really Reset IDL and discard current session? "))
+    (message "Resetting IDL")
+    (setq idlwave-shell-calling-stack-index 0)
+    ;; Give widget exit handlers a chance
+    (idlwave-shell-send-command "retall" nil hidden)
+    (idlwave-shell-send-command "widget_control,/reset" nil hidden)
+    (idlwave-shell-send-command "close,/all" nil hidden)
+    ;; (idlwave-shell-send-command "obj_destroy, obj_valid()" nil hidden)
+    (idlwave-shell-send-command "heap_gc,/verbose" nil hidden)
+    (idlwave-shell-display-line nil)))
 
 (defun idlwave-shell-path-filter ()
   ;; Convert the output of the path query into a list of directories
@@ -1982,9 +2095,6 @@ HEAP_GC, /VERBOSE"
 	  (message 
 	   "Routine Info warning: No match for END line in \n>>>\n%s\n<<<\n" 
 	   idlwave-shell-command-output)))
-    (if (string-match "\\S-" text)
-	;; Obviously, the pro worked.  Make a note that we have it now.
-	(setq idlwave-idlwave_routine_info-compiled t))
     ;; Match the output lines
     (while (string-match "^IDLWAVE-\\(PRO\\|FUN\\): \\(.*\\)" text start)
       (setq start (match-end 0))
@@ -2065,7 +2175,7 @@ HEAP_GC, /VERBOSE"
 Change the default directory for the process buffer to concur."
   (save-excursion
     (set-buffer (idlwave-shell-buffer))
-    (if (string-match ",___cur[\n\r]\\(\\S-*\\) *[\n\r]"
+    (if (string-match ",___cur[\n\r ]+\\([^\n\r]+\\)[\n\r]"
 		      idlwave-shell-command-output)
 	(let ((dir (substring idlwave-shell-command-output 
 			      (match-beginning 1) (match-end 1))))
@@ -2100,7 +2210,7 @@ Change the default directory for the process buffer to concur."
       ;; If we don't know anything about the class, update shell routines
       (if (and idlwave-shell-get-object-class
 	       (not (assoc-ignore-case idlwave-shell-get-object-class
-				       (idlwave-class-alist))))
+				  (idlwave-class-alist))))
 	  (idlwave-shell-maybe-update-routine-info))
       idlwave-shell-get-object-class)))
 
@@ -2108,7 +2218,7 @@ Change the default directory for the process buffer to concur."
   "Parse the output of the obj_class command."
   (let ((match "obj_class([^\n\r]+[\n\r ]"))
     (if (string-match (concat match "\\([A-Za-z_0-9]+\\) *[\n\r]\\(" 
-			      idlwave-shell-prompt-pattern "\\)")
+			      idlwave-shell-prompt-pattern "\\|$\\)")
 		      idlwave-shell-command-output)
 	(setq idlwave-shell-get-object-class 
 	      (match-string 1 idlwave-shell-command-output)))))
@@ -2212,7 +2322,6 @@ args of an executive .run, .rnew or .compile."
     (looking-at "\\$")))
 
 ;; Debugging Commands ------------------------------------------------------
-(defvar idlwave-shell-electric-debug-mode) ; defined by easy-mmode
 
 (defun idlwave-shell-redisplay (&optional hide)
   "Tries to resync the display with where execution has stopped.
@@ -2263,14 +2372,14 @@ overlays."
     (setq idlwave-shell-calling-stack-routine 
 	  (nth 2 (nth idlwave-shell-calling-stack-index stack)))
 
-    ;; only edebug if in that mode already
+    ;; force edebug for this frame if we're in that mode already
     (idlwave-shell-display-line 
      (nth idlwave-shell-calling-stack-index stack) nil
-     (unless idlwave-shell-electric-debug-mode 'no-debug)) 
-    (message (or message 
-		 (format "In routine %s (stack level %d)"
-			 idlwave-shell-calling-stack-routine
-			 (- idlwave-shell-calling-stack-index))))))
+     (if idlwave-shell-electric-debug-mode 'force))
+    (message "%s" (or message 
+		      (format "In routine %s (stack level %d)"
+			      idlwave-shell-calling-stack-routine
+			      (- idlwave-shell-calling-stack-index))))))
 
 (defun idlwave-shell-stack-up ()
   "Display the source code one step up the calling stack."
@@ -2306,30 +2415,38 @@ used.  Does nothing if the resulting frame is nil."
   "Check that frame is for an existing file."
   (file-readable-p (car frame)))
 
-(defvar idlwave-shell-suppress-electric-debug nil)
-(defun idlwave-shell-display-line (frame &optional col no-debug)
-  "Display FRAME file in other window with overlay arrow.
+(defun idlwave-shell-stop-line-pending ()
+  ;; Temporarily change the color of the stop line overlay
+  (if idlwave-shell-stop-line-overlay
+      (overlay-put idlwave-shell-stop-line-overlay 'face
+		   (if idlwave-shell-electric-debug-mode
+		       'idlwave-shell-pending-electric-stop
+		     'idlwave-shell-pending-stop))))
 
-FRAME is a list of file name, line number, and subroutine name.  If
-FRAME is nil then remove overlay.  If COL is set, move point to that
-column in the line.  If NO-DEBUG is non-nil, do *not* toggle the electric
-debug mode."
+(defvar idlwave-shell-suppress-electric-debug nil)
+(defun idlwave-shell-display-line (frame &optional col debug)
+  "display frame file in other window with overlay arrow.
+
+frame is a list of file name, line number, and subroutine name.  if
+frame is nil then remove overlay.  if col is set, move point to that
+column in the line.  if debug is non-nil, enable the electric debug
+mode.  if it is 'disable, do not enable no matter what the setting of
+'idlwave-shell-automatic-electric-debug'.  if it is 'force, enable no
+matter what the settings of that variable."
   (if (not frame)
-      ;; Remove stop-line overlay from old position
+      ;; remove stop-line overlay from old position
       (progn 
         (setq overlay-arrow-string nil)
 	(setq idlwave-shell-mode-line-info nil)
 	(setq idlwave-shell-is-stopped nil)
         (if idlwave-shell-stop-line-overlay
             (delete-overlay idlwave-shell-stop-line-overlay))
-	;; Turn off electric debug everywhere, if it's on
-	(if (and (not no-debug)
-		 idlwave-shell-automatic-electric-debug)
-	    (idlwave-shell-electric-debug-all-off)))
+	;; turn off electric debug everywhere, if it's on
+	(idlwave-shell-electric-debug-all-off))
     (if (not (idlwave-shell-valid-frame frame))
-	;; FIXME: errors are dangerous in shell filters.  But I think I
+	;; fixme: errors are dangerous in shell filters.  but i think i
 	;; have never encountered this one.
-        (error (concat "Invalid frame - unable to access file: " (car frame)))
+        (error (concat "invalid frame - unable to access file: " (car frame)))
 ;;;
 ;;; buffer : the buffer to display a line in.
 ;;; select-shell: current buffer is the shell.
@@ -2343,15 +2460,16 @@ debug mode."
              (select-shell (equal (buffer-name) (idlwave-shell-buffer)))
              window pos electric)
 
-	;; First make sure the shell window is visible
+	;; first make sure the shell window is visible
 	(idlwave-display-buffer (idlwave-shell-buffer)
-				nil (idlwave-shell-shell-frame))
+				nil (idlwave-shell-shell-frame)
+				idlwave-shell-buffer-height-frac)
 
-	;; Now display the buffer and remember which window it is.
+	;; now display the buffer and remember which window it is.
 	(setq window (idlwave-display-buffer buffer
 					     nil (idlwave-shell-source-frame)))
 
-	;; Enter the buffer and mark the line
+	;; enter the buffer and mark the line
         (save-excursion
           (set-buffer buffer)
           (save-restriction
@@ -2362,45 +2480,53 @@ debug mode."
 	    (setq idlwave-shell-is-stopped t)
 	    
             (if idlwave-shell-stop-line-overlay
-                ;; Move overlay
-		(move-overlay idlwave-shell-stop-line-overlay
-			      (point) (save-excursion (end-of-line) (point))
-			      (current-buffer))
-	      ;; Use the arrow instead, but only if marking is wanted.
+                (progn
+		  ;; restore face and move overlay 
+		  (overlay-put idlwave-shell-stop-line-overlay 'face
+			       (if idlwave-shell-electric-debug-mode
+                                   idlwave-shell-electric-stop-line-face 
+                                 idlwave-shell-stop-line-face))
+		  (move-overlay idlwave-shell-stop-line-overlay
+				(point) (save-excursion (end-of-line) (point))
+				(current-buffer)))
+	      ;; use the arrow instead, but only if marking is wanted.
 	      (if idlwave-shell-mark-stop-line
 		  (setq overlay-arrow-string idlwave-shell-overlay-arrow))
               (or overlay-arrow-position  ; create the marker if necessary
                   (setq overlay-arrow-position (make-marker)))
 	      (set-marker overlay-arrow-position (point) buffer)))
 
-	  ;; If the point is outside the restriction, widen the buffer.
+	  ;; if the point is outside the restriction, widen the buffer.
           (if (or (< pos (point-min)) (> pos (point-max)))
 	      (progn
 		(widen)
 		(goto-char pos)))
 
-	  ;; If we have the column of the error, move the cursor there.
+	  ;; if we have the column of the error, move the cursor there.
           (if col (move-to-column col))
           (setq pos (point))
 	  
-	  ;; Enter electric debug mode, if not prohibited and not in
+	  ;; enter electric debug mode, if not prohibited and not in
 	  ;; it already
-	  (when (and (or 
-		      (eq idlwave-shell-automatic-electric-debug t)
-		      (and 
-		       (eq idlwave-shell-automatic-electric-debug 'breakpoint)
-		       (not (eq idlwave-shell-current-state 'error))))
-		     (not no-debug)
-		     (not idlwave-shell-suppress-electric-debug)
-		     (not idlwave-shell-electric-debug-mode))
-	    (idlwave-shell-electric-debug-mode)
-	    (setq electric t)))
+	  (when  (and (not idlwave-shell-electric-debug-mode)
+		      (or (eq debug 'force)
+			  (and 
+			   (not (eq debug 'disable)) ;; explicitly disabled
+			   (or 
+			    (eq idlwave-shell-automatic-electric-debug t)
+			    (and 
+			     (eq idlwave-shell-automatic-electric-debug 
+				 'breakpoint)
+			     (not (eq idlwave-shell-current-state 'error))))
+			   (not idlwave-shell-suppress-electric-debug))))
+	    (idlwave-shell-electric-debug-mode t))
+	  (setq electric idlwave-shell-electric-debug-mode))
 	
 	;; Make sure pos is really displayed in the window.
 	(set-window-point window pos)
 	
 	;; If we came from the shell, go back there.  Otherwise select 
-	;; the window where the error is displayed.
+	;; the window where the error/halt is displayed.
         (if (or (and idlwave-shell-electric-zap-to-file electric)
 		(and (equal (buffer-name) (idlwave-shell-buffer)) 
 		     (not select-shell)))
@@ -2412,6 +2538,7 @@ debug mode."
   (interactive "p")
   (or (not arg) (< arg 1)
       (setq arg 1))
+  (idlwave-shell-stop-line-pending)
   (idlwave-shell-send-command 
    (concat ".s " (if (integerp arg) (int-to-string arg) arg))
    nil (if (idlwave-shell-hide-p 'debug) 'mostly) nil t))
@@ -2423,6 +2550,7 @@ Uses IDL's stepover executive command which does not enter called functions."
   (interactive "p")
   (or (not arg) (< arg 1)
       (setq arg 1))
+  (idlwave-shell-stop-line-pending)
   (idlwave-shell-send-command 
    (concat ".so " (if (integerp arg) (int-to-string arg) arg))
    nil (if (idlwave-shell-hide-p 'debug) 'mostly) nil t))
@@ -2466,13 +2594,13 @@ the problem with not being able to set the breakpoint."
               (beep)
               (y-or-n-p 
                (concat "Okay to recompile file "
-                       (idlwave-shell-bp-get bp 'file) " ")))
+                       (idlwave-shell-bp-get bp 'file) "?")))
             ;; Recompile
             (progn
               ;; Clean up before retrying
               (idlwave-shell-command-failure)
               (idlwave-shell-send-command
-               (concat ".run " (idlwave-shell-bp-get bp 'file)) nil 
+               (concat ".run \"" (idlwave-shell-bp-get bp 'file) "\"") nil 
 	       (if (idlwave-shell-hide-p 'run) 'mostly) nil t)
               ;; Try setting breakpoint again
               (idlwave-shell-set-bp bp))
@@ -2500,6 +2628,7 @@ breakpoint can not be set."
 (defun idlwave-shell-cont (&optional no-show)
   "Continue executing."
   (interactive)
+  (idlwave-shell-stop-line-pending)
   (idlwave-shell-send-command ".c" (unless no-show 
 				     '(idlwave-shell-redisplay 'hide))
 			      (if (idlwave-shell-hide-p 'debug) 'mostly) 
@@ -2508,6 +2637,7 @@ breakpoint can not be set."
 (defun idlwave-shell-go ()
   "Run .GO.  This starts the main program of the last compiled file."
   (interactive)
+  (idlwave-shell-stop-line-pending)
   (idlwave-shell-send-command ".go" '(idlwave-shell-redisplay 'hide)
 			      (if (idlwave-shell-hide-p 'debug) 'mostly)
 			      nil t))
@@ -2515,6 +2645,7 @@ breakpoint can not be set."
 (defun idlwave-shell-return ()
   "Run .RETURN (continue to next return, but stay in subprogram)."
   (interactive)
+  (idlwave-shell-stop-line-pending)
   (idlwave-shell-send-command ".return" '(idlwave-shell-redisplay 'hide)
 			      (if (idlwave-shell-hide-p 'debug) 'mostly)
 			      nil t))
@@ -2522,11 +2653,12 @@ breakpoint can not be set."
 (defun idlwave-shell-skip ()
   "Run .SKIP (skip one line, then step)."
   (interactive)
+  (idlwave-shell-stop-line-pending)  
   (idlwave-shell-send-command ".skip" '(idlwave-shell-redisplay 'hide)
 			      (if (idlwave-shell-hide-p 'debug) 'mostly)
 			      nil t))
 
-(defun idlwave-shell-clear-bp (bp)
+(defun idlwave-shell-clear-bp (bp &optional no-query)
   "Clear breakpoint BP.
 Clears in IDL and in `idlwave-shell-bp-alist'."
   (let ((index (idlwave-shell-bp-get bp)))
@@ -2535,7 +2667,7 @@ Clears in IDL and in `idlwave-shell-bp-alist'."
           (idlwave-shell-send-command
            (concat "breakpoint,/clear," (int-to-string index))
 	   nil (idlwave-shell-hide-p 'breakpoint) nil t)
-	  (idlwave-shell-bp-query)))))
+	  (unless no-query (idlwave-shell-bp-query))))))
 
 (defun idlwave-shell-current-frame ()
   "Return a list containing the current file name and line point is in.
@@ -2562,7 +2694,10 @@ Returns nil if unable to obtain a module name."
       (widen)
       (save-excursion
         (if (idlwave-prev-index-position)
-            (upcase (idlwave-unit-name)))))))
+	    (let* ((module (idlwave-what-module))
+		   (name (idlwave-make-full-name (nth 2 module) (car module)))
+		   (type (nth 1 module)))
+	      (list (upcase name) type)))))))
 
 (defun idlwave-shell-clear-current-bp ()
   "Remove breakpoint at current line.
@@ -2575,7 +2710,10 @@ at a breakpoint."
 
 (defun idlwave-shell-toggle-enable-current-bp (&optional bp force
 							 no-update)
-  "Disable or enable current bp."
+  "Disable or enable current breakpoint or a breakpoint passed in BP.
+If FORCE is 'disable or 'enable, for that condition instead of
+toggling.  If NO-UPDATE is non-nil, don't update the breakpoint
+list after toggling."
   (interactive)
   (let* ((bp (or bp (idlwave-shell-find-current-bp)))
 	 (disabled (idlwave-shell-bp-get bp 'disabled)))
@@ -2607,6 +2745,7 @@ If ENABLE is non-nil, enable them instead."
 (defun idlwave-shell-to-here ()
   "Set a breakpoint with count 1 then continue."
   (interactive)
+  ;; temporarily disable all other breakpoints
   (let ((disabled (idlwave-shell-enable-all-bp 'disable 'no-update)))
     (idlwave-shell-break-here 1 nil nil nil 'no-show)
     (idlwave-shell-cont 'no-show)
@@ -2625,22 +2764,29 @@ The command looks for an identifier near point and sets a breakpoint
 for the first line of the corresponding module.  If MODULE is `t', set
 in the current routine."
   (interactive)
-  (let ((module (idlwave-fix-module-if-obj_new (idlwave-what-module))))
+  (let* ((module (idlwave-fix-module-if-obj_new (idlwave-what-module)))
+	 (type (nth 1 module))
+	 (name (car module))
+	 (class (nth 2 module)))
     (if module
 	(progn 
-	  (setq module (idlwave-make-full-name (nth 2 module) (car module)))
-	  (idlwave-shell-module-source-query module)
-	  (idlwave-shell-set-bp-in-module module))
+	  (setq module (idlwave-make-full-name class name))
+	  (idlwave-shell-module-source-query module type)
+	  (idlwave-shell-set-bp-in-module name type class))
       (error "No identifier at point"))))
 
 
-(defun idlwave-shell-set-bp-in-module (module)
+(defun idlwave-shell-set-bp-in-module (name type class)
   "Set breakpoint in module.  Assumes that `idlwave-shell-sources-alist'
 contains an entry for that module."
-  (let ((source-file (car-safe 
-		      (cdr-safe
-		       (assoc (upcase module)
-			      idlwave-shell-sources-alist))))
+  (let* ((module (idlwave-make-full-name class name))
+	 (source-file 
+	 (car-safe (cdr-safe
+		    (or
+		      (assoc (upcase module)
+			    idlwave-shell-sources-alist)
+		     (nth 3 (idlwave-best-rinfo-assoc name type class 
+						      (idlwave-routines)))))))
 	buf)
     (if (or (not source-file)
 	    (not (file-regular-p source-file))
@@ -2728,7 +2874,7 @@ Runs to the last statement and then steps 1 statement.  Use the .out command."
 	     (funcall orig-func cur-line orig-bp-line)
 	     (or (not bp-line) (funcall closer-func cur-line bp-line)))
 	    (setq bp-line cur-line))))
-    (unless bp-line (error "No further breakpoints."))
+    (unless bp-line (error "No further breakpoints"))
     (goto-line bp-line)))
 
 ;; Examine Commands ------------------------------------------------------
@@ -2743,13 +2889,18 @@ Runs to the last statement and then steps 1 statement.  Use the .out command."
   `(lambda (event)
      "Expansion function for expression examination."
      (interactive "e")
-     (let ((transient-mark-mode t)
-	   (zmacs-regions t)
-	   (tracker (if (featurep 'xemacs) 
-			(if (fboundp 'default-mouse-track-event-is-with-button)
-			    'idlwave-xemacs-hack-mouse-track
-			  'mouse-track)
-		      'mouse-drag-region)))
+     (let* ((drag-track (fboundp 'mouse-drag-track))
+	    (transient-mark-mode t)
+	    (zmacs-regions t)
+	    (tracker (if (featurep 'xemacs) 
+			 (if (fboundp 
+			      'default-mouse-track-event-is-with-button)
+			     'idlwave-xemacs-hack-mouse-track
+			   'mouse-track)
+		       ;; Emacs 22 no longer completes the drag with
+		       ;; mouse-drag-region, without an additional
+		       ;; event.  mouse-drag-track does so.
+		       (if drag-track 'mouse-drag-track 'mouse-drag-region))))
        (funcall tracker event)
        (idlwave-shell-print (if (idlwave-region-active-p) '(4) nil)
 			    ,help ,ev))))
@@ -2760,13 +2911,15 @@ Runs to the last statement and then steps 1 statement.  Use the .out command."
   t)
 
 (defun idlwave-xemacs-hack-mouse-track (event)
-  (let ((oldfunc (symbol-function 'default-mouse-track-event-is-with-button)))
-    (unwind-protect
-	(progn
-	  (fset 'default-mouse-track-event-is-with-button 
-		'idlwave-default-mouse-track-event-is-with-button)
-	  (mouse-track event))
-      (fset 'default-mouse-track-event-is-with-button oldfunc))))
+  (if (featurep 'xemacs)
+      (let ((oldfunc (symbol-function 
+		      'default-mouse-track-event-is-with-button)))
+	(unwind-protect
+	    (progn
+	      (fset 'default-mouse-track-event-is-with-button 
+		    'idlwave-default-mouse-track-event-is-with-button)
+	      (mouse-track event))
+	  (fset 'default-mouse-track-event-is-with-button oldfunc)))))
 ;;; End terrible hack section
 
 (defun idlwave-shell-mouse-print (event)
@@ -2825,6 +2978,11 @@ idlw-shell-examine-alist from which to select the help command text.
 If instead COMPLETE-HELP-TYPE is non-nil, choose from
 idlw-shell-examine-alist via mini-buffer shortcut key."
   (interactive "P")
+
+  ;; For speed: assume the helper routine hasn't been lost, e.g. with
+  ;; .FULL_RESET_SESSION.  We'll recover if necessary
+  (unless idlwave-idlwave_routine_info-compiled
+    (idlwave-shell-compile-helper-routines))
   (save-excursion
     (let* ((process (get-buffer-process (current-buffer)))
 	   (process-mark (if process (process-mark process)))
@@ -2834,7 +2992,7 @@ idlw-shell-examine-alist via mini-buffer shortcut key."
 		(format "  [-%d:%s]" 
 			idlwave-shell-calling-stack-index 
 			idlwave-shell-calling-stack-routine)))
-	   expr beg end cmd examine-hook)
+	   expr beg end cmd)
       (cond
        ((equal arg '(16))
 	(setq expr (read-string "Expression: ")))
@@ -2877,10 +3035,6 @@ idlw-shell-examine-alist via mini-buffer shortcut key."
 		      (current-buffer))
 	(add-hook 'pre-command-hook 
 		  'idlwave-shell-delete-expression-overlay))
-      (setq examine-hook 
-	    (if idlwave-shell-separate-examine-output
-		'idlwave-shell-examine-display
-	      'idlwave-shell-examine-highlight))
       (add-hook 'pre-command-hook
 		'idlwave-shell-delete-output-overlay)
       
@@ -2942,7 +3096,7 @@ idlw-shell-examine-alist via mini-buffer shortcut key."
 	;;(idlwave-shell-recenter-shell-window)
 	(idlwave-shell-send-command 
 	 cmd 
-	 examine-hook 
+	 'idlwave-shell-check-compiled-and-display
 	 (if idlwave-shell-separate-examine-output 'hide))))))
 
 (defvar idlwave-shell-examine-window-alist nil
@@ -2952,9 +3106,18 @@ idlw-shell-examine-alist via mini-buffer shortcut key."
 (define-key idlwave-shell-examine-map "q" 'idlwave-shell-examine-display-quit)
 (define-key idlwave-shell-examine-map "c" 'idlwave-shell-examine-display-clear)
 
+
+(defun idlwave-shell-check-compiled-and-display ()
+  "Check examine output for warning about undefined procedure/function."
+  (if (string-match "% Attempt to call undefined" idlwave-shell-command-output)
+      (idlwave-shell-compile-helper-routines))
+  (if idlwave-shell-separate-examine-output
+      (idlwave-shell-examine-display)
+    (idlwave-shell-examine-highlight)))
+
 (defun idlwave-shell-examine-display ()
   "View the examine command output in a separate buffer."
-  (let (win cur-beg cur-end)
+  (let (win cur-beg cur-end beg end str)
     (save-excursion
       (set-buffer (get-buffer-create "*Examine*"))
       (use-local-map idlwave-shell-examine-map)
@@ -2965,72 +3128,75 @@ idlw-shell-examine-alist via mini-buffer shortcut key."
 	(if (string-match "^% Syntax error." idlwave-shell-command-output)
 	    (insert "% Syntax error.\n")
 	  (insert idlwave-shell-command-output)
+	  (goto-char (point-max))
+
 	  ;; Just take the last bit between the prompts (if more than one).
-	  (let* ((end (or
-		       (re-search-backward idlwave-shell-prompt-pattern nil t)
-		       (point-max)))
-		 (beg (progn 
-			(goto-char
-			 (or (progn (if (re-search-backward 
-					 idlwave-shell-prompt-pattern nil t)
-					(match-end 0)))
-			     (point-min)))
-			(re-search-forward "\n")))
-		 (str (buffer-substring beg end)))
-	    (delete-region (point-min) (point-max))
-	    (insert str)
-	    (if idlwave-shell-examine-label
-		(progn (goto-char (point-min))
-		       (insert idlwave-shell-examine-label)
-		       (setq idlwave-shell-examine-label nil)))))
+	  ;; Don't rely on a final prompt (which really shouldn't be there).
+	  (if (re-search-backward idlwave-shell-prompt-pattern nil t)
+	      (progn (setq end (line-end-position 0));end previous line
+		     (if (re-search-backward idlwave-shell-prompt-pattern nil t)
+			 (setq beg (line-beginning-position 2));begin next line
+		       (goto-char end)
+		       (setq beg (line-beginning-position 2)
+			     end (point-max))))
+	    (setq beg (point-min)
+		  end (point-max)))
+	  
+	  (setq str (buffer-substring beg end))
+	  (delete-region (point-min) (point-max))
+	  (insert str)
+	  (if idlwave-shell-examine-label
+	      (progn (goto-char (point-min))
+		     (insert idlwave-shell-examine-label)
+		     (setq idlwave-shell-examine-label nil))))
 	(setq cur-beg (point-min)
-	      cur-end (point-max))
-	(setq buffer-read-only t)
-	(move-overlay idlwave-shell-output-overlay cur-beg cur-end
-		      (current-buffer))
+	      cur-end (point-max)))
+      (setq buffer-read-only t)
+      (move-overlay idlwave-shell-output-overlay cur-beg cur-end
+		    (current-buffer))
 	
-	;; Look for the examine buffer in all windows.  If one is
-	;; found in a frame all by itself, use that, otherwise, switch
-	;; to or create an examine window in this frame, and resize if
-	;; it's a newly created window
-	(let* ((winlist (get-buffer-window-list "*Examine*" nil 'visible)))
-	  (setq win (idlwave-display-buffer 
-		     "*Examine*" 
-		     nil
-		     (let ((list winlist) thiswin)
-		       (catch 'exit
-			 (save-selected-window
-			   (while (setq thiswin (pop list))
-			     (select-window thiswin)
-			     (if (one-window-p) 
-				 (throw 'exit (window-frame thiswin)))))))))
-	  (set-window-start win (point-min)) ; Ensure the point is visible.
-	  (save-selected-window
-	    (select-window win)
-	    (let ((elt (assoc win idlwave-shell-examine-window-alist)))
-	      (when (and (not (one-window-p))
-			 (or (not (memq win winlist)) ;a newly created window
-			     (eq (window-height) (cdr elt))))
-		;; Autosize it.
-		(enlarge-window (- (/ (frame-height) 2)
-				   (window-height)))
-		(shrink-window-if-larger-than-buffer)
-		;; Clean the window list of dead windows
-		(setq idlwave-shell-examine-window-alist
-		      (delq nil
-			    (mapcar (lambda (x) (if (window-live-p (car x)) x))
-				    idlwave-shell-examine-window-alist)))
-		;; And add the new value.
-		(if (setq elt (assoc win idlwave-shell-examine-window-alist))
-		    (setcdr elt (window-height))
-		  (add-to-list 'idlwave-shell-examine-window-alist 
-			       (cons win (window-height)))))))))
-      ;; Recenter for maximum output, after widened
-      (save-selected-window
-	(select-window win)
-	(goto-char (point-max))
-	(skip-chars-backward "\n")
-	(recenter -1)))))
+      ;; Look for the examine buffer in all windows.  If one is
+      ;; found in a frame all by itself, use that, otherwise, switch
+      ;; to or create an examine window in this frame, and resize if
+      ;; it's a newly created window
+      (let* ((winlist (get-buffer-window-list "*Examine*" nil 'visible)))
+	(setq win (idlwave-display-buffer 
+		   "*Examine*" 
+		   nil
+		   (let ((list winlist) thiswin)
+		     (catch 'exit
+		       (save-selected-window
+			 (while (setq thiswin (pop list))
+			   (select-window thiswin)
+			   (if (one-window-p) 
+			       (throw 'exit (window-frame thiswin)))))))))
+	(set-window-start win (point-min)) ; Ensure the point is visible.
+	(save-selected-window
+	  (select-window win)
+	  (let ((elt (assoc win idlwave-shell-examine-window-alist)))
+	    (when (and (not (one-window-p))
+		       (or (not (memq win winlist)) ;a newly created window
+			   (eq (window-height) (cdr elt))))
+	      ;; Autosize it.
+	      (enlarge-window (- (/ (frame-height) 2)
+				 (window-height)))
+	      (shrink-window-if-larger-than-buffer)
+	      ;; Clean the window list of dead windows
+	      (setq idlwave-shell-examine-window-alist
+		    (delq nil
+			  (mapcar (lambda (x) (if (window-live-p (car x)) x))
+				  idlwave-shell-examine-window-alist)))
+	      ;; And add the new value.
+	      (if (setq elt (assoc win idlwave-shell-examine-window-alist))
+		  (setcdr elt (window-height))
+		(add-to-list 'idlwave-shell-examine-window-alist 
+			     (cons win (window-height)))))))))
+    ;; Recenter for maximum output, after widened
+    (save-selected-window
+      (select-window win)
+      (goto-char (point-max))
+      (skip-chars-backward "\n")
+      (recenter -1))))
 
 (defun idlwave-shell-examine-display-quit ()
   (interactive)
@@ -3124,13 +3290,16 @@ HELP can be non-nil for `help,', nil for 'print,' or any string into which
 to insert expression in place of the marker ___, e.g.: print,
 size(___,/DIMENSIONS)"
   (cond
-   ((null help) (concat "print, " expr))
+   ((null help)
+    (concat "idlwave_print_safe, " expr "," 
+	    (number-to-string idlwave-shell-max-print-length)))
    ((stringp help) 
     (if (string-match "\\(^\\|[^_]\\)\\(___\\)\\([^_]\\|$\\)" help)
 	(concat (substring help 0 (match-beginning 2))
 		expr
 		(substring help (match-end 2)))))
-   (t (concat "help, " expr))))
+   (t 
+    (concat "help, " expr))))
    
 
 (defun idlwave-shell-examine-highlight ()
@@ -3150,7 +3319,8 @@ size(___,/DIMENSIONS)"
 	    
     ;; First make sure the shell window is visible
     (idlwave-display-buffer (idlwave-shell-buffer)
-			    nil (idlwave-shell-shell-frame))
+			    nil (idlwave-shell-shell-frame)
+			    idlwave-shell-buffer-height-frac)
     (if (and idlwave-shell-output-overlay process-mark)
 	(move-overlay idlwave-shell-output-overlay 
 		      output-begin output-end buffer))))
@@ -3211,26 +3381,30 @@ was used.  An END statement is appended to the region if necessary.
 
 If there is a prefix argument, display IDL process."
   (interactive "r\nP")
-  (let ((oldbuf (current-buffer)))
-    (save-excursion
-      (set-buffer (idlwave-find-file-noselect
-		   (idlwave-shell-temp-file 'pro) 'tmp))
-      (set (make-local-variable 'comment-start-skip) ";+[ \t]*")
-      (set (make-local-variable 'comment-start) ";")
-      (erase-buffer)
-      (insert-buffer-substring oldbuf beg end)
-      (if (not (save-excursion
-                 (idlwave-previous-statement)
-                 (idlwave-look-at "\\<end\\>")))
-          (insert "\nend\n"))
-      (save-buffer 0)))
-  (idlwave-shell-send-command (concat ".run " idlwave-shell-temp-pro-file)
-			      nil 
-			      (if (idlwave-shell-hide-p 'run) 'mostly)
-			      nil t)
-  (if n
-      (idlwave-display-buffer (idlwave-shell-buffer) 
-			      nil (idlwave-shell-shell-frame))))
+  (when (or (not idlwave-shell-is-stopped)
+	    (y-or-n-p "Compiling will exit stack, continue? "))
+    (let ((oldbuf (current-buffer)))
+      (save-excursion
+	(set-buffer (idlwave-find-file-noselect
+		     (idlwave-shell-temp-file 'pro) 'tmp))
+	(set (make-local-variable 'comment-start-skip) ";+[ \t]*")
+	(set (make-local-variable 'comment-start) ";")
+	(erase-buffer)
+	(insert-buffer-substring oldbuf beg end)
+	(if (not (save-excursion
+		   (idlwave-previous-statement)
+		   (idlwave-look-at "\\<end\\>")))
+	    (insert "\nend\n"))
+	(save-buffer 0)))
+    (idlwave-shell-send-command (concat ".run \"" 
+					idlwave-shell-temp-pro-file "\"")
+				nil 
+				(if (idlwave-shell-hide-p 'run) 'mostly)
+				nil t)
+    (if n
+	(idlwave-display-buffer (idlwave-shell-buffer) 
+				nil (idlwave-shell-shell-frame)
+				idlwave-shell-buffer-height-frac))))
 
 (defun idlwave-shell-evaluate-region (beg end &optional n)
   "Send region to the IDL process.
@@ -3241,7 +3415,8 @@ Does not work for a region with multiline blocks - use
   (idlwave-shell-send-command (buffer-substring beg end))
   (if n
       (idlwave-display-buffer (idlwave-shell-buffer) 
-			      nil (idlwave-shell-shell-frame))))
+			      nil (idlwave-shell-shell-frame) 
+			      idlwave-shell-buffer-height-frac)))
 
 (defun idlwave-shell-delete-temp-files ()
   "Delete the temporary files and kill associated buffers."
@@ -3258,33 +3433,46 @@ Does not work for a region with multiline blocks - use
 	  (delete-file idlwave-shell-temp-rinfo-save-file)
 	(error nil))))
 
-(defun idlwave-display-buffer (buf not-this-window-p &optional frame)
-  (if (featurep 'xemacs)
-      ;; The XEmacs version enforces the frame
-      (display-buffer buf not-this-window-p frame)
-    ;; For Emacs, we need to force the frame ourselves.
-    (let ((this-frame (selected-frame)))
-      (save-excursion ;; make sure we end up in the same buffer
-	(if (frame-live-p frame)
-	    (select-frame frame))
-	(if (eq this-frame (selected-frame))
-	    ;; same frame:  use display buffer, to make sure the current
-	    ;; window stays.
-	    (display-buffer buf)
-	  ;; different frame
-	  (if (one-window-p)
-	      ;; only window:  switch
-	      (progn
-		(switch-to-buffer buf)
-		(selected-window))   ; must return the window.
-	    ;; several windows - use display-buffer
-	    (display-buffer buf not-this-window-p)))))))
+(defun idlwave-display-buffer (buf not-this-window-p &optional frame 
+				   buffer-height-frac)
+  "Display a buffer in a requested (optional) FRAME.
+Resize to no more than BUFFER-HEIGHT-FRAC of the frame buffer if set."
+  (let ((win
+	 (if (featurep 'xemacs)
+	     ;; The XEmacs version enforces the frame
+	     (display-buffer buf not-this-window-p frame)
+	   ;; For Emacs, we need to force the frame ourselves.
+	   (let ((this-frame (selected-frame)))
+	     (save-excursion ;; make sure we end up in the same buffer
+	       (if (frame-live-p frame)
+		   (select-frame frame))
+	       (if (eq this-frame (selected-frame))
+		   ;; same frame:  use display buffer, to make sure the current
+		   ;; window stays.
+		   (display-buffer buf)
+		 ;; different frame
+		 (if (one-window-p)
+		     ;; only window:  switch
+		     (progn
+		    (switch-to-buffer buf)
+		    (selected-window))   ; must return the window.
+		   ;; several windows - use display-buffer
+		   (display-buffer buf not-this-window-p))))))))
+    (if buffer-height-frac
+	(set-window-text-height win (round (* (frame-height) 
+					      buffer-height-frac))))
+    win))
+
 ;  (if (not (frame-live-p frame)) (setq frame nil))
 ;  (display-buffer buf not-this-window-p frame))
 
 (defvar idlwave-shell-bp-buffer " *idlwave-shell-bp*"
   "Scratch buffer for parsing IDL breakpoint lists and other stuff.")
 
+(defvar idlwave-shell-command-buffer " *idlwave-shell-command*"
+  "Scratch IDLWAVE mode buffer for parsing IDL statements.")
+
+
 (defun idlwave-shell-bp-query (&optional no-show)
   "Reconcile idlwave-shell's breakpoint list with IDL's.
 Queries IDL using the string in `idlwave-shell-bp-query'."
@@ -3295,12 +3483,12 @@ Queries IDL using the string in `idlwave-shell-bp-query'."
 			      'hide))
 
 (defun idlwave-shell-bp-get (bp &optional item)
-  "Get a value for a breakpoint.  
-BP has the form of elements in idlwave-shell-bp-alist.  Optional
-second arg ITEM is the particular value to retrieve.  ITEM can be
-'file, 'line, 'index, 'module, 'count, 'cmd, 'condition, 'disabled or
-'data.  'data returns a list of 'count, 'cmd and 'condition.  Defaults
-to 'index."
+  "Get a value for a breakpoint.  BP has the form of elements in
+idlwave-shell-bp-alist.  Optional second arg ITEM is the
+particular value to retrieve.  ITEM can be 'file, 'line, 'index,
+'module, 'count, 'cmd, 'condition, 'disabled, 'type, or
+'data.  'data returns a list of 'count, 'cmd and 'condition.
+Defaults to 'index."
   (cond
    ;; Frame
    ((eq item 'line) (nth 1 (car bp)))
@@ -3312,7 +3500,12 @@ to 'index."
    ((eq item 'condition) (nth 2 (cdr (cdr bp))))
    ((eq item 'disabled) (nth 3 (cdr (cdr bp))))
    ;; IDL breakpoint info
-   ((eq item 'module) (nth 1 (car (cdr bp))))
+   ((eq item 'module) 
+    (let ((module (nth 1 (car (cdr bp)))))
+      (if (listp module) (car module) module)))
+   ((eq item 'type)
+    (let ((module (nth 1 (car (cdr bp)))))
+      (if (listp module) (nth 1 module))))
    ;;    index - default
    (t (nth 0 (car (cdr bp))))))
 
@@ -3405,7 +3598,9 @@ If BP frame is in `idlwave-shell-bp-alist' updates the breakpoint data."
 and third args, DATA and MODULE, are optional.  Returns a breakpoint
 of the format used in `idlwave-shell-bp-alist'.  Can be used in commands
 attempting match a breakpoint in `idlwave-shell-bp-alist'."
-  (cons frame (cons (list nil module) data)))
+  (cons frame ;; (file line)
+	(cons (list nil module) ;; (index_id (module type) | module)
+	      data)))           ;; (count command condition disabled)
 
 (defvar idlwave-shell-old-bp nil
   "List of breakpoints previous to setting a new breakpoint.")
@@ -3441,20 +3636,24 @@ specified.  If NO-SHOW is non-nil, don't do any updating."
    'hide)
 
   ;; Get sources for this routine in the sources list
-  (idlwave-shell-module-source-query (idlwave-shell-bp-get bp 'module))
+  (idlwave-shell-module-source-query (idlwave-shell-bp-get bp 'module)
+				     (idlwave-shell-bp-get bp 'type))
   (let*
-      ((arg (idlwave-shell-bp-get bp 'count))
-       (key (cond
-              ((not (and arg (numberp arg))) "")
-              ((= arg 1)
-               ",/once")
-              ((> arg 1)
-               (format ",after=%d" arg))))
+      ((count (idlwave-shell-bp-get bp 'count))
        (condition (idlwave-shell-bp-get bp 'condition))
        (disabled (idlwave-shell-bp-get bp 'disabled))
-       (key (concat key 
-		    (if condition (concat ",CONDITION=\"" condition "\""))))
-       (key (concat key (if disabled ",/DISABLE")))
+       (key (concat (if (and count (numberp count))
+			(cond
+			 ((= count 1) ",/once")
+			 ((> count 1) (format ",after=%d" count))))
+		    (if condition (concat ",CONDITION=\"" condition "\""))
+		    ;; IDL can't simultaneously set a condition/count
+		    ;; and disable a breakpoint, but it does keep both
+		    ;; of these when resetting the same BP.  We assume
+		    ;; DISABLE and CONDITION/COUNT are not set
+		    ;; together for a newly created breakpoint.
+		    (if (and disabled (not condition) (not count))
+			    ",/DISABLE")))
        (line (idlwave-shell-bp-get bp 'line)))
     (idlwave-shell-send-command
      (concat "breakpoint,'" 
@@ -3522,7 +3721,7 @@ considered the new breakpoint if the file name of frame matches."
         ;; Got the breakpoint - add count, command to it.
         ;; This updates `idlwave-shell-bp-alist' because a deep copy was
         ;; not done for bpl.
-        (idlwave-shell-set-bp-data bpl (idlwave-shell-bp-get bp 'data))
+	(idlwave-shell-set-bp-data bpl (idlwave-shell-bp-get bp 'data))
       (beep)
       (message "Failed to identify breakpoint in IDL"))))
 
@@ -3616,17 +3815,22 @@ Existing overlays are recycled, in order to minimize consumption."
 		(setq old-buffers (delq (current-buffer) old-buffers)))
 	    (if (fboundp 'set-specifier) ;; XEmacs
 		(set-specifier left-margin-width (cons (current-buffer) 2))
-	      (setq left-margin-width 2))
-	    (if (setq win (get-buffer-window (current-buffer) t))
-		(set-window-buffer win (current-buffer))))))
+	      (if (< left-margin-width 2)
+		  (setq left-margin-width 2)))
+	    (let ((window (get-buffer-window (current-buffer) 0)))
+	      (if window
+		  (set-window-margins 
+		   window left-margin-width right-margin-width))))))
       (if use-glyph
 	  (while (setq buf (pop old-buffers))
 	    (with-current-buffer buf
 	      (if (fboundp 'set-specifier) ;; XEmacs
 		  (set-specifier left-margin-width (cons (current-buffer) 0))
 		(setq left-margin-width 0))
-	      (if (setq win (get-buffer-window buf t))
-		  (set-window-buffer win buf))))))))
+	      (let ((window (get-buffer-window buf 0)))
+		(if window
+		    (set-window-margins 
+		     window left-margin-width right-margin-width)))))))))
 
 (defun idlwave-shell-make-new-bp-overlay (&optional type disabled)
   "Make a new overlay for highlighting breakpoints.  
@@ -3702,7 +3906,7 @@ only for glyphs)."
   (interactive "e")
   (if ev (mouse-set-point ev))
   (let ((bp (idlwave-shell-find-bp (idlwave-shell-current-frame)))
-	index condition count select)
+	index condition count select cmd disabled)
     (unless bp
       (error "Breakpoint not found"))
     (setq index (int-to-string (idlwave-shell-bp-get bp))
@@ -3759,10 +3963,9 @@ Also with prefix arg, ask for the command.  You can also use the command
   (cond 
    ((equal arg '(16))
     (setq idlwave-shell-command-line-to-execute nil))
-   ((equal arg '(4))
-    (setq idlwave-shell-command-line-to-execute 
-	  (read-string "IDL> " idlwave-shell-command-line-to-execute))))
-  (idlwave-shell-reset 'hidden)
+   ((or (null idlwave-shell-command-line-to-execute) (equal arg '(4)))
+    (idlwave-shell-edit-default-command-line nil)))
+  ;;(idlwave-shell-reset 'hidden)
   (idlwave-shell-send-command 
    (or idlwave-shell-command-line-to-execute
        (with-current-buffer (idlwave-shell-buffer)
@@ -3825,8 +4028,11 @@ handled by this command."
 		       ((eq action 'compile) ".compile ")
 		       ((eq action 'batch)   "@")
 		       (t (error "Unknown action %s" action)))
-		 idlwave-shell-last-save-and-action-file)
-	 'idlwave-shell-maybe-update-routine-info
+		 "\""
+		 idlwave-shell-last-save-and-action-file
+		 "\"")
+	 `(idlwave-shell-maybe-update-routine-info nil
+	   ,idlwave-shell-last-save-and-action-file)
 	 (if (idlwave-shell-hide-p 'run) 'mostly) nil t)
 	(idlwave-shell-bp-query))
     (let ((msg (format "No such file %s" 
@@ -3834,14 +4040,14 @@ handled by this command."
       (setq idlwave-shell-last-save-and-action-file nil)
       (error msg))))
 
-(defun idlwave-shell-maybe-update-routine-info (&optional wait)
+(defun idlwave-shell-maybe-update-routine-info (&optional wait file)
   "Update the routine info if the shell is not stopped at an error."
   (if (and (not idlwave-shell-is-stopped)
 	   (or (eq t idlwave-auto-routine-info-updates)
 	       (memq 'compile-buffer idlwave-auto-routine-info-updates))
 	   idlwave-query-shell-for-routine-info
 	   idlwave-routines)
-      (idlwave-shell-update-routine-info t nil wait)))
+      (idlwave-shell-update-routine-info t nil wait file)))
 
 (defvar idlwave-shell-sources-query "help,/source,/full"
   "IDL command to obtain source files for compiled procedures.")
@@ -3852,29 +4058,31 @@ Elements of the alist have the form:
 
   (module name . (source-file-truename idlwave-internal-filename)).")
 
-(defun idlwave-shell-module-source-query (module)
-  "Determine the source file for a given module."
-  (idlwave-shell-send-command 
-   (format "print,(routine_info('%s',/SOURCE)).PATH" module)
-   `(idlwave-shell-module-source-filter ,module)
-   'hide))
+(defun idlwave-shell-module-source-query (module &optional type)
+  "Determine the source file for a given module.
+Query as a function if TYPE set to something beside 'pro."
+  (if module
+      (idlwave-shell-send-command 
+       (format "print,(routine_info('%s',/SOURCE%s)).PATH" module
+	       (if (eq type 'pro) "" ",/FUNCTIONS"))
+       `(idlwave-shell-module-source-filter ,module)
+       'hide 'wait)))
 
 (defun idlwave-shell-module-source-filter (module)
   "Get module source, and update idlwave-shell-sources-alist."
   (let ((old (assoc (upcase module) idlwave-shell-sources-alist))
 	filename)
-    (if (string-match "\.PATH *[\n\r]\\([^\r\n]+\\)[\n\r]"
+    (when (string-match "\.PATH *[\n\r]\\([^%][^\r\n]+\\)[\n\r]"
 		      idlwave-shell-command-output)
 	(setq filename (substring idlwave-shell-command-output 
-			      (match-beginning 1) (match-end 1)))
-      (error "No file matching module found."))
+				  (match-beginning 1) (match-end 1)))
     (if old
 	(setcdr old (list (idlwave-shell-file-name filename) filename))
       (setq idlwave-shell-sources-alist
 	    (append idlwave-shell-sources-alist 
 		    (list (cons (upcase module)
 				(list (idlwave-shell-file-name filename) 
-				      filename))))))))
+					filename)))))))))
   
 (defun idlwave-shell-sources-query ()
   "Determine source files for all IDL compiled procedures.
@@ -3944,7 +4152,9 @@ list elements of the form:
    idlwave-shell-bp-query
    '(progn
       (idlwave-shell-filter-bp)
-      (mapcar 'idlwave-shell-clear-bp idlwave-shell-bp-alist))
+      (mapcar (lambda (x) (idlwave-shell-clear-bp x 'no-query))
+	      idlwave-shell-bp-alist)
+      (idlwave-shell-bp-query))
    'hide))
 
 (defun idlwave-shell-list-all-bp ()
@@ -3985,7 +4195,7 @@ list elements of the form:
       (setq idlwave-shell-error-last (point)))
     (if frame
         (progn
-          (idlwave-shell-display-line frame col 'no-debug))
+          (idlwave-shell-display-line frame col 'disable))
       (beep)
       (message "No more errors."))))
 
@@ -4016,13 +4226,17 @@ Otherwise, just expand the file name."
 
 ;(define-key idlwave-shell-mode-map "\M-?" 'comint-dynamic-list-completions)
 ;(define-key idlwave-shell-mode-map "\t" 'comint-dynamic-complete)
+
+(define-key idlwave-shell-mode-map "\C-w"     'comint-kill-region)
+(define-key idlwave-shell-mode-map "\C-a"     'comint-bol-or-process-mark)
 (define-key idlwave-shell-mode-map "\t"       'idlwave-shell-complete)
 (define-key idlwave-shell-mode-map "\M-\t"    'idlwave-shell-complete)
 (define-key idlwave-shell-mode-map "\C-c\C-s" 'idlwave-shell)
 (define-key idlwave-shell-mode-map "\C-c?"    'idlwave-routine-info)
 (define-key idlwave-shell-mode-map "\C-g"     'idlwave-keyboard-quit)
 (define-key idlwave-shell-mode-map "\M-?"     'idlwave-context-help)
-(define-key idlwave-shell-mode-map [(control meta ?\?)] 'idlwave-online-help)
+(define-key idlwave-shell-mode-map [(control meta ?\?)] 
+  'idlwave-help-with-topic)
 (define-key idlwave-shell-mode-map "\C-c\C-i" 'idlwave-update-routine-info)
 (define-key idlwave-shell-mode-map "\C-c\C-y" 'idlwave-shell-char-mode-loop)
 (define-key idlwave-shell-mode-map "\C-c\C-x" 'idlwave-shell-send-char)
@@ -4033,6 +4247,17 @@ Otherwise, just expand the file name."
   'idlwave-shell-debug-map)
 (define-key idlwave-shell-mode-map [(up)]  'idlwave-shell-up-or-history)
 (define-key idlwave-shell-mode-map [(down)] 'idlwave-shell-down-or-history)
+
+(define-key idlwave-shell-mode-map [(shift up)]  
+  'idlwave-shell-noblock-up-or-history)
+(define-key idlwave-shell-mode-map [(shift down)] 
+  'idlwave-shell-noblock-down-or-history)
+
+(define-key idlwave-shell-mode-map "\C-c " 'idlwave-shell-accumulate)
+(define-key idlwave-shell-mode-map "\M-\r" 
+  (lambda () (interactive (idlwave-split-line 'noindent))))
+
+
 (define-key idlwave-mode-map "\C-c\C-y" 'idlwave-shell-char-mode-loop)
 (define-key idlwave-mode-map "\C-c\C-x" 'idlwave-shell-send-char)
 
@@ -4160,6 +4385,8 @@ Otherwise, just expand the file name."
   'idlwave-shell-stack-down)
 (define-key idlwave-shell-electric-debug-mode-map "_" 
   'idlwave-shell-stack-down)
+(define-key idlwave-shell-electric-debug-mode-map "e" 
+  '(lambda () (interactive) (idlwave-shell-print '(16))))
 (define-key idlwave-shell-electric-debug-mode-map "q" 'idlwave-shell-retall)
 (define-key idlwave-shell-electric-debug-mode-map "t" 
   '(lambda () (interactive) (idlwave-shell-send-command "help,/TRACE")))
@@ -4183,14 +4410,16 @@ Otherwise, just expand the file name."
   ;; session until we return or hit $MAIN$.  Cancel this suppression
   ;; if it's explicitly turned on.
   (if idlwave-shell-electric-debug-mode
-      (setq idlwave-shell-suppress-electric-debug t)
-    (setq idlwave-shell-suppress-electric-debug nil))
-  (idlwave-shell-electric-debug-mode))
+      (progn ;; Turn it off, and make sure it stays off.
+	(setq idlwave-shell-suppress-electric-debug t)
+	(idlwave-shell-electric-debug-mode 0))
+    (setq idlwave-shell-suppress-electric-debug nil)
+    (idlwave-shell-electric-debug-mode t)))
 
 (defvar idlwave-shell-electric-debug-read-only) 
 (defvar idlwave-shell-electric-debug-buffers nil)
 
-(easy-mmode-define-minor-mode idlwave-shell-electric-debug-mode
+(define-minor-mode idlwave-shell-electric-debug-mode
   "Toggle Electric Debug mode.
 With no argument, this command toggles the mode. 
 Non-null prefix argument turns on the mode.
@@ -4251,7 +4480,7 @@ idlwave-shell-electric-debug-mode-map)
 	  (when (and (eq major-mode 'idlwave-mode)
 		     buffer-file-name
 		     idlwave-shell-electric-debug-mode)
-	    (idlwave-shell-electric-debug-mode))))))
+	    (idlwave-shell-electric-debug-mode 0))))))
   (setq idlwave-shell-electric-debug-buffers nil))
 
 ;; Show the help text
@@ -4297,7 +4526,7 @@ idlwave-shell-electric-debug-mode-map)
      ["Edit Default Cmd" idlwave-shell-edit-default-command-line t])
     ("Breakpoints"
      ["Set Breakpoint" idlwave-shell-break-here 
-      :keys "C-c C-d C-c" :active (eq major-mode 'idlwave-mode)]
+      :keys "C-c C-d C-b" :active (eq major-mode 'idlwave-mode)]
      ("Set Special Breakpoint"
       ["Set After Count Breakpoint"
        (progn
diff --git a/idlw-toolbar.el b/idlw-toolbar.el
index 9b6f046..6de1886 100644
--- a/idlw-toolbar.el
+++ b/idlw-toolbar.el
@@ -1,10 +1,11 @@
 ;;; idlw-toolbar.el --- a debugging toolbar for IDLWAVE
-;; Copyright (c) 1999, 2000, 2001,2002,2004 Free Software Foundation
+;; Copyright (c) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006
+;; Free Software Foundation
 
 ;; Author: Carsten Dominik <dominik@astro.uva.nl>
 ;; Maintainer: J.D. Smith <jdsmith@as.arizona.edu>
 ;; Version: VERSIONTAG
-;; Date: $Date: 2005/05/06 23:08:23 $
+;; Date: $Date: 2006/08/22 05:15:26 $
 ;; Keywords: processes
 
 ;; This file is part of GNU Emacs.
@@ -21,8 +22,8 @@
 
 ;; You should have received a copy of the GNU General Public License
 ;; along with GNU Emacs; see the file COPYING.  If not, write to the
-;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-;; Boston, MA 02111-1307, USA.
+;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+;; Boston, MA 02110-1301, USA.
 
 ;;; Commentary:
 
@@ -43,7 +44,10 @@
       (toolbar-make-button-list image)
     (list 'image :type 'xpm :data image)))
 
+(defvar idlwave-toolbar)
 (defvar default-toolbar)
+(defvar idlwave-toolbar-is-possible)
+
 (if (not (or (and (featurep 'xemacs)                ; This is XEmacs
 		  (featurep 'xpm)                   ; need xpm
 		  (featurep 'toolbar))              ; ... and the toolbar
diff --git a/idlwave.el b/idlwave.el
index 851ccf0..ae4d0c0 100644
--- a/idlwave.el
+++ b/idlwave.el
@@ -1,13 +1,14 @@
 ;; idlwave.el --- IDL editing mode for GNU Emacs
-;; Copyright (c) 1999, 2000, 2001, 2002, 2003, 2004, 2005 
-;;    Free Software Foundation
+
+;; Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007
+;;   Free Software Foundation, Inc.
 
 ;; Authors: J.D. Smith <jdsmith@as.arizona.edu>
-;;          Carsten Dominik <dominik@astro.uva.nl>
+;;          Carsten Dominik <dominik@science.uva.nl>
 ;;          Chris Chase <chase@att.com>
 ;; Maintainer: J.D. Smith <jdsmith@as.arizona.edu>
 ;; Version: VERSIONTAG
-;; Date: $Date: 2005/05/06 21:49:50 $
+;; Date: $Date: 2008/01/25 20:31:10 $
 ;; Keywords: languages
 
 ;; This file is part of GNU Emacs.
@@ -24,8 +25,8 @@
 
 ;; You should have received a copy of the GNU General Public License
 ;; along with GNU Emacs; see the file COPYING.  If not, write to the
-;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
-;; Boston, MA 02111-1307, USA.
+;; Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
+;; Boston, MA 02110-1301, USA.
 
 ;;; Commentary:
 
@@ -164,6 +165,8 @@
   (defalias 'line-end-position 'point-at-eol))
 (unless (fboundp 'char-valid-p)
   (defalias 'char-valid-p 'characterp))
+(unless (fboundp 'match-string-no-properties)
+  (defalias 'match-string-no-properties 'match-string))
 
 (if (not (fboundp 'cancel-timer))
     (condition-case nil
@@ -181,7 +184,7 @@
       `(defvar ,var ,value ,doc))))
 
 (defgroup idlwave nil
-  "Major mode for editing IDL .pro files"
+  "Major mode for editing IDL .pro files."
   :tag "IDLWAVE"
   :link '(url-link :tag "Home Page" 
 		   "http://idlwave.org")
@@ -199,34 +202,34 @@
   "Indentation and formatting options for IDLWAVE mode."
   :group 'idlwave)
 
-(defcustom idlwave-main-block-indent 0
+(defcustom idlwave-main-block-indent 2
   "*Extra indentation for the main block of code.
 That is the block between the FUNCTION/PRO statement and the END
 statement for that program unit."
   :group 'idlwave-code-formatting
   :type 'integer)
 
-(defcustom idlwave-block-indent 4
+(defcustom idlwave-block-indent 3
   "*Extra indentation applied to block lines.
 If you change this, you probably also want to change `idlwave-end-offset'."
   :group 'idlwave-code-formatting
   :type 'integer)
 
-(defcustom idlwave-end-offset -4
+(defcustom idlwave-end-offset -3
   "*Extra indentation applied to block END lines.
 A value equal to negative `idlwave-block-indent' will make END lines
 line up with the block BEGIN lines."
   :group 'idlwave-code-formatting
   :type 'integer)
 
-(defcustom idlwave-continuation-indent 2
+(defcustom idlwave-continuation-indent 3
   "*Extra indentation applied to continuation lines.
 This extra offset applies to the first of a set of continuation lines.
 The following lines receive the same indentation as the first."
   :group 'idlwave-code-formatting
   :type 'integer)
 
-(defcustom idlwave-max-extra-continuation-indent 20
+(defcustom idlwave-max-extra-continuation-indent 40
   "*Maximum additional indentation for special continuation indent.
 Several special indentations are tried to help line up continuation
 lines in routine calls or definitions, other statements with
@@ -358,17 +361,20 @@ usually a good idea.."
   :type 'boolean)
 
 (defcustom idlwave-init-rinfo-when-idle-after 10
-  "*Seconds of idle time before routine info is automatically initialized.
-Initializing the routine info can take long, in particular if a large
-library catalog is involved.  When Emacs is idle for more than the number
-of seconds specified by this variable, it starts the initialization.
-The process is split into five steps, in order to keep possible work 
-interruption as short as possible.  If one of the steps finishes, and no
-user input has arrived in the mean time, initialization proceeds immediately
-to the next step.
-A good value for this variable is about 1/3 of the time initialization
-take in you setup.  So if you have a fast machine and no problems with a slow network connection, don't hesitate to set this to 2 seconds.
-A Value of 0 means, don't initialize automatically."
+  "*Seconds of idle time before routine info is automatically
+initialized.  Initializing the routine info can take a long time, in
+particular if a large number of library catalogs are involved.  When
+Emacs is idle for more than the number of seconds specified by this
+variable, it starts the initialization.  The process is split into
+five steps, in order to keep work interruption as short as possible.
+If one of the steps finishes, and no user input has arrived in the
+mean time, initialization proceeds immediately to the next step.  A
+good value for this variable is about 1/3 of the time initialization
+take in your setup.  So if you have a fast machine and no problems
+with a slow network connection, don't hesitate to set this to 2
+seconds.  A Value of 0 means, don't initialize automatically, but
+instead wait until routine information is needed, and initialize
+then."
   :group 'idlwave-routine-info
   :type 'number)
 
@@ -423,16 +429,17 @@ t means to show all source files."
   :type 'integer)
 
 (defcustom idlwave-library-path nil
-  "Library path for Windows and MacOS.  Not needed under Unix.  When
-selecting the directories to scan for IDL user catalog routine info,
-IDLWAVE can, under UNIX, query the shell for the exact search path
-\(the value of !PATH).  However, under Windows and MacOS (pre-OSX),
-the IDLWAVE shell does not work.  In this case, this variable can be
-set to specify the paths where IDLWAVE can find PRO files.  The shell
-will only be asked for a list of paths when this variable is nil.  The
-value is a list of directories.  A directory preceeded by a `+' will
-be searched recursively.  If you set this variable on a UNIX system,
-the shell will not be queried.  See also `idlwave-system-directory'."
+  "Library path for Windows and MacOS (OS9).  Not needed under UNIX.
+When selecting the directories to scan for IDL user catalog routine
+info, IDLWAVE can, under UNIX, query the shell for the exact search
+path \(the value of !PATH).  However, under Windows and MacOS
+\(pre-OSX), the IDLWAVE shell does not work.  In this case, this
+variable can be set to specify the paths where IDLWAVE can find PRO
+files.  The shell will only be asked for a list of paths when this
+variable is nil.  The value is a list of directories.  A directory
+preceeded by a `+' will be searched recursively.  If you set this
+variable on a UNIX system, the shell will not be queried.  See also
+`idlwave-system-directory'."
   :group 'idlwave-routine-info
   :type '(repeat (directory)))
 
@@ -447,6 +454,7 @@ value of `!DIR'.  See also `idlwave-library-path'."
   :group 'idlwave-routine-info
   :type 'directory)
 
+;; Configuration files
 (defcustom idlwave-config-directory 
   (convert-standard-filename "~/.idlwave")
   "*Directory for configuration files and user-library catalog."
@@ -454,6 +462,7 @@ value of `!DIR'.  See also `idlwave-library-path'."
   :type 'file)
 
 (defvar idlwave-user-catalog-file "idlusercat.el")
+(defvar idlwave-xml-system-rinfo-converted-file "idl_xml_rinfo.el")
 (defvar idlwave-path-file "idlpath.el")
 
 (defvar idlwave-libinfo-file nil
@@ -592,6 +601,10 @@ for which to assume this can be set here."
   :group 'idlwave-routine-info
   :type '(repeat (regexp :tag "Match method:")))
   
+(defcustom idlwave-complete-structure-tags t
+  "Whether to complete structure tags in source and shell."
+  :group 'idlwave-routine-info
+  :type 'boolean)
 
 (defcustom idlwave-completion-show-classes 1
   "*Number of classes to show when completing object methods and keywords.
@@ -672,7 +685,7 @@ method, add an entry (\"INIT\" . t).  The method name must be ALL-CAPS."
 	   (cons (string  :tag "MODULE" :value "")
 		 (boolean :tag "Determine class for this method")))))
 
-(defcustom idlwave-store-inquired-class nil
+(defcustom idlwave-store-inquired-class t
   "*Non-nil means, store class of a method call as text property on `->'.
 IDLWAVE sometimes has to ask the user for the class associated with a
 particular object method call.  This happens during the commands
@@ -954,7 +967,7 @@ Otherwise STRING is used. If nil, the file summary will be omitted.
 For example you might set PATHNAME to the path for the
 lib_template.pro file included in the IDL distribution.")
 
-(defcustom idlwave-header-to-beginning-of-file nil
+(defcustom idlwave-header-to-beginning-of-file t
   "*Non-nil means, the documentation header will always be at start of file.
 When nil, the header is positioned between the PRO/FUNCTION line of
 the current routine and the code, allowing several routine headers in
@@ -991,10 +1004,6 @@ If nil it will not be inserted."
   "Path locations of external commands used by IDLWAVE."
   :group 'idlwave)
 
-;; WARNING: The following variable has recently been moved from
-;; idlw-shell.el to this file.  I hope this does not break
-;; anything.
-
 (defcustom idlwave-shell-explicit-file-name "idl"
   "*If non-nil, this is the command to run IDL.
 Should be an absolute file path or path relative to the current environment
@@ -1019,7 +1028,8 @@ split it for you."
   :group 'idlwave-external-programs)
 
 (defcustom idlwave-help-application "idlhelp"
-  "*The external application providing reference help for programming."
+  "*The external application providing reference help for programming.
+Obsolete, if the IDL Assistant is being used for help."
   :group 'idlwave-external-programs
   :type 'string)
 
@@ -1053,6 +1063,7 @@ IDL process is made."
 
 (defgroup idlwave-misc nil
   "Miscellaneous options for IDLWAVE mode."
+  :link '(custom-group-link :tag "Font Lock Faces group" font-lock-faces)
   :group 'idlwave)
 
 (defcustom idlwave-startup-message t
@@ -1161,7 +1172,7 @@ As a user, you should not set this to t.")
 	'("\\<\\(common\\)\\>[ \t]*\\(\\sw+\\)?[ \t]*,?"
 	  (1 font-lock-keyword-face)	          ; "common"
 	  (2 font-lock-reference-face nil t)      ; block name
-	  (font-lock-match-c++-style-declaration-item-and-skip-to-next
+	  ("[ \t]*\\(\\sw+\\)[ ,]*"
 	   ;; Start with point after block name and comma
 	   (goto-char (match-end 0))  ; needed for XEmacs, could be nil 
 	   nil
@@ -1203,9 +1214,9 @@ As a user, you should not set this to t.")
        ;; Treats continuation lines, works only during whole buffer
        ;; fontification.  Slow, use it only in fancy fontification.
        (keyword-parameters
-	'("\\(,\\|[a-zA-Z0-9_](\\)[ \t]*\\(\\$[ \t]*\\(;.*\\)?\\(\n[ \t]*;.*\\)*\n[ \t]*\\)?\\(/[a-zA-Z_]\\sw*\\|[a-zA-Z_]\\sw*[ \t]*=\\)"
-	  (5 font-lock-reference-face)))
-
+	'("\\(,\\|[a-zA-Z0-9_](\\)[ \t]*\\(\\$[ \t]*\\(;.*\\)?\n\\([ \t]*\\(;.*\\)?\n\\)*[ \t]*\\)?\\(/[a-zA-Z_]\\sw*\\|[a-zA-Z_]\\sw*[ \t]*=\\)"
+	  (6 font-lock-reference-face)))
+       
        ;; System variables start with a bang.
        (system-variables
 	'("\\(![a-zA-Z_0-9]+\\(\\.\\sw+\\)?\\)"
@@ -1539,7 +1550,7 @@ Capitalize system variables - action only
 (define-key idlwave-mode-map "\C-c\C-n" 'idlwave-next-statement)
 ;; (define-key idlwave-mode-map "\r"       'idlwave-newline)
 ;; (define-key idlwave-mode-map "\t"       'idlwave-indent-line)
-(define-key idlwave-mode-map [(shift tab)] 'idlwave-indent-statement)
+(define-key idlwave-mode-map [(shift iso-lefttab)] 'idlwave-indent-statement)
 (define-key idlwave-mode-map "\C-c\C-a" 'idlwave-auto-fill-mode)
 (define-key idlwave-mode-map "\M-q"     'idlwave-fill-paragraph)
 (define-key idlwave-mode-map "\M-s"     'idlwave-edit-in-idlde)
@@ -1547,6 +1558,8 @@ Capitalize system variables - action only
 (define-key idlwave-mode-map "\C-c\C-m" 'idlwave-doc-modification)
 (define-key idlwave-mode-map "\C-c\C-c" 'idlwave-case)
 (define-key idlwave-mode-map "\C-c\C-d" 'idlwave-debug-map)
+
+;; A few pre-bound debug commands (which can auto-launch the shell).
 (when (and (boundp 'idlwave-shell-debug-modifiers)
 	 (listp idlwave-shell-debug-modifiers)
 	 (not (equal idlwave-shell-debug-modifiers '())))
@@ -1590,7 +1603,7 @@ Capitalize system variables - action only
 (define-key idlwave-mode-map "\C-c\C-t"   'idlwave-find-module-this-file)
 (define-key idlwave-mode-map "\C-c?"      'idlwave-routine-info)
 (define-key idlwave-mode-map "\M-?"       'idlwave-context-help)
-(define-key idlwave-mode-map [(control meta ?\?)] 'idlwave-online-help)
+(define-key idlwave-mode-map [(control meta ?\?)] 'idlwave-help-with-topic)
 ;; Pickup both forms of Esc/Meta binding
 (define-key idlwave-mode-map [(meta tab)] 'idlwave-complete)
 (define-key idlwave-mode-map [?\e?\t] 'idlwave-complete)
@@ -1604,18 +1617,21 @@ Capitalize system variables - action only
 ;; Set action and key bindings.
 ;; See description of the function `idlwave-action-and-binding'.
 ;; Automatically add spaces for the following characters
-;(idlwave-action-and-binding "&"  '(idlwave-surround -1 -1 '(?&) 1
-;						    (lambda (char) 0)))
-(idlwave-action-and-binding "<"  '(idlwave-surround -1 -1))
-;; Binding works for both > and ->, by changing the length of the token.
-(idlwave-action-and-binding ">"  '(idlwave-surround -1 -1 '(?-) 1 
-						    'idlwave-gtr-pad-hook))
-(idlwave-action-and-binding "->" '(idlwave-surround -1 -1 nil 2) t)
-(idlwave-action-and-binding ","  '(idlwave-surround 0 -1))
-
-;; Automatically add spaces to equal sign if not keyword
+
+;; Actions for & are complicated by &&
+(idlwave-action-and-binding "&"  'idlwave-custom-ampersand-surround)
+
+;; Automatically add spaces to equal sign if not keyword.  This needs
+;; to go ahead of > and <, so >= and <= will be treated correctly
 (idlwave-action-and-binding "="  '(idlwave-expand-equal -1 -1))
 
+;; Actions for > and < are complicated by >=, <=, and ->... 
+(idlwave-action-and-binding "<"  '(idlwave-custom-ltgtr-surround nil))
+(idlwave-action-and-binding ">"  '(idlwave-custom-ltgtr-surround 'gtr))
+
+(idlwave-action-and-binding ","  '(idlwave-surround 0 -1 1))
+
+
 ;;;
 ;;; Abbrev Section
 ;;;
@@ -1820,11 +1836,10 @@ The main features of this mode are
 
 3. Online IDL Help
    ---------------
+
    \\[idlwave-context-help] displays the IDL documentation relevant
-   for the system variable, keyword, or routine at point.  A single
-   key stroke gets you directly to the right place in the docs.  The
-   HTML help files package must be installed for this to work -- check
-   the IDLWAVE webpage for the correct package for your version.  See
+   for the system variable, keyword, or routines at point.  A single
+   key stroke gets you directly to the right place in the docs.  See
    the manual to configure where and how the HTML help is displayed.
 
 4. Completion
@@ -1908,6 +1923,7 @@ The main features of this mode are
   
   (set (make-local-variable 'comment-start-skip) ";+[ \t]*")
   (set (make-local-variable 'comment-start) ";")
+  (set (make-local-variable 'comment-add) 1) ; ";;" for new and regions
   (set (make-local-variable 'require-final-newline) t)
   (set (make-local-variable 'abbrev-all-caps) t)
   (set (make-local-variable 'indent-tabs-mode) nil)
@@ -1932,14 +1948,22 @@ The main features of this mode are
   (set (make-local-variable 'paragraph-ignore-fill-prefix) nil)
   (set (make-local-variable 'parse-sexp-ignore-comments) t)
 
+  ;; ChangeLog
+  (set (make-local-variable 'add-log-current-defun-function) 
+       'idlwave-current-routine-fullname)
+
   ;; Set tag table list to use IDLTAGS as file name.
   (if (boundp 'tag-table-alist)
       (add-to-list 'tag-table-alist '("\\.pro$" . "IDLTAGS")))
   
-  ;; Font-lock additions - originally Phil Williams, then Ulrik Dickow
+  ;; Font-lock additions
   ;; Following line is for Emacs - XEmacs uses the corresponding property
   ;; on the `idlwave-mode' symbol.
   (set (make-local-variable 'font-lock-defaults) idlwave-font-lock-defaults)
+  (set (make-local-variable 'font-lock-mark-block-function) 
+       'idlwave-mark-subprogram)
+  (set (make-local-variable 'font-lock-fontify-region-function)
+       'idlwave-font-lock-fontify-region)
 
   ;; Imenu setup
   (set (make-local-variable 'imenu-create-index-function)
@@ -1949,6 +1973,14 @@ The main features of this mode are
   (set (make-local-variable 'imenu-prev-index-position-function)
        'idlwave-prev-index-position)
 
+  ;; HideShow setup
+  (add-to-list 'hs-special-modes-alist
+	       (list 'idlwave-mode
+		     idlwave-begin-block-reg
+		     idlwave-end-block-reg
+		     ";"
+		     'idlwave-forward-block nil))
+
   ;; Make a local post-command-hook and add our hook to it
   ;; NB: `make-local-hook' needed for older/alternative Emacs compatibility
   (make-local-hook 'post-command-hook)
@@ -1968,6 +2000,11 @@ The main features of this mode are
   ;; Update the routine info with info about current buffer?
   (idlwave-new-buffer-update)
 
+  (if idlwave-complete-structure-tags
+      (add-hook 'idlwave-mode-hook 
+		(lambda ()
+		  (require 'idlw-complete-structtag))))
+
   ;; Run the mode hook
   (run-hooks 'idlwave-mode-hook))
 
@@ -1976,25 +2013,40 @@ The main features of this mode are
   (unless idlwave-setup-done
     (if (not (file-directory-p idlwave-config-directory))
 	(make-directory idlwave-config-directory))
-    (setq idlwave-user-catalog-file (expand-file-name 
-				     idlwave-user-catalog-file 
-				     idlwave-config-directory)
-	idlwave-path-file (expand-file-name 
-			   idlwave-path-file 
-			   idlwave-config-directory))
+    (setq 
+     idlwave-user-catalog-file (expand-file-name 
+				idlwave-user-catalog-file 
+				idlwave-config-directory)
+     idlwave-xml-system-rinfo-converted-file 
+     (expand-file-name 
+      idlwave-xml-system-rinfo-converted-file
+      idlwave-config-directory)
+     idlwave-path-file (expand-file-name 
+			idlwave-path-file 
+			idlwave-config-directory))
+    ;; Check and setup help location
     (idlwave-read-paths)  ; we may need these early
+
+    (idlwave-help-check-locations)
+
     (setq idlwave-setup-done t)))
 
+(defun idlwave-font-lock-fontify-region (beg end &optional verbose)
+  "Fontify continuation lines correctly."
+  (let (pos)
+    (save-excursion
+      (goto-char beg)
+      (forward-line -1)
+      (when (setq pos (idlwave-is-continuation-line))
+	(goto-char pos)
+	(idlwave-beginning-of-statement)
+	(setq beg (point)))))
+  (font-lock-default-fontify-region beg end verbose))
+
 ;;
 ;; Code Formatting ----------------------------------------------------
 ;; 
 
-(defun idlwave-push-mark (&rest rest)
-  "Push mark for compatibility with Emacs 18/19."
-  (if (fboundp 'iconify-frame)
-      (apply 'push-mark rest)
-    (push-mark)))
-
 (defun idlwave-hard-tab ()
   "Inserts TAB in buffer in current position."
   (interactive)
@@ -2188,7 +2240,6 @@ Also checks if the correct end statement has been used."
 (defun idlwave-close-block ()
   "Terminate the current block with the correct END statement."
   (interactive)
-
   ;; Start new line if we are not in a new line
   (unless (save-excursion
 	    (skip-chars-backward " \t")
@@ -2199,12 +2250,27 @@ Also checks if the correct end statement has been used."
     (insert "end")
     (idlwave-show-begin)))
 
-(defun idlwave-gtr-pad-hook (char) 
-  "Let the > symbol expand around -> if present.  The new token length
-is returned."  
-  2)
-
-(defun idlwave-surround (&optional before after escape-chars length ec-hook)
+(defun idlwave-custom-ampersand-surround (&optional is-action)
+  "Surround &, leaving room for && (which surrround as well)."
+  (let* ((prev-char (char-after (- (point) 2)))
+	 (next-char (char-after (point)))
+	 (amp-left (eq prev-char ?&))
+	 (amp-right (eq next-char ?&))
+	 (len (if amp-left 2 1)))
+    (unless amp-right ;no need to do it twice, amp-left will catch it.
+      (idlwave-surround -1 (if (or is-action amp-left) -1) len))))
+
+(defun idlwave-custom-ltgtr-surround (gtr &optional is-action)
+  "Surround > and < by blanks, leaving room for >= and <=, and considering ->."
+  (let* ((prev-char (char-after (- (point) 2)))
+	(next-char (char-after (point)))
+	(method-invoke (and gtr (eq prev-char ?-)))
+	(len (if method-invoke 2 1)))
+    (unless  (eq next-char ?=)
+      ;; Key binding: pad only on left, to save for possible >=/<=
+      (idlwave-surround -1 (if (or is-action method-invoke) -1) len))))
+
+(defun idlwave-surround (&optional before after length is-action)
   "Surround the LENGTH characters before point with blanks.
 LENGTH defaults to 1.
 Optional arguments BEFORE and AFTER affect the behavior before and
@@ -2217,42 +2283,28 @@ integer < 0    at least |n| spaces
 
 The function does nothing if any of the following conditions is true:
 - `idlwave-surround-by-blank' is nil
-- the character before point is inside a string or comment
-- the char preceeding the string to be surrounded is a member of ESCAPE-CHARS.
-  This hack is used to avoid padding of `>' when it is part of
-  the '->' operator.  In this case, ESCAPE-CHARS would be '(?-).
-
-If a function is passed in EC-HOOK, and an ESCAPE-CHARS match occurs,
-the named function will be called with a single argument of the
-preceeding character.  Then idlwave-surround will run as usual if
-EC-HOOK returns non-nil, and a new length will be taken from the
-return value."
+- the character before point is inside a string or comment"
   (when (and idlwave-surround-by-blank (not (idlwave-quoted)))
-    (let* ((length (or length 1)) ; establish a default for LENGTH
-	   (prev-char (char-after (- (point) (1+ length)))))
-      (when (or (not (memq prev-char escape-chars))
-		(and (fboundp ec-hook) 
-		     (setq length 
-			   (save-excursion (funcall ec-hook prev-char)))))
-	(backward-char length)
-	(save-restriction
-	  (let ((here (point)))
-	    (skip-chars-backward " \t")
-	    (if (bolp)
-		;; avoid clobbering indent
-		(progn
-		  (move-to-column (idlwave-calculate-indent))
-		  (if (<= (point) here)
-		      (narrow-to-region (point) here))
-		  (goto-char here)))
-	    (idlwave-make-space before))
-	  (skip-chars-forward " \t"))
-	(forward-char length)
-	(idlwave-make-space after)
-	;; Check to see if the line should auto wrap
-	(if (and (equal (char-after (1- (point))) ?\ )
-		 (> (current-column) fill-column))
-	    (funcall auto-fill-function))))))
+    (let ((length (or length 1))) ; establish a default for LENGTH
+      (backward-char length)
+      (save-restriction
+	(let ((here (point)))
+	  (skip-chars-backward " \t")
+	  (if (bolp)
+	      ;; avoid clobbering indent
+	      (progn
+		(move-to-column (idlwave-calculate-indent))
+		(if (<= (point) here)
+		    (narrow-to-region (point) here))
+		(goto-char here)))
+	  (idlwave-make-space before))
+	(skip-chars-forward " \t"))
+      (forward-char length)
+      (idlwave-make-space after)
+      ;; Check to see if the line should auto wrap
+      (if (and (equal (char-after (1- (point))) ?\ )
+	       (> (current-column) fill-column))
+	  (funcall auto-fill-function)))))
 
 (defun idlwave-make-space (n)
   "Make space at point.
@@ -2331,12 +2383,13 @@ nil   - do nothing.
       (max (if (bolp) 0 (1+ (current-column)))
            comment-column))))
 
-(defun idlwave-split-line ()
+(defun idlwave-split-line (&optional noindent)
   "Continue line by breaking line at point and indent the lines.
-For a code line insert continuation marker. If the line is a line comment
-then the new line will contain a comment with the same indentation.
-Splits strings with the IDL operator `+' if `idlwave-split-line-string' is
-non-nil."
+For a code line insert continuation marker. Don't indent if
+NOINDENT is passed. If the line is a line comment then the new
+line will contain a comment with the same indentation.  Splits
+strings with the IDL operator `+' if `idlwave-split-line-string'
+is non-nil."
   (interactive)
   ;; Expand abbreviation, just like normal RET would.
   (and abbrev-mode (expand-abbrev))
@@ -2361,26 +2414,31 @@ non-nil."
 	    (if (not (member (char-before) '(?\  ?\t)))
 		(insert " "))
             (insert idlwave-continuation-char)
-	    (newline-and-indent)))
+	    (if (null noindent) 
+		(newline-and-indent)
+	      (newline))))
       (indent-new-comment-line))
     ;; Indent previous line
-    (setq beg (- (point-max) (point)))
-    (forward-line -1)
-    (idlwave-indent-line)
-    (goto-char (- (point-max) beg))
-    ;; Reindent new line
-    (idlwave-indent-line)))
-
-(defun idlwave-beginning-of-subprogram ()
-  "Moves point to the beginning of the current program unit."
+    (when (null noindent)
+      (setq beg (- (point-max) (point)))
+      (forward-line -1)
+      (idlwave-indent-line)
+      (goto-char (- (point-max) beg))
+      ;; Reindent new line
+      (idlwave-indent-line))))
+
+(defun idlwave-beginning-of-subprogram (&optional nomark)
+  "Moves point to the beginning of the current program unit.
+If NOMARK is non-nil, do not push mark."
   (interactive)
-  (idlwave-find-key idlwave-begin-unit-reg -1))
+  (idlwave-find-key idlwave-begin-unit-reg -1 nomark))
 
-(defun idlwave-end-of-subprogram ()
-  "Moves point to the start of the next program unit."
+(defun idlwave-end-of-subprogram (&optional nomark)
+  "Moves point to the start of the next program unit.
+If NOMARK is non-nil, do not push mark."
   (interactive)
   (idlwave-end-of-statement)
-  (idlwave-find-key idlwave-end-unit-reg 1))
+  (idlwave-find-key idlwave-end-unit-reg 1 nomark))
 
 (defun idlwave-mark-statement ()
   "Mark current IDL statement."
@@ -2388,7 +2446,7 @@ non-nil."
   (idlwave-end-of-statement)
   (let ((end (point)))
     (idlwave-beginning-of-statement)
-    (idlwave-push-mark end nil t)))
+    (push-mark end nil t)))
 
 (defun idlwave-mark-block ()
   "Mark containing block."
@@ -2399,7 +2457,7 @@ non-nil."
   (let ((end (point)))
     (idlwave-backward-block)
     (idlwave-beginning-of-statement)
-    (idlwave-push-mark end nil t)))
+    (push-mark end nil t)))
 
 
 (defun idlwave-mark-subprogram ()
@@ -2410,7 +2468,7 @@ The marks are pushed."
   (idlwave-beginning-of-subprogram)
   (let ((beg (point)))
     (idlwave-forward-block)
-    (idlwave-push-mark beg nil t))
+    (push-mark beg nil t))
   (exchange-point-and-mark))
 
 (defun idlwave-backward-up-block (&optional arg)
@@ -2431,11 +2489,12 @@ If prefix ARG < 0 then move forward to enclosing block end."
   (idlwave-block-jump-out 1 'nomark)
   (backward-word 1))
 
-(defun idlwave-forward-block ()
+(defun idlwave-forward-block (&optional arg)
   "Move across next nested block."
   (interactive)
-  (if (idlwave-down-block 1)
-      (idlwave-block-jump-out 1 'nomark)))
+  (let ((arg (or arg 1)))
+    (if (idlwave-down-block arg)
+	(idlwave-block-jump-out arg 'nomark))))
 
 (defun idlwave-backward-block ()
   "Move backward across previous nested block."
@@ -2481,17 +2540,20 @@ The marks are pushed."
 	  (if (re-search-forward idlwave-doclib-end nil t)
 	      (progn
 		(forward-line 1)
-		(idlwave-push-mark beg nil t)
+		(push-mark beg nil t)
 		(message "Could not find end of doc library header.")))
 	  (message "Could not find doc library header start.")
 	  (goto-char here)))))
 
+(defun idlwave-current-routine-fullname ()
+  (let ((name (idlwave-current-routine)))
+    (idlwave-make-full-name (nth 2 name) (car name))))
 
 (defun idlwave-current-routine ()
   "Return (NAME TYPE CLASS) of current routine."
   (idlwave-routines)
   (save-excursion
-    (idlwave-beginning-of-subprogram)
+    (idlwave-beginning-of-subprogram 'nomark)
     (if (looking-at "[ \t]*\\<\\(pro\\|function\\)\\>\\s-+\\(\\([a-zA-Z0-9$_]+\\)::\\)?\\([a-zA-Z0-9$_]+\\)")
 	(let* ((type (if (string= (downcase (match-string 1)) "pro")
 			 'pro 'function))
@@ -2583,14 +2645,15 @@ If not in a statement just moves to end of line. Returns position."
     last-statement))
 
 (defun idlwave-skip-multi-commands (&optional lim)
-  "Skip past multiple commands on a line (with `&')."
+  "Skip past multiple commands on a line (or multiple lines) (with `&')."
   (let ((save-point (point)))
-    (when (re-search-forward ".*&" lim t)
-      (goto-char (match-end 0))
-      (if (idlwave-quoted) 
-	  (goto-char save-point)
-	(if (eq (char-after (- (point) 2)) ?&) (goto-char save-point))))
-    (point)))
+    (while (re-search-forward "[^&]*?\\(&\\)[^&]" lim t)
+      (backward-char)
+      (if (and (not (idlwave-quoted))
+	       (not (eq (char-before (- (point) 1)) ?&)))
+	  (setq save-point (point))))
+    (goto-char save-point)
+    save-point))
 
 (defun idlwave-skip-label-or-case ()
   "Skip label or case statement element.
@@ -2649,8 +2712,13 @@ substatement."
                (idlwave-next-statement))))
     (if pre (goto-char last))
     ;; If a continuation line starts here, move to next line
-    (if (looking-at "[ \t]*\\$\\([ \t]*\\(;\\|$\\)\\)")
-	(beginning-of-line 2))
+    (when (looking-at "[ \t]*\\$\\([ \t]*\\(;\\|$\\)\\)")
+      (beginning-of-line 2))
+    (while 
+	(and (not (eobp))
+	     (or (looking-at idlwave-comment-line-start-skip) ;comment only
+		 (looking-at "[ \t]*$"))) ; blank
+      (beginning-of-line 2))
     (point)))
 
 (defun idlwave-statement-type ()
@@ -2673,7 +2741,7 @@ statement."
       (if st
           (append st (match-end 0))))))
 
-(defun idlwave-expand-equal (&optional before after)
+(defun idlwave-expand-equal (&optional before after is-action)
   "Pad '=' with spaces.  Two cases: Assignment statement, and keyword
 assignment.  Which case is determined using
 `idlwave-start-of-substatement' and `idlwave-statement-type'.  The
@@ -2694,6 +2762,8 @@ only post-padded.  You must use a space before these to disambiguate
 \(not just for padding, but for proper parsing by IDL too!).  Other
 operators, such as ##=, ^=, etc., will be pre-padded.
 
+IS-ACTION is ignored.
+
 See `idlwave-surround'."
   (if idlwave-surround-by-blank
       (let 
@@ -2711,12 +2781,12 @@ See `idlwave-surround'."
 		 (re-search-backward "\\(#\\)\\=" nil t)) 
 		(setq len (1+ (length (match-string 1))))
 	      (when (re-search-backward an-ops nil t)
-		(setq begin nil) ; won't modify begin
+		;(setq begin nil) ; won't modify begin
 		(setq len (1+ (length (match-string 1))))))))
 	
 	(if (eq t idlwave-pad-keyword)  
 	    ;; Everything gets padded equally
-	    (idlwave-surround before after nil len)
+	    (idlwave-surround before after len)
 	  ;; Treating keywords/for variables specially...
 	  (let ((st (save-excursion   ; To catch "for" variables
 		      (idlwave-start-of-substatement t)
@@ -2731,7 +2801,7 @@ See `idlwave-surround'."
 		     (idlwave-surround 0 0)
 		     ) ; remove space
 		    (t))) ; leave any spaces alone
-		  (t (idlwave-surround before after nil len))))))))
+		  (t (idlwave-surround before after len))))))))
 	      
 
 (defun idlwave-indent-and-action (&optional arg)
@@ -2812,18 +2882,20 @@ If the optional argument EXPAND is non-nil then the actions in
     (set-marker mloc nil)))
 
 (defun idlwave-do-action (action)
-  "Perform an action repeatedly on a line.
-ACTION is a list (REG . FUNC).  REG is a regular expression.  FUNC is
-either a function name to be called with `funcall' or a list to be
-evaluated with `eval'.  The action performed by FUNC should leave point
-after the match for REG - otherwise an infinite loop may be entered."
+  "Perform an action repeatedly on a line.  ACTION is a list (REG
+. FUNC).  REG is a regular expression.  FUNC is either a function name
+to be called with `funcall' or a list to be evaluated with `eval'.
+The action performed by FUNC should leave point after the match for
+REG - otherwise an infinite loop may be entered.  FUNC is always
+passed a final argument of 'is-action, so it can discriminate between
+being run as an action, or a key binding"
   (let ((action-key (car action))
         (action-routine (cdr action)))
     (beginning-of-line)
     (while (idlwave-look-at action-key)
       (if (listp action-routine)
-          (eval action-routine)
-        (funcall action-routine)))))
+          (eval (append action-routine '('is-action)))
+        (funcall action-routine 'is-action)))))
 
 (defun idlwave-indent-to (col &optional min)
   "Indent from point with spaces until column COL.
@@ -3175,13 +3247,14 @@ Skips any whitespace. Returns 0 if the end-of-line follows the whitespace."
   "Tests if current line is continuation line.
 Blank or comment-only lines following regular continuation lines (with
 `$') count as continuations too."
-  (save-excursion
-    (or 
-     (idlwave-look-at "\\<\\$")
-     (catch 'loop
-       (while (and (looking-at "^[ \t]*\\(;.*\\)?$") 
-		   (eq (forward-line -1) 0))
-	 (if (idlwave-look-at "\\<\\$") (throw 'loop t)))))))
+  (let (p)
+    (save-excursion
+      (or 
+       (idlwave-look-at "\\<\\$")
+       (catch 'loop
+	 (while (and (looking-at "^[ \t]*\\(;.*\\)?$") 
+		     (eq (forward-line -1) 0))
+	   (if (setq p (idlwave-look-at "\\<\\$")) (throw 'loop p))))))))
 
 (defun idlwave-is-comment-line ()
   "Tests if the current line is a comment line."
@@ -3423,10 +3496,11 @@ If not found returns nil."
 
 (defun idlwave-auto-fill ()
   "Called to break lines in auto fill mode.  
-Only fills non-comment lines if `idlwave-fill-comment-line-only' is
-non-nil.  Places a continuation character at the end of the line if
-not in a comment.  Splits strings with IDL concatenation operator `+'
-if `idlwave-auto-fill-split-string' is non-nil."
+Only fills non-comment lines if `idlwave-fill-comment-line-only'
+is nil (it is t by default).  Places a continuation character at
+the end of the line if not in a comment.  Splits strings with IDL
+concatenation operator `+' if `idlwave-auto-fill-split-string' is
+non-nil."
   (if (<= (current-column) fill-column)
       nil                             ; do not to fill
     (if (or (not idlwave-fill-comment-line-only)
@@ -3438,8 +3512,6 @@ if `idlwave-auto-fill-split-string' is non-nil."
 	  (idlwave-indent-line)
 	  ;; Prevent actions do-auto-fill which calls indent-line-function.
 	  (let (idlwave-do-actions
-		(paragraph-start ".")
-		(paragraph-separate ".")
 		(fill-nobreak-predicate
 		 (if (and (idlwave-in-quote)
 			  idlwave-auto-fill-split-string)
@@ -3450,8 +3522,7 @@ if `idlwave-auto-fill-split-string' is non-nil."
 	  (save-excursion
 	    (end-of-line 0)
 	    ;; Indent the split line
-	    (idlwave-indent-line)
-	    )
+	    (idlwave-indent-line))
 	  (if (save-excursion
 		(beginning-of-line)
 		(looking-at idlwave-comment-line-start-skip))
@@ -3563,7 +3634,7 @@ is non-nil."
   (let ((pos (point)))
     (if idlwave-file-header
 	(cond ((car idlwave-file-header)
-	       (insert-file (car idlwave-file-header)))
+	       (insert-file-contents (car idlwave-file-header)))
 	      ((stringp (car (cdr idlwave-file-header)))
 	       (insert (car (cdr idlwave-file-header))))))
     (goto-char pos)))
@@ -3611,6 +3682,7 @@ location on mark ring so that the user can return to previous point."
 	  (run-hooks 'idlwave-timestamp-hook))
       (error "No valid DOCLIB header"))))
 
+
 ;;; CJC 3/16/93
 ;;; Interface to expand-region-abbrevs which did not work when the
 ;;; abbrev hook associated with an abbrev moves point backwards
@@ -4004,7 +4076,7 @@ you specify /."
 	      ;; Call etags
 	      (if (not (string-match "^[ \\t]*$" item))
 		  (progn
-		    (message (concat "Tagging " item "..."))
+		    (message "%s" (concat "Tagging " item "..."))
 		    (setq errbuf (get-buffer-create "*idltags-error*"))
 		    (setq status (+ status
 				    (if (eq 0 (call-process 
@@ -4117,9 +4189,9 @@ blank lines."
       for var = (car entry)
       do (if (not (consp (symbol-value var))) (set var (list nil))))
 
+    ;; Reset the system & library hash
     (when (or (eq what t) (eq what 'syslib)
 	      (null (cdr idlwave-sint-routines)))
-      ;; Reset the system & library hash
       (loop for entry in entries
 	for var = (car entry) for size = (nth 1 entry)
 	do (setcdr (symbol-value var) 
@@ -4127,9 +4199,9 @@ blank lines."
       (setq idlwave-sint-dirs nil
 	    idlwave-sint-libnames nil))
 
+    ;; Reset the buffer & shell hash
     (when (or (eq what t) (eq what 'bufsh)
 	      (null (car idlwave-sint-routines)))
-      ;; Reset the buffer & shell hash
       (loop for entry in entries
 	for var = (car entry) for size = (nth 1 entry)
 	do (setcar (symbol-value var) 
@@ -4282,7 +4354,9 @@ This defines the function `idlwave-sintern-TAG' and the variable
 (defvar idlwave-user-catalog-routines nil
   "Holds the procedure routine-info from the user scan.")
 (defvar idlwave-library-catalog-routines nil
-  "Holds the procedure routine-info from the library catalog files.")
+  "Holds the procedure routine-info from the .idlwave_catalog library files.")
+(defvar idlwave-library-catalog-libname nil
+  "Name of library catalog loaded from .idlwave_catalog files.")
 (defvar idlwave-path-alist nil
   "Alist with !PATH directories and zero or more flags if the dir has
 been scanned in a user catalog ('user) or discovered in a library
@@ -4345,7 +4419,7 @@ Does not run after automatic updates of buffer or the shell.")
   (idlwave-update-routine-info '(16)))
 
 (defun idlwave-rescan-asynchronously ()
-  "Dispatch another emacs instance to update the idlwave catalog.
+  "Dispatch another Emacs instance to update the idlwave catalog.
 After the process finishes normally, the first access to routine info
 will re-read the catalog."
   (interactive)
@@ -4365,7 +4439,7 @@ will re-read the catalog."
 	  (not (stringp idlwave-user-catalog-file))
 	  (not (file-regular-p idlwave-user-catalog-file)))
       (error "No catalog has been produced yet"))
-  (let* ((emacs (expand-file-name (invocation-name) (invocation-directory)))
+  (let* ((emacs (concat invocation-directory invocation-name))
 	 (args (list "-batch"
 		     "-l" (expand-file-name "~/.emacs")
 		     "-l" "idlwave"
@@ -4390,7 +4464,8 @@ will re-read the catalog."
 ;; ("ROUTINE" type class
 ;;  (system) | (lib pro_file dir "LIBNAME") | (user pro_file dir "USERLIB") |
 ;;  (buffer pro_file dir) | (compiled pro_file dir)
-;;   "calling_string" ("HELPFILE" (("KWD1" . link1) ...)))
+;;   "calling_string" ("HELPFILE" (("KWD1" . link1) ...)) 
+;;                    ("HELPFILE2" (("KWD2" . link) ...)) ...)
 ;;
 ;; DIR will be supplied dynamically while loading library catalogs,
 ;; and is sinterned to save space, as is LIBNAME.  PRO_FILE can be a
@@ -4399,6 +4474,8 @@ will re-read the catalog."
 
 
 (defvar idlwave-load-rinfo-idle-timer)
+(defvar idlwave-shell-path-query)
+
 (defun idlwave-update-routine-info (&optional arg no-concatenate)
   "Update the internal routine-info lists.
 These lists are used by `idlwave-routine-info' (\\[idlwave-routine-info])
@@ -4462,9 +4539,9 @@ information updated immediately, leave NO-CONCATENATE nil."
 	  ;; We can safely scan the buffer stuff first
 	  (progn
 	    (idlwave-update-buffer-routine-info)
-	    (and load (idlwave-load-system-rinfo override-idle)))
+	    (and load (idlwave-load-all-rinfo override-idle)))
 	;; We first do the system info, and then the buffers
-	(and load (idlwave-load-system-rinfo override-idle))
+	(and load (idlwave-load-all-rinfo override-idle))
 	(idlwave-update-buffer-routine-info))
 
       ;; Let's see if there is a shell
@@ -4523,16 +4600,440 @@ information updated immediately, leave NO-CONCATENATE nil."
 		   nil 'idlwave-load-rinfo-next-step)))
 	(error nil))))
 
+(defvar idlwave-library-routines nil "Obsolete variable.")
+
+;;------ XML Help routine info system
+(defun idlwave-load-system-routine-info ()
+  ;; Load the system routine info from the cached routine info file,
+  ;; which, if necessary, will be re-created from the XML file on
+  ;; disk.  As a last fallback, load the (likely outdated) idlw-rinfo
+  ;; file distributed with older IDLWAVE versions (<6.0)
+  (unless (and (load idlwave-xml-system-rinfo-converted-file 
+		     'noerror 'nomessage)
+	       (idlwave-xml-system-routine-info-up-to-date))
+    ;; See if we can create it from XML source
+    (condition-case nil
+	(idlwave-convert-xml-system-routine-info)
+      (error 
+       (unless (load idlwave-xml-system-rinfo-converted-file 
+		     'noerror 'nomessage)
+	 (if idlwave-system-routines
+	     (message 
+	      "Failed to load converted routine info, using old conversion.")
+	   (message 
+	    "Failed to convert XML routine info, falling back on idlw-rinfo.")
+	   (if (not (load "idlw-rinfo" 'noerror 'nomessage))
+	       (message 
+		"Could not locate any system routine information."))))))))
+
+(defun idlwave-xml-system-routine-info-file()
+  (let* ((dir (file-name-as-directory 
+	       (expand-file-name "help/" (idlwave-sys-dir)))))
+    (if (file-directory-p (expand-file-name "online_help" dir))
+	(setq dir (expand-file-name "online_help" dir)))
+    (expand-file-name "idl_catalog.xml" dir)))
+  
+
+(defun idlwave-xml-system-routine-info-up-to-date()
+  (let* ((catalog-file (idlwave-xml-system-routine-info-file)))
+    (file-newer-than-file-p ;converted file is newer than catalog
+     idlwave-xml-system-rinfo-converted-file
+     catalog-file)))
+
+(defvar idlwave-system-class-info nil) ; Gathered from idlw-rinfo
+(defvar idlwave-system-variables-alist nil
+  "Alist of system variables and the associated structure tags.
+Gets set in cached XML rinfo, or `idlw-rinfo.el'.")
+(defvar idlwave-executive-commands-alist nil
+  "Alist of system variables and their help files.")
+(defvar idlwave-help-special-topic-words nil)
+
+		
+(defun idlwave-shorten-syntax (syntax name &optional class)
+  ;; From a list of syntax statments, shorten with %s and group with "or"
+  (let ((case-fold-search t))
+    (mapconcat 
+     (lambda (x)
+       (while (string-match name x)
+	 (setq x (replace-match "%s" t t x)))
+       (if class 
+	   (while (string-match class x)
+	     (setq x (replace-match "%s" t t x))))
+       x)
+     (nreverse syntax)
+     " or ")))
+
+(defun idlwave-xml-create-class-method-lists (xml-entry)
+  ;; Create a class list entry from the xml parsed list., returning a
+  ;; cons of form (class-entry method-entries).
+  (let* ((nameblock (nth 1 xml-entry))
+	 (class (cdr (assq 'name nameblock)))
+	 (link (cdr (assq 'link nameblock)))
+	 (params (cddr xml-entry))
+	 (case-fold-search t)
+	 class-entry
+	 method methods-entry extra-kwds
+	 props get-props set-props init-props inherits
+	 pelem ptype)
+    (while params
+      (setq pelem (car params))
+      (when (listp pelem)
+	(setq ptype (car pelem)
+	      props (car (cdr pelem)))
+	(cond
+	 ((eq ptype 'SUPERCLASS)
+	  (let ((pname (cdr (assq 'name props)))
+		(plink (cdr (assq 'link props))))
+	    (unless (and (string= pname "None")
+			 (string= plink "None"))
+	      (push pname inherits))))
+
+	 ((eq ptype 'PROPERTY)
+	  (let ((pname (cdr (assq 'name props)))
+		(plink (cdr (assq 'link props)))
+		(get (string= (cdr (assq 'get props)) "Yes"))
+		(set (string= (cdr (assq 'set props)) "Yes"))
+		(init (string= (cdr (assq 'init props)) "Yes")))
+	    (if get (push (list pname plink) get-props))
+	    (if set (push (list pname plink) set-props))
+	    (if init (push (list pname plink) init-props))))
+
+	 ((eq ptype 'METHOD)
+	  (setq method (cdr (assq 'name props)))
+	  (setq extra-kwds ;;Assume all property keywords are gathered already
+		(cond
+		 ((string-match (concat class "::Init") method)
+		  (put 'init-props 'matched t)
+		  init-props)
+		 ((string-match (concat class "::GetProperty") method)
+		  (put 'get-props 'matched t)
+		  get-props)
+		 ((string-match (concat class "::SetProperty") method)
+		  (put 'set-props 'matched t)
+		  set-props)
+		 (t nil)))
+	  (setq methods-entry 
+		(nconc (idlwave-xml-create-rinfo-list pelem class extra-kwds) 
+		       methods-entry)))
+	 (t)))
+      (setq params (cdr params)))
+    ;(unless (get 'init-props 'matched)
+    ;  (message "Failed to match Init in class %s" class))
+    ;(unless (get 'get-props 'matched)
+    ;  (message "Failed to match GetProperty in class %s" class))
+    ;(unless (get 'set-props 'matched)
+    ;  (message "Failed to match SetProperty in class %s" class))
+    (setq class-entry 
+	  (if inherits 
+	      (list class (append '(inherits) inherits) (list 'link link))
+	    (list class (list 'link link))))
+    (cons class-entry methods-entry)))
+    
+(defun idlwave-xml-create-rinfo-list (xml-entry &optional class extra-kws)
+  ;; Create correctly structured list elements from ROUTINE or METHOD
+  ;; XML list structures.  Return a list of list elements, with more
+  ;; than one sub-list possible if a routine can serve as both
+  ;; procedure and function (e.g. call_method).
+  (let* ((nameblock (nth 1 xml-entry))
+	 (name (cdr (assq 'name nameblock)))
+	 (link (cdr (assq 'link nameblock)))
+	 (params (cddr xml-entry))
+	 (syntax-vec (make-vector 3 nil)) ; procedure, function, exec command
+	 (case-fold-search t)
+	 syntax kwd klink pref-list kwds pelem ptype entry props result type)
+    (if class ;; strip out class name from class method name string
+	(if (string-match (concat class "::") name)
+	    (setq name (substring name (match-end 0)))))
+    (while params
+      (setq pelem (car params))
+      (when (listp pelem)
+	(setq ptype (car pelem)
+	      props (car (cdr pelem)))
+	(cond
+	 ((eq ptype 'SYNTAX)
+	  (setq syntax (cdr (assq 'name props)))
+	  (if (string-match "-&gt;" syntax)
+	      (setq syntax (replace-match "->" t nil syntax)))
+	  (setq type (cdr (assq 'type props)))
+	  (push syntax
+		(aref syntax-vec (cond
+				  ((string-match "^pro" type) 0)
+				  ((string-match "^fun" type) 1)
+				  ((string-match "^exec" type) 2)))))
+	 ((eq ptype 'KEYWORD)
+	  (setq kwd (cdr (assq 'name props))
+		klink (cdr (assq 'link props)))
+	  (if (string-match "^\\[XY\\(Z?\\)\\]" kwd)
+	      (progn 
+		(setq pref-list 
+		      (if (match-string 1 kwd) '("X" "Y" "Z") '("X" "Y"))
+		      kwd (substring kwd (match-end 0)))
+		(loop for x in pref-list do
+		      (push (list (concat x kwd) klink) kwds)))
+	    (push (list kwd klink) kwds)))
+
+	 (t))); Do nothing for the others
+      (setq params (cdr params)))
+    
+    ;; Debug
+;    (if (and (null (aref syntax-vec 0))
+;	     (null (aref syntax-vec 1))
+;	     (null (aref syntax-vec 2)))
+;	(with-current-buffer (get-buffer-create "IDL_XML_catalog_complaints")
+;	  (if class
+;	      (insert (format "Missing SYNTAX entry for %s::%s\n" class name))
+;	    (insert (message "Missing SYNTAX entry for %s\n" name)))))
+
+    ;; Executive commands are treated specially
+    (if (aref syntax-vec 2)
+	(cons (substring name 1) link)
+      (if extra-kws (setq kwds (nconc kwds extra-kws)))
+      (setq kwds (idlwave-rinfo-group-keywords kwds link))
+      (loop for idx from 0 to 1 do
+	    (if (aref syntax-vec idx)
+		(push (append (list name (if (eq idx 0) 'pro 'fun) 
+				    class '(system)
+				    (idlwave-shorten-syntax 
+				     (aref syntax-vec idx) name class))
+			      kwds) result)))
+      result)))
+
+
+(defun idlwave-rinfo-group-keywords (kwds master-link)
+  ;; Group keywords by link file, as a list with elements 
+  ;; (linkfile ( ("KWD1" . link1) ("KWD2" . link2))
+  (let (kwd link anchor linkfiles block master-elt)
+    (while kwds
+      (setq kwd (car kwds)
+	    link (idlwave-split-link-target (nth 1 kwd))
+	    anchor (cdr link)
+	    link (car link)
+	    kwd (car kwd))
+      (if (setq block (assoc link linkfiles))
+	  (push (cons kwd anchor) (cdr block))
+	(push (list link (cons kwd anchor)) linkfiles))
+      (setq kwds (cdr kwds)))
+    ;; Ensure the master link is there
+    (if (setq master-elt (assoc master-link linkfiles))
+	(if (eq (car linkfiles) master-elt)
+	    linkfiles
+ 	  (cons master-elt (delq master-elt linkfiles)))
+      (push (list master-link) linkfiles))))
+      
+(defun idlwave-convert-xml-clean-statement-aliases (aliases)
+  ;; Clean up the syntax of routines which are actually aliases by
+  ;; removing the "OR" from the statements
+  (let (syntax entry)
+    (loop for x in aliases do
+	  (setq entry (assoc x idlwave-system-routines))
+	  (when entry
+	    (while (string-match " +or +" (setq syntax (nth 4 entry)))
+	      (setf (nth 4 entry) (replace-match ", " t t syntax)))))))
+
+(defun idlwave-convert-xml-clean-routine-aliases (aliases)
+  ;; Duplicate and trim original routine aliases from rinfo list
+  ;; This if for, e.g. OPENR/OPENW/OPENU 
+  (let (alias remove-list new parts all-parts)
+    (loop for x in aliases do
+	  (when (setq parts (split-string (cdr x) "/"))
+	    (setq new (assoc (cdr x) all-parts))
+	    (unless new
+	      (setq new (cons (cdr x) parts))
+	      (push new all-parts))
+	    (setcdr new (delete (car x) (cdr new)))))
+    
+    ;; Add any missing aliases (separate by slashes)
+    (loop for x in all-parts do
+	  (if (cdr x)
+	      (push (cons (nth 1 x) (car x)) aliases)))
+
+    (loop for x in aliases do
+	  (when (setq alias (assoc (cdr x) idlwave-system-routines))
+	    (unless (memq alias remove-list) (push alias remove-list))
+	    (setq alias (copy-sequence alias))
+	    (setcar alias (car x))
+	    (push alias idlwave-system-routines)))
+    (loop for x in remove-list do
+	  (delq x idlwave-system-routines))))
+
+(defun idlwave-convert-xml-clean-sysvar-aliases (aliases)
+  ;; Duplicate and trim original routine aliases from rinfo list
+  ;; This if for, e.g. !X, !Y, !Z.
+  (let (alias remove-list new parts all-parts)
+    (loop for x in aliases do
+	  (when (setq alias (assoc (cdr x) idlwave-system-variables-alist))
+	    (unless (memq alias remove-list) (push alias remove-list))
+	    (setq alias (copy-sequence alias))
+	    (setcar alias (car x))
+	    (push alias idlwave-system-variables-alist)))
+    (loop for x in remove-list do
+	  (delq x idlwave-system-variables-alist))))
+
+
+(defun idlwave-xml-create-sysvar-alist (xml-entry)
+  ;; Create a sysvar list entry from the xml parsed list.
+  (let* ((nameblock (nth 1 xml-entry))
+	 (name (cdr (assq 'name nameblock)))
+	 (sysvar (substring name (progn (string-match "^ *!" name) 
+					(match-end 0))))
+	 (link (cdr (assq 'link nameblock)))
+	 (params (cddr xml-entry))
+	 (case-fold-search t)
+	 pelem ptype props fields tags)
+    (while params
+      (setq pelem (car params))
+      (when (listp pelem)
+	(setq ptype (car pelem)
+	      props (car (cdr pelem)))
+	(cond
+	 ((eq ptype 'FIELD)
+	  (push (cons (cdr (assq 'name props)) 
+		      (cdr
+		       (idlwave-split-link-target (cdr (assq 'link props)))))
+		tags))))
+	(setq params (cdr params)))
+    (delq nil
+	  (list sysvar (if tags (cons 'tags tags)) (list 'link link)))))
+
+
+(defvar idlwave-xml-routine-info-file nil)
+
+(defun idlwave-save-routine-info ()
+  (if idlwave-xml-routine-info-file
+      (with-temp-file idlwave-xml-system-rinfo-converted-file
+	(insert 
+	 (concat ";; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
+;; IDLWAVE Routine Information File (IDLWAVE version " idlwave-mode-version ") 
+;; Automatically generated from source file: 
+;;  " idlwave-xml-routine-info-file "
+;; on " (current-time-string) "
+;; Do not edit."))
+	(insert (format "\n(setq idlwave-xml-routine-info-file \n    \"%s\")"
+			idlwave-xml-routine-info-file))
+	(insert "\n(setq idlwave-system-routines\n    '")
+	(prin1 idlwave-system-routines (current-buffer))
+	(insert ")")
+	(insert "\n(setq idlwave-system-variables-alist\n    '")
+	(prin1 idlwave-system-variables-alist (current-buffer))
+	(insert ")")
+	(insert "\n(setq idlwave-system-class-info\n    '")
+	(prin1 idlwave-system-class-info (current-buffer))
+	(insert ")")
+	(insert "\n(setq idlwave-executive-commands-alist\n    '")
+	(prin1 idlwave-executive-commands-alist (current-buffer))
+	(insert ")")
+	(insert "\n(setq idlwave-help-special-topic-words\n    '")
+	(prin1 idlwave-help-special-topic-words (current-buffer))
+	(insert ")"))))
+
+(defun idlwave-convert-xml-system-routine-info ()
+  "Convert XML supplied IDL routine info into internal form.
+Cache to disk for quick recovery."
+  (interactive)
+  (let* ((catalog-file (idlwave-xml-system-routine-info-file))
+	 (elem-cnt 0)
+	 props rinfo msg-cnt elem type nelem class-result alias 
+	 routines routine-aliases statement-aliases sysvar-aliases
+	 version-string)
+    (if (not (file-exists-p catalog-file))
+	(error "No such XML routine info file: %s" catalog-file)
+      (if (not (file-readable-p catalog-file))
+	  (error "Cannot read XML routine info file: %s" catalog-file)))
+    (require 'xml)
+    (message "Reading XML routine info...")   
+    (setq rinfo (xml-parse-file catalog-file))
+    (message "Reading XML routine info...done")
+    (setq rinfo (assq 'CATALOG rinfo))
+    (unless rinfo (error "Failed to parse XML routine info"))
+    ;;(setq rinfo (car rinfo)) ; Skip the catalog stuff.
+    
+    (setq version-string (cdr (assq 'version (nth 1 rinfo)))
+	  rinfo (cddr rinfo))
+
+    (setq nelem (length rinfo)
+	  msg-cnt (/ nelem 20))
+    
+    (setq idlwave-xml-routine-info-file nil)
+    (message "Converting XML routine info...")
+    (setq idlwave-system-routines nil
+	  idlwave-system-variables-alist nil
+	  idlwave-system-class-info nil
+	  idlwave-executive-commands-alist nil
+	  idlwave-help-special-topic-words nil)
+
+    (while rinfo
+      (setq elem (car rinfo)
+	    rinfo (cdr rinfo))
+      (incf elem-cnt)
+      (when (listp elem)
+	(setq type (car elem)
+	      props (car (cdr elem)))
+	(if (= (mod elem-cnt msg-cnt) 0)
+	    (message "Converting XML routine info...%2d%%" 
+		     (/ (* elem-cnt 100) nelem)))
+	(cond 
+	 ((eq type 'ROUTINE)
+	  (if (setq alias (assq 'alias_to props))
+	      (push (cons (cdr (assq 'name props)) (cdr alias)) 
+		    routine-aliases)
+	    (setq routines (idlwave-xml-create-rinfo-list elem))
+	    (if (listp (cdr routines))
+		(setq idlwave-system-routines
+		      (nconc idlwave-system-routines routines))
+	      ;; a cons cell is an executive commands
+	      (push routines idlwave-executive-commands-alist))))
+	 
+	 ((eq type 'CLASS)
+	  (setq class-result (idlwave-xml-create-class-method-lists elem))
+	  (push (car class-result) idlwave-system-class-info)
+	  (setq idlwave-system-routines
+	  (nconc idlwave-system-routines (cdr class-result))))
+
+	 ((eq type 'STATEMENT)
+	  (push (cons (cdr (assq 'name props))
+		      (cdr (assq 'link props)))
+	  idlwave-help-special-topic-words)
+	  ;; Save the links to those which are statement aliases (not routines)
+	  (if (setq alias (assq 'alias_to props))
+	      (unless (member (cdr alias) statement-aliases)
+		(push (cdr alias) statement-aliases))))
+
+	 ((eq type 'SYSVAR)
+	  (if (setq alias (cdr (assq 'alias_to props)))
+	      (push (cons (substring (cdr (assq 'name props)) 1) 
+			  (substring alias 1))
+		    sysvar-aliases)
+	    (push (idlwave-xml-create-sysvar-alist elem) 
+		  idlwave-system-variables-alist)))
+	 (t))))
+    (idlwave-convert-xml-clean-routine-aliases routine-aliases)
+    (idlwave-convert-xml-clean-statement-aliases statement-aliases)
+    (idlwave-convert-xml-clean-sysvar-aliases sysvar-aliases)
+
+    (setq idlwave-xml-routine-info-file catalog-file)
+    (idlwave-save-routine-info)
+    (message "Converting XML routine info...done")))
+      
+    
+;; ("ROUTINE" type class
+;;  (system) | (lib pro_file dir "LIBNAME") | (user pro_file dir "USERLIB") |
+;;  (buffer pro_file dir) | (compiled pro_file dir)
+;;   "calling_string" ("HELPFILE" (("KWD1" . link1) ...)) 
+;;                    ("HELPFILE2" (("KWD2" . link) ...)) ...)
+
+
 (defun idlwave-load-rinfo-next-step ()
   (let ((inhibit-quit t)
 	(arr idlwave-load-rinfo-steps-done))
-    (when (catch 'exit
+    (if (catch 'exit
 	  (when (not (aref arr 0))
-	    (message "Loading idlw-rinfo.el in idle time...")
-	    (load "idlw-rinfo" 'noerror 'nomessage)
-	    (message "Loading idlw-rinfo.el in idle time...done")
+	    (message "Loading system routine info in idle time...")
+	    (idlwave-load-system-routine-info)
+	    ;;(load "idlw-rinfo" 'noerror 'nomessage)
+	    (message "Loading system routine info in idle time...done")
 	    (aset arr 0 t)
 	    (throw 'exit t))
+	  
 	  (when (not (aref arr 1))
 	    (message "Normalizing idlwave-system-routines in idle time...")
 	    (idlwave-reset-sintern t)
@@ -4542,6 +5043,7 @@ information updated immediately, leave NO-CONCATENATE nil."
 	    (message "Normalizing idlwave-system-routines in idle time...done")
 	    (aset arr 1 t)
 	    (throw 'exit t))
+
 	  (when (not (aref arr 2))
 	    (when (and (stringp idlwave-user-catalog-file)
 		       (file-regular-p idlwave-user-catalog-file))
@@ -4558,9 +5060,10 @@ information updated immediately, leave NO-CONCATENATE nil."
 		    (ding)
 		    (message "Outdated user catalog: %s... recreate" 
 			     idlwave-user-catalog-file))
-		(message "Loading user catalog in idle time...done"))
-	      (aset arr 2 t)
-	      (throw 'exit t)))
+		(message "Loading user catalog in idle time...done")))
+	    (aset arr 2 t)
+	    (throw 'exit t))
+
 	  (when (not (aref arr 3))
 	    (when idlwave-user-catalog-routines
 	      (message "Normalizing user catalog routines in idle time...")
@@ -4571,6 +5074,7 @@ information updated immediately, leave NO-CONCATENATE nil."
 	       "Normalizing user catalog routines in idle time...done"))
 	    (aset arr 3 t)
 	    (throw 'exit t))
+
 	  (when (not (aref arr 4))
 	    (idlwave-scan-library-catalogs 
 	     "Loading and normalizing library catalogs in idle time...")
@@ -4580,6 +5084,7 @@ information updated immediately, leave NO-CONCATENATE nil."
 	    (message "Finishing initialization in idle time...")
 	    (idlwave-routines)
 	    (message "Finishing initialization in idle time...done")
+	    (aset arr 5 t)	    
 	    (throw 'exit nil)))
 	;; restart the timer
 	(if (sit-for 1)
@@ -4589,27 +5094,37 @@ information updated immediately, leave NO-CONCATENATE nil."
 		 idlwave-init-rinfo-when-idle-after
 		 nil 'idlwave-load-rinfo-next-step))))))
 
-(defun idlwave-load-system-rinfo (&optional force)
-  ;; Load and case-treat the system and catalog files.
+(defun idlwave-load-all-rinfo (&optional force)
+  ;; Load and case-treat the system, user catalog, and library routine
+  ;; info files.
+
+  ;; System
   (when (or force (not (aref idlwave-load-rinfo-steps-done 0)))
-    (load "idlw-rinfo" 'noerror 'nomessage))
+    ;;(load "idlw-rinfo" 'noerror 'nomessage))
+    (idlwave-load-system-routine-info))
   (when (or force (not (aref idlwave-load-rinfo-steps-done 1)))
     (message "Normalizing idlwave-system-routines...")
     (setq idlwave-system-routines
 	  (idlwave-sintern-rinfo-list idlwave-system-routines 'sys))
     (message "Normalizing idlwave-system-routines...done"))
-  (setq idlwave-routines (copy-sequence idlwave-system-routines))
-  (setq idlwave-last-system-routine-info-cons-cell
-	(nthcdr (1- (length idlwave-routines)) idlwave-routines))
+  (when idlwave-system-routines
+    (setq idlwave-routines (copy-sequence idlwave-system-routines))
+    (setq idlwave-last-system-routine-info-cons-cell
+	  (nthcdr (1- (length idlwave-routines)) idlwave-routines)))
+
+  ;; User catalog
   (when (and (stringp idlwave-user-catalog-file)
 	     (file-regular-p idlwave-user-catalog-file))
     (condition-case nil
 	(when (or force (not (aref idlwave-load-rinfo-steps-done 2)))
 	  (load-file idlwave-user-catalog-file))
       (error nil))
-    (when (boundp 'idlwave-library-routines)
+    (when (and 
+	   (boundp 'idlwave-library-routines)
+	   idlwave-library-routines)
       (setq idlwave-library-routines nil)
-      (error "Outdated user catalog: %s... recreate" idlwave-user-catalog-file))
+      (error "Outdated user catalog: %s... recreate" 
+	     idlwave-user-catalog-file))
     (setq idlwave-true-path-alist nil)
     (when (or force (not (aref idlwave-load-rinfo-steps-done 3)))
       (message "Normalizing user catalog routines...")
@@ -4617,6 +5132,8 @@ information updated immediately, leave NO-CONCATENATE nil."
 	    (idlwave-sintern-rinfo-list 
 	     idlwave-user-catalog-routines 'sys))
       (message "Normalizing user catalog routines...done")))
+
+  ;; Library catalog
   (when (or force (not (aref idlwave-load-rinfo-steps-done 4)))
     (idlwave-scan-library-catalogs
      "Loading and normalizing library catalogs..."))
@@ -4650,11 +5167,12 @@ information updated immediately, leave NO-CONCATENATE nil."
   ;; The sequence here is important because earlier definitions shadow 
   ;; later ones.  We assume that if things in the buffers are newer
   ;; then in the shell of the system, they are meant to be different.
-  (setcdr idlwave-last-system-routine-info-cons-cell
-	  (append idlwave-buffer-routines
-		  idlwave-compiled-routines
-		  idlwave-library-catalog-routines
-		  idlwave-user-catalog-routines))
+  (if (consp idlwave-last-system-routine-info-cons-cell)
+      (setcdr idlwave-last-system-routine-info-cons-cell
+	      (append idlwave-buffer-routines
+		      idlwave-compiled-routines
+		      idlwave-library-catalog-routines
+		      idlwave-user-catalog-routines)))
   (setq idlwave-class-alist nil)
 
   ;; Give a message with information about the number of routines we have.
@@ -4831,12 +5349,14 @@ information updated immediately, leave NO-CONCATENATE nil."
 
 (defun idlwave-sys-dir ()
   "Return the syslib directory, or a dummy that never matches."
-  (if (string= idlwave-system-directory "")
-      "@@@@@@@@"
-    idlwave-system-directory))
+  (cond
+   ((and idlwave-system-directory
+	 (not (string= idlwave-system-directory "")))
+    idlwave-system-directory)
+   ((getenv "IDL_DIR"))
+   (t "@@@@@@@@")))
 
 
-(defvar idlwave-shell-path-query)
 (defun idlwave-create-user-catalog-file (&optional arg)
   "Scan all files on selected dirs of IDL search path for routine information.
 
@@ -5155,6 +5675,9 @@ directories and save the routine info.
 
 ;;----- Scanning the library catalogs ------------------
 
+
+
+
 (defun idlwave-scan-library-catalogs (&optional message-base no-load)
   "Scan for library catalog files (.idlwave_catalog) and ingest.  
 
@@ -5185,8 +5708,8 @@ be set to nil to disable library catalog scanning."
 		     message-base 
 		     (not (string= idlwave-library-catalog-libname 
 				   old-libname)))
-		(message (concat message-base 
-				 idlwave-library-catalog-libname))
+		(message "%s" (concat message-base 
+				      idlwave-library-catalog-libname))
 		(setq old-libname idlwave-library-catalog-libname))
 	      (when idlwave-library-catalog-routines
 		(setq all-routines
@@ -5209,6 +5732,17 @@ be set to nil to disable library catalog scanning."
 (defconst idlwave-routine-info.pro
   "
 ;; START OF IDLWAVE SUPPORT ROUTINES
+pro idlwave_print_safe,item,limit
+  catch,err
+  if err ne 0 then begin
+     print,'Could not print item.'
+     return
+  endif
+  if n_elements(item) gt limit then $
+     print,item[0:limit-1],'<... truncated at ',strtrim(limit,2),' elements>' $
+  else print,item
+end
+
 pro idlwave_print_info_entry,name,func=func,separator=sep
   ;; See if it's an object method
   if name eq '' then return
@@ -5265,16 +5799,26 @@ pro idlwave_print_info_entry,name,func=func,separator=sep
     + sep + cs + sep + kwstring
 end
 
-pro idlwave_routine_info
+pro idlwave_routine_info,file
   on_error,1
   sep = '<@>'
   print,'>>>BEGIN OF IDLWAVE ROUTINE INFO (\"' + sep + '\" IS THE SEPARATOR)'
   all = routine_info()
-  for i=0,n_elements(all)-1 do $
-    idlwave_print_info_entry,all[i],separator=sep
+  fileQ=n_elements(file) ne 0
+  if fileQ then file=strtrim(file,2)
+  for i=0L,n_elements(all)-1L do begin 
+     if fileQ then begin 
+        if (routine_info(all[i],/SOURCE)).path eq file then $
+           idlwave_print_info_entry,all[i],separator=sep
+     endif else idlwave_print_info_entry,all[i],separator=sep
+  endfor 
   all = routine_info(/functions)
-  for i=0,n_elements(all)-1 do $
-    idlwave_print_info_entry,all[i],/func,separator=sep
+  for i=0L,n_elements(all)-1L do begin 
+     if fileQ then begin 
+        if (routine_info(all[i],/FUNCTIONS,/SOURCE)).path eq file then $
+           idlwave_print_info_entry,all[i],separator=sep,/FUNC
+     endif else idlwave_print_info_entry,all[i],separator=sep,/FUNC
+  endfor 
   print,'>>>END OF IDLWAVE ROUTINE INFO'
 end
 
@@ -5287,7 +5831,7 @@ pro idlwave_get_sysvars
       help,/brief,output=s,/system_variables  ; ? unsafe use of OUTPUT=
       s = strtrim(strjoin(s,' ',/single),2)   ; make one line
       v = strsplit(s,' +',/regex,/extract)    ; get variables
-      for i=0,n_elements(v)-1 do begin
+      for i=0L,n_elements(v)-1 do begin
           t = ['']                            ; get tag list
           a=execute('if n_tags('+v[i]+') gt 0 then t=tag_names('+v[i]+')')
           print, 'IDLWAVE-SYSVAR: '+v[i]+' '+strjoin(t,' ',/single)
@@ -5308,13 +5852,8 @@ end
 
 (defvar idlwave-shell-temp-pro-file)
 (defvar idlwave-shell-temp-rinfo-save-file)
-(defun idlwave-shell-update-routine-info (&optional quiet run-hooks wait)
-  "Query the shell for routine_info of compiled modules and update the lists."
-  ;; Save and compile the procedure.  The compiled procedure is then
-  ;; saved into an IDL SAVE file, to allow for fast RESTORE.
-  ;; We need to RESTORE the procedure each time we use it, since
-  ;; the user may have killed or redefined it.  In particular,
-  ;; .RESET_SESSION will kill all user procedures.
+
+(defun idlwave-shell-compile-helper-routines (&optional wait)
   (unless (and idlwave-idlwave_routine_info-compiled
 	       (file-readable-p (idlwave-shell-temp-file 'rinfo)))
     (save-excursion
@@ -5324,19 +5863,36 @@ end
       (insert idlwave-routine-info.pro)
       (save-buffer 0))
     (idlwave-shell-send-command 
-     (concat ".run " idlwave-shell-temp-pro-file)
+     (concat ".run \"" idlwave-shell-temp-pro-file "\"")
      nil 'hide wait)
-;    (message "SENDING SAVE") ; ????????????????????????
     (idlwave-shell-send-command
-     (format "save,'idlwave_routine_info','idlwave_print_info_entry','idlwave_get_class_tags','idlwave_get_sysvars',FILE='%s',/ROUTINES" 
+     (format "save,'idlwave_print_safe','idlwave_routine_info','idlwave_print_info_entry','idlwave_get_class_tags','idlwave_get_sysvars',FILE='%s',/ROUTINES" 
 	     (idlwave-shell-temp-file 'rinfo))
-     nil 'hide wait))
+     nil 'hide)
+    (setq idlwave-idlwave_routine_info-compiled t))
 
-  ;; Restore and execute the procedure, analyze the output
-;  (message "SENDING RESTORE & EXECUTE") ; ????????????????????????
+  ;; Restore if necessary.  Must use execute to hide lame routine_info
+  ;; errors on undefinded routine
   (idlwave-shell-send-command
-   (format "RESTORE, '%s' & idlwave_routine_info"
+   (format "if execute(\"_v=routine_info('idlwave_routine_info',/SOURCE)\") eq 0 then restore,'%s' else if _v.path eq '' then restore,'%s'"
+	   idlwave-shell-temp-rinfo-save-file
 	   idlwave-shell-temp-rinfo-save-file)
+   nil 'hide))
+
+
+(defun idlwave-shell-update-routine-info (&optional quiet run-hooks wait file)
+  "Query the shell for routine_info of compiled modules and update the lists."
+  ;; Save and compile the procedure.  The compiled procedure is then
+  ;; saved into an IDL SAVE file, to allow for fast RESTORE.  We may
+  ;; need to test for and possibly RESTORE the procedure each time we
+  ;; use it, since the user may have killed or redefined it.  In
+  ;; particular, .RESET_SESSION will kill all user procedures.  If
+  ;; FILE is set, only update routine info for routines in that file.
+
+  (idlwave-shell-compile-helper-routines wait)
+  ; execute the routine_info procedure, and analyze the output
+  (idlwave-shell-send-command
+   (format "idlwave_routine_info%s" (if file (concat ",'" file "'") ""))
    `(progn
       (idlwave-shell-routine-info-filter)
       (idlwave-concatenate-rinfo-lists ,quiet ,run-hooks))
@@ -5503,13 +6059,15 @@ When we force a method or a method keyword, CLASS can specify the class."
 	     (isa (format "procedure%s-keyword" (if class "-method" "")))
 	     (entry (idlwave-best-rinfo-assq
 		     name 'pro class (idlwave-routines)))
+	     (system (if entry (eq (car (nth 3 entry)) 'system)))
 	     (list (idlwave-entry-keywords entry 'do-link)))
 	(unless (or entry (eq class t))
 	  (error "Nothing known about procedure %s"
 		 (idlwave-make-full-name class name)))
-	(setq list (idlwave-fix-keywords name 'pro class list super-classes))
-	(unless list (error (format "No keywords available for procedure %s"
-				    (idlwave-make-full-name class name))))
+	(setq list (idlwave-fix-keywords name 'pro class list 
+					 super-classes system))
+	(unless list (error "No keywords available for procedure %s"
+			    (idlwave-make-full-name class name)))
 	(setq idlwave-completion-help-info 
 	      (list 'keyword name type-selector class-selector entry super-classes))
 	(idlwave-complete-in-buffer
@@ -5534,20 +6092,22 @@ When we force a method or a method keyword, CLASS can specify the class."
 	     (isa (format "function%s-keyword" (if class "-method" "")))
 	     (entry (idlwave-best-rinfo-assq
 		     name 'fun class (idlwave-routines)))
+	     (system (if entry (eq (car (nth 3 entry)) 'system)))
 	     (list (idlwave-entry-keywords entry 'do-link))
 	     msg-name)
 	(unless (or entry (eq class t))
 	  (error "Nothing known about function %s"
 		 (idlwave-make-full-name class name)))
-	(setq list (idlwave-fix-keywords name 'fun class list super-classes))
+	(setq list (idlwave-fix-keywords name 'fun class list 
+					 super-classes system))
 	;; OBJ_NEW: Messages mention the proper Init method
 	(setq msg-name (if (and (null class)
 				(string= (upcase name) "OBJ_NEW"))
 			   (concat idlwave-current-obj_new-class
 				   "::Init (via OBJ_NEW)")
 			 (idlwave-make-full-name class name)))
-	(unless list (error (format "No keywords available for function %s"
-				    msg-name)))
+	(unless list (error "No keywords available for function %s"
+			    msg-name))
 	(setq idlwave-completion-help-info 
 	      (list 'keyword name type-selector class-selector nil super-classes))
 	(idlwave-complete-in-buffer
@@ -6852,10 +7412,10 @@ backward."
 	    (and (not (eq bound 'back)) (re-search-forward re lim t)))
 	(progn
 	  (goto-char (match-beginning 3))
-	  (match-string-no-properties 5)))))
+	  (if name (match-string-no-properties 4)
+	    t)))))
 
 (defvar idlwave-class-info nil) 
-(defvar idlwave-system-class-info nil) ; Gathered from idlw-rinfo
 (defvar idlwave-class-reset nil) ; to reset buffer-local classes
 
 (add-hook 'idlwave-update-rinfo-hook
@@ -7131,12 +7691,6 @@ property indicating the link is added."
 (add-hook 'idlwave-update-rinfo-hook 'idlwave-sysvars-reset)
 (add-hook 'idlwave-after-load-rinfo-hook 'idlwave-sintern-sysvar-alist)
 
-(defvar idlwave-executive-commands-alist nil
-  "Alist of system variables and their help files.")
-
-(defvar idlwave-system-variables-alist nil
-  "Alist of system variables and the associated structure tags.
-Gets set in `idlw-rinfo.el'.")
 
 (defun idlwave-complete-sysvar-or-tag ()
   "Complete a system variable."
@@ -7174,6 +7728,8 @@ Gets set in `idlw-rinfo.el'.")
 	     t)) ; return t to skip other completions
 	  (t nil))))
 
+(defvar link) ;dynamic variables set by help callback
+(defvar props)
 (defun idlwave-complete-sysvar-help (mode word)
   (let ((word (or (nth 1 idlwave-completion-help-info) word))
 	(entry (assoc word idlwave-system-variables-alist)))
@@ -7196,11 +7752,17 @@ Gets set in `idlw-rinfo.el'.")
      ((eq mode 'set)
       (if entry 
 	  (setq link 
-		(if (setq target (cdr (assoc word tags)))
+		(if (setq target (cdr (assoc-ignore-case word tags)))
 		  (idlwave-substitute-link-target main target)
 		main)))) ;; setting dynamic!!!
      (t (error "This should not happen")))))
 
+(defun idlwave-split-link-target (link)
+  "Split a given link into link file and anchor."
+  (if (string-match idlwave-html-link-sep link)
+      (cons (substring link 0 (match-beginning 0))
+	    (string-to-number (substring link (match-end 0))))))
+
 (defun idlwave-substitute-link-target (link target)
   "Substitute the target anchor for the given link."
   (let (main-base)
@@ -7228,7 +7790,7 @@ Gets set in `idlw-rinfo.el'.")
 		 word))
 	(if (assq (idlwave-sintern-class class-with) 
 		  idlwave-system-class-info)
-	    (error "No help available for system class tags."))
+	    (error "No help available for system class tags"))
 	(if (setq found-in (idlwave-class-found-in class-with))
 	    (setq name (cons (concat found-in "__define") class-with))
 	  (setq name (concat class-with "__define")))))
@@ -7239,8 +7801,7 @@ Gets set in `idlw-rinfo.el'.")
 (defun idlwave-class-or-superclass-with-tag (class tag)
   "Find and return the CLASS or one of its superclass with the
 associated TAG, if any."
-  (let ((sclasses (cons class (cdr (assq 'all-inherits 
-					 (idlwave-class-info class)))))
+  (let ((sclasses (cons class (idlwave-all-class-inherits class)))
 	cl)
    (catch 'exit
      (while sclasses
@@ -7681,10 +8242,12 @@ appropriate Init method."
 			     (idlwave-sintern-class class)))))
     module))
 
-(defun idlwave-fix-keywords (name type class keywords &optional super-classes)
+(defun idlwave-fix-keywords (name type class keywords 
+				  &optional super-classes system)
   "Update a list of keywords.
 Translate OBJ_NEW, adding all super-class keywords, or all keywords
-from all classes if class equals t."
+from all classes if class equals t.  If SYSTEM is non-nil, don't
+demand _EXTRA in the keyword list."
   (let ((case-fold-search t))
 
     ;; If this is the OBJ_NEW function, try to figure out the class and use
@@ -7727,8 +8290,10 @@ from all classes if class equals t."
 	   super-classes
 	   idlwave-keyword-class-inheritance
 	   (stringp class)
-	   (or (assq (idlwave-sintern-keyword "_extra") keywords)
-	       (assq (idlwave-sintern-keyword "_ref_extra") keywords))
+	   (or 
+	    system
+	    (assq (idlwave-sintern-keyword "_extra") keywords)
+	    (assq (idlwave-sintern-keyword "_ref_extra") keywords))
 	   ;; Check if one of the keyword-class regexps matches the name
 	   (let ((regexps idlwave-keyword-class-inheritance) re)
 	     (catch 'exit
@@ -7842,7 +8407,7 @@ If we do not know about MODULE, just return KEYWORD literally."
 	 (col 0)
 	 (data (list name type class (current-buffer) nil initial-class))
 	 (km-prop (if (featurep 'xemacs) 'keymap 'local-map))
-	 (face 'idlwave-help-link-face)
+	 (face 'idlwave-help-link)
 	 beg props win cnt total)
     ;; Fix keywords, but don't add chained super-classes, since these 
     ;; are shown separately for that super-class
@@ -8067,7 +8632,8 @@ Optional args RIGHT and SHIFT indicate, if mouse-3 was used, and if SHIFT
 was pressed."
   (interactive "e")
   (if ev (mouse-set-point ev))
-  (let (data id name type class buf bufwin source word initial-class)
+  (let (data id name type class buf bufwin source link keyword 
+	     word initial-class)
     (setq data (get-text-property (point) 'data)
 	  source (get-text-property (point) 'source)
 	  keyword (get-text-property (point) 'keyword)
@@ -8193,9 +8759,8 @@ command can be used to detect possible name clashes during this process."
 		      km-prop keymap
 		      'help-echo "Mouse2: Find source"))      
 	 (nroutines (length (or special-routines routines)))
-	 (step (/ nroutines 99))
+	 (step (/ nroutines 100))
 	 (n 0)
-	 (next-perc 1)
 	 (cnt 0)
 	 (idlwave-sort-prefer-buffer-info nil)
 	 routine twins dtwins twin done props1 lroutines)
@@ -8231,11 +8796,9 @@ command can be used to detect possible name clashes during this process."
       (setq buffer-read-only nil)
       (erase-buffer)
       (while (setq routine (pop routines))
-	(setq n (1+ n))
-	(if (= (* next-perc step) n)
-	    (progn
-	      (message "Compiling list...(%2d%%)" next-perc)
-	      (setq next-perc (1+ next-perc))))
+	(if (= (mod (setq n (1+ n)) step) 0)
+	    (message "Compiling list...(%2d%%)" (/ (* n 100) nroutines)))
+
 	;; Get a list of all twins
 	(setq twins (idlwave-routine-twins routine (or lroutines routines)))
 	(if (memq routine done)
@@ -8352,7 +8915,6 @@ routines, and may have been scanned."
       (setcar entry 'builtin))
     (sort alist 'idlwave-routine-twin-compare)))
 
-(defvar name)
 (defvar type)
 (defvar class)
 (defvar idlwave-sort-prefer-buffer-info t
@@ -8598,12 +9160,15 @@ Assumes that point is at the beginning of the unit as found by
   (interactive)
   (start-process "idldeclient" nil
 		 idlwave-shell-explicit-file-name "-c" "-e"
-                 (buffer-file-name) "&"))
-                
+                 (buffer-file-name)))
+  
+(defvar idlwave-help-use-assistant)
 (defun idlwave-launch-idlhelp ()
   "Start the IDLhelp application."
   (interactive)
-  (start-process "idlhelp" nil idlwave-help-application))
+  (if idlwave-help-use-assistant
+      (idlwave-help-assistant-raise)
+    (start-process "idlhelp" nil idlwave-help-application)))
  
 ;; Menus - using easymenu.el
 (defvar idlwave-mode-menu-def
@@ -8623,8 +9188,10 @@ Assumes that point is at the beginning of the unit as found by
      ["Block" idlwave-mark-block t]
      ["Header" idlwave-mark-doclib t])
     ("Format"
+     ["Indent Entire Statement" idlwave-indent-statement 
+      :active t :keys "C-u \\[indent-for-tab-command]" ]
      ["Indent Subprogram" idlwave-indent-subprogram t]
-     ["(Un)Comment Region" idlwave-toggle-comment-region "C-c ;"]
+     ["(Un)Comment Region" idlwave-toggle-comment-region t]
      ["Continue/Split line" idlwave-split-line t]
      "--"
      ["Toggle Auto Fill" idlwave-auto-fill-mode :style toggle
@@ -8643,7 +9210,7 @@ Assumes that point is at the beginning of the unit as found by
      ["Close Block" idlwave-close-block t])
     ("Completion"
      ["Complete" idlwave-complete t]
-     ("Complete Special"
+     ("Complete Specific"
       ["1 Procedure Name" (idlwave-complete 'procedure) t]
       ["2 Procedure Keyword" (idlwave-complete 'procedure-keyword) t]
       "--"
@@ -8665,6 +9232,7 @@ Assumes that point is at the beginning of the unit as found by
      ["Resolve Routine" idlwave-resolve (featurep 'idlw-shell)]
      "--"
      ["Update Routine Info" idlwave-update-routine-info t]
+     ["Rescan XML Help Catalog" idlwave-convert-xml-system-routine-info t]
      "--"
      "IDL User Catalog"
      ["Select Catalog Directories" (idlwave-create-user-catalog-file nil) t]
@@ -8683,7 +9251,6 @@ Assumes that point is at the beginning of the unit as found by
      ["Insert TAB character" idlwave-hard-tab t])
      "--"
     ("External"
-     ["Generate IDL tags" idlwave-make-tags t]
      ["Start IDL shell" idlwave-shell t]
      ["Edit file in IDLDE" idlwave-edit-in-idlde t]
      ["Launch IDL Help" idlwave-launch-idlhelp t])
@@ -8702,6 +9269,8 @@ Assumes that point is at the beginning of the unit as found by
      "--"
      ["Info" idlwave-info t]
      "--"
+     ["Help with Topic" idlwave-help-assistant-help-with-topic 
+      idlwave-help-use-assistant]
      ["Launch IDL Help" idlwave-launch-idlhelp t])))
 
 (defvar idlwave-mode-debug-menu-def
@@ -8839,12 +9408,10 @@ This function was written since `list-abbrevs' looks terrible for IDLWAVE mode."
 ;; Will only work on systems which support this.
 (or idlwave-routines (idlwave-start-load-rinfo-timer))
 
-;;;###autoload(add-to-list 'auto-mode-alist '("\\.[Pp][Rr][Oo]\\'" . idlwave-mode))
+;;;###autoload (add-to-list 'auto-mode-alist '("\\.[Pp][Rr][Oo]\\'" . idlwave-mode))
 
 ;; Run the hook
 (run-hooks 'idlwave-load-hook)
-
 (provide 'idlwave)
 
-;; arch-tag: f77f3b0c-c37c-424f-a328-0886fd42b6fb
 ;;; idlwave.el ends here
diff --git a/idlwave.texi b/idlwave.texi
index 595421b..d3bd99f 100644
--- a/idlwave.texi
+++ b/idlwave.texi
@@ -9,17 +9,15 @@
 @synindex ky cp
 @syncodeindex vr cp
 @syncodeindex fn cp
-@set VERSION 5.6
-@set EDITION 5.6
-@set IDLVERSION 6.1
-@set NSYSROUTINES 1850
-@set NSYSKEYWORDS 7685
-@set DATE May, 2005
+@set VERSION 6.2
+@set EDITION 6.2
+@set IDLVERSION 7.1
+@set NSYSROUTINES 4346
+@set DATE June
+, 2009
 @set AUTHOR J.D. Smith & Carsten Dominik
-@set AUTHOR-EMAIL jdsmith@@as.arizona.edu
 @set MAINTAINER J.D. Smith
-@set MAINTAINER-EMAIL jdsmith@@as.arizona.edu
-@set IDLWAVE-HOMEPAGE http://idlwave.org/
+@set IDLWAVEHOMEPAGE http://idlwave.org/
 @c %**end of header
 @finalout
 
@@ -30,11 +28,11 @@ Emacs, and interacting with an IDL shell run as a subprocess.
 This is edition @value{EDITION} of the IDLWAVE User Manual for IDLWAVE
 @value{VERSION}
 
-Copyright @copyright{} 1999, 2000, 2001, 2002, 2003, 2004, 2005 Free Software
-Foundation, Inc.
+Copyright @copyright{} 1999, 2000, 2001, 2002, 2003, 2004, 2005, 
+          2006, 2007, 2009 Free Software Foundation, Inc.
 
 Permission is granted to copy, distribute and/or modify this document
-under the terms of the GNU Free Documentation License, Version 1.1 or
+under the terms of the GNU Free Documentation License, Version 1.2 or
 any later version published by the Free Software Foundation; with no
 Invariant Sections, with the Front-Cover texts being ``A GNU
 Manual'', and with the Back-Cover Texts as in (a) below.  A copy of the
@@ -61,12 +59,12 @@ license to the document, as described in section 6 of the license.
 This is edition @value{EDITION} of the @cite{IDLWAVE User Manual} for
 IDLWAVE version @value{VERSION}, @value{DATE}.
 @sp 2
-Copyright @copyright{} 1999, 2000, 2001, 2002, 2003, 2004, 2005 Free Software
-Foundation, Inc.
+Copyright @copyright{} 1999, 2000, 2001, 2002, 2003, 2004, 2005, 
+          2006, 2007, 2009 Free Software Foundation, Inc.
 @sp 2
 @cindex Copyright, of IDLWAVE
 Permission is granted to copy, distribute and/or modify this document
-under the terms of the GNU Free Documentation License, Version 1.1 or
+under the terms of the GNU Free Documentation License, Version 1.2 or
 any later version published by the Free Software Foundation; with no
 Invariant Sections, with the Front-Cover texts being ``A GNU
 Manual'', and with the Back-Cover Texts as in (a) below.  A copy of the
@@ -100,14 +98,15 @@ Interactive Data Language (IDL), and running IDL as an inferior shell.
 * IDLWAVE in a Nutshell::       One page quick-start guide
 * Getting Started::             Tutorial
 * The IDLWAVE Major Mode::      The mode for editing IDL programs
-* The IDLWAVE Shell::           The mode for running IDL as an inferior program
+* The IDLWAVE Shell::           
 * Installation::                How to Install or Upgrade               
-* Acknowledgements::            Who did what
+* Acknowledgements::            
 * Sources of Routine Info::     How does IDLWAVE know about routine XYZ     
 * HTML Help Browser Tips::      
 * Configuration Examples::      The user is king
 * Windows and MacOS::           What still works, and how
 * Troubleshooting::             When good computers turn bad
+* GNU Free Documentation License::  The license for this documentation.
 * Index::                       Fast access
 
 @detailmenu
@@ -166,6 +165,7 @@ The IDLWAVE Shell
 
 * Starting the Shell::          How to launch IDL as a subprocess
 * Using the Shell::             Interactively working with the Shell
+* Multi-Line Commands::         
 * Commands Sent to the Shell::  
 * Debugging IDL Programs::      
 * Examining Variables::         
@@ -214,15 +214,13 @@ Catalogs
 
 IDLWAVE is a package which supports editing source files written in
 the Interactive Data Language (IDL@footnote{IDL is a registered
-trademark of Research Systems, Inc., a Kodak Company}), and running
-IDL as an inferior shell@footnote{Note that this package has nothing
-to do with the Interface Definition Language, part of the Common
-Object Request Broker Architecture (CORBA)}@footnote{IDLWAVE can also
-be used for editing source files for the related WAVE/CL language, but
-with only limited support.}.  It is a feature-rich replacement for the
-IDLDE development environment bundled with IDL, and uses the full
-power of Emacs to make editing and running IDL programs easier,
-quicker, and more structured.
+trademark ITT Visual Information Solutions}
+), and running IDL as an inferior shell@footnote{IDLWAVE can also be used
+for editing source files for the related WAVE/CL language, but with only
+limited support.}.  It is a feature-rich replacement for the IDLDE
+development environment included with IDL, and uses the full power of
+Emacs to make editing and running IDL programs easier, quicker, and more
+structured.
 
 IDLWAVE consists of two main parts: a major mode for editing IDL
 source files (@code{idlwave-mode}) and a mode for running the IDL
@@ -241,8 +239,6 @@ Context-sensitive display of calling sequences and keywords for more
 than 1000 native IDL routines, extendible to any additional number of
 local routines, and already available with many pre-scanned libraries.
 @item
-Routine name space conflict search with likelihood-of-use ranking.
-@item
 Fast, context-sensitive online HTML help, or source-header help for
 undocumented routines.
 @item
@@ -256,6 +252,8 @@ standards.
 @item
 Integrity checks and auto-termination of logical blocks.
 @item
+Routine name space conflict search with likelihood-of-use ranking.
+@item
 Support for @file{imenu} (Emacs) and @file{func-menu} (XEmacs).
 @item
 Documentation support.
@@ -264,6 +262,9 @@ Running IDL as an inferior Shell with history search, command line
 editing and all the completion and routine info capabilities present in
 IDL source buffers.
 @item
+Full handling of debugging with breakpoints, with interactive setting
+of break conditions, and easy stepping through code.
+@item
 Compilation, execution and interactive single-keystroke debugging of
 programs directly from the source buffer.
 @item
@@ -321,10 +322,15 @@ appendix.
 @tab Indent the current line relative to context.
 @item @kbd{C-M-\}
 @tab Re-indent all lines in the current region.
+@item @kbd{C-M-q}
+@tab Re-indent all lines in the current routine.
 @item @kbd{C-u @key{TAB}}
 @tab Re-indent all lines in the current statement.
 @item @kbd{M-@key{RET}}
-@tab Start a continuation line, or split the current line at point.
+@tab Start a continuation line, splitting the current line at point.
+@item @kbd{M-;}
+@tab Start new comment at line beginning or after code, or (un)comment
+highlighted region.
 @item @kbd{M-q}
 @tab Fill the current comment paragraph.
 @item @kbd{C-c ?}
@@ -350,15 +356,17 @@ at point.
 
 @multitable @columnfractions .15 .85
 @item @kbd{C-c C-s}
-@tab Start IDL as a subprocess and/or switch to the interaction buffer.
-@item @kbd{M-p}
+@tab Start IDL as a subprocess and/or switch to the shell buffer.
+@item @key{Up}, @kbd{M-p}
 @tab Cycle back through IDL command history.
-@item @kbd{M-n}
+@item @key{Down},@kbd{M-n}
 @tab Cycle forward.
 @item @kbd{@key{TAB}}
 @tab Complete a procedure name, function name or keyword in the shell buffer.
 @item @kbd{C-c C-d C-c}
 @tab Save and compile the source file in the current buffer.
+@item @kbd{C-c C-d C-e}
+@tab Compile and run the current region.
 @item @kbd{C-c C-d C-x}
 @tab Go to next syntax error.
 @item @kbd{C-c C-d C-v}
@@ -378,12 +386,9 @@ at point.
 @subheading Commonly used Settings in @file{.emacs}
 @lisp
 ;; Change the indentation preferences
-(setq idlwave-main-block-indent 2   ; default  0
-      idlwave-block-indent 2        ; default  4
-      idlwave-end-offset -2)        ; default -4
 ;; Start autoloading routine info after 2 idle seconds
 (setq idlwave-init-rinfo-when-idle-after 2)
-;; Pad some operators with spaces
+;; Pad operators with spaces
 (setq idlwave-do-actions t
       idlwave-surround-by-blank t)
 ;; Syntax Highlighting
@@ -394,9 +399,10 @@ at point.
 (setq idlwave-shell-debug-modifiers '(control shift))
 @end lisp
 
-@ifhtml
+@html
 <A NAME="TUTORIAL"></A>
-@end ifhtml
+@end html
+
 @node Getting Started, The IDLWAVE Major Mode, IDLWAVE in a Nutshell, Top
 @chapter Getting Started (Tutorial)
 @cindex Quick-Start
@@ -501,7 +507,7 @@ to cycle through your command history.  Are we having fun now?
 
 Now go back to the source window and type @kbd{C-c C-d C-c} to compile
 the program.  If you watch the shell buffer, you see that IDLWAVE types
-@samp{.run tutorial.pro} for you.  But the compilation fails because
+@samp{.run "tutorial.pro"} for you.  But the compilation fails because
 there is a comma in the line @samp{years=...}.  The line with the error
 is highlighted and the cursor positioned at the error, so remove the
 comma (you should only need to hit @kbd{Delete}!).  Compile again, using
@@ -587,12 +593,12 @@ sequence of weekdays repeats.
 @node  Lesson II -- Customization, Lesson III -- User Catalog, Lesson I -- Development Cycle, Getting Started
 @section Lesson II: Customization
 
-Emacs is probably the most customizable piece of software ever
-written, and it would be a shame if you did not make use of this and
-adapt IDLWAVE to your own preferences.  Customizing Emacs or IDLWAVE
-is accomplished by setting Lisp variables in the @file{.emacs} file in
-your home directory --- but do not be dismayed; for the most part, you
-can just copy and work from the examples given here.
+Emacs is probably the most customizable piece of software ever written,
+and it would be a shame if you did not make use of this to adapt IDLWAVE
+to your own preferences.  Customizing Emacs or IDLWAVE is accomplished
+by setting Lisp variables in the @file{.emacs} file in your home
+directory --- but do not be dismayed; for the most part, you can just
+copy and work from the examples given here.
 
 Let's first use a boolean variable.  These are variables which you turn
 on or off, much like a checkbox. A value of @samp{t} means on, a value
@@ -611,13 +617,12 @@ behavior, remove the option again from your @file{.emacs} file and
 restart Emacs.
 
 You likely have your own indentation preferences for IDL code.  For
-example, some like to indent the main block of an IDL program from the
-margin, different from the conventions used by RSI, and use only 3
-spaces as indentation between @code{BEGIN} and @code{END}.  Try the
-following lines in @file{.emacs}:
+example, some may prefer to indent the main block of an IDL program
+slightly from the margin and use only 3 spaces as indentation between
+@code{BEGIN} and @code{END}.  Try the following lines in @file{.emacs}:
 
 @lisp
-(setq idlwave-main-block-indent 2)
+(setq idlwave-main-block-indent 1)
 (setq idlwave-block-indent 3)
 (setq idlwave-end-offset -3)
 @end lisp
@@ -793,18 +798,18 @@ them.
 * Octals and Highlighting::     Why "123 causes problems
 @end menu
 
-The IDL language, with its early roots in FORTRAN, modern
-implementation in C, and liberal borrowing of features of many vector
-and other languages along its 25+ year history, has inherited an
-unusual mix of syntax elements.  Left to his or her own devices, a
-novice IDL programmer will often conjure code which is very difficult
-to read and impossible to adapt.  Much can be gleaned from studying
-available IDL code libraries for coding style pointers, but, due to
-the variety of IDL syntax elements, replicating this style can be
-challenging at best.  Luckily, IDLWAVE understands the structure of
-IDL code very well, and takes care of almost all formatting issues for
-you.  After configuring it to match your coding standards, you can
-rely on it to help keep your code neat and organized.
+The IDL language, with its early roots in FORTRAN, modern implementation
+in C, and liberal borrowing of features of many vector and other
+languages along its 30+ year history, has inherited an unusual mix of
+syntax elements.  Left to his or her own devices, a novice IDL
+programmer will often conjure code which is very difficult to read and
+impossible to adapt.  Much can be gleaned from studying available IDL
+code libraries for coding style pointers, but, due to the variety of IDL
+syntax elements, replicating this style can be challenging at best.
+Luckily, IDLWAVE understands the structure of IDL code very well, and
+takes care of almost all formatting issues for you.  After configuring
+it to match your coding standards, you can rely on it to help keep your
+code neat and organized.
 
 
 @node Code Indentation, Continued Statement Indentation, Code Formatting, Code Formatting
@@ -822,25 +827,26 @@ continuation lines.
 @cindex Foreign code, adapting
 @cindex Indentation, of foreign code
 @kindex C-M-\
-To re-indent a larger portion of code (e.g. when working with foreign code
-written with different conventions), use @kbd{C-M-\}
+To re-indent a larger portion of code (e.g. when working with foreign
+code written with different conventions), use @kbd{C-M-\}
 (@code{indent-region}) after marking the relevant code.  Useful marking
-commands are @kbd{C-x h} (the entire file) or @kbd{C-M-h} (the
-current subprogram). @xref{Actions}, for information how to impose
-additional formatting conventions on foreign code.
+commands are @kbd{C-x h} (the entire file) or @kbd{C-M-h} (the current
+subprogram).  The command @kbd{C-M-q} reindents the entire current
+routine.  @xref{Actions}, for information how to impose additional
+formatting conventions on foreign code.
 
-@defopt idlwave-main-block-indent (@code{0}) 
+@defopt idlwave-main-block-indent (@code{2}) 
 Extra indentation for the main block of code.  That is the block between
 the FUNCTION/PRO statement and the END statement for that program
 unit.
 @end defopt
 
-@defopt idlwave-block-indent (@code{4})
+@defopt idlwave-block-indent (@code{3})
 Extra indentation applied to block lines.  If you change this, you
 probably also want to change @code{idlwave-end-offset}.
 @end defopt
 
-@defopt idlwave-end-offset (@code{-4})
+@defopt idlwave-end-offset (@code{-3})
 Extra indentation applied to block END lines.  A value equal to negative
 @code{idlwave-block-indent} will make END lines line up with the block
 BEGIN lines.
@@ -1142,7 +1148,7 @@ When you ask for routine information about an object method, and the
 method exists in several classes, IDLWAVE queries for the class of the
 object, unless the class is already known through a text property on the
 @samp{->} operator (@pxref{Object Method Completion and Class
-Ambiguity}), or by having been explicity included in the call
+Ambiguity}), or by having been explicitly included in the call
 (e.g. @code{a->myclass::Foo}).
 
 @cindex Calling sequences
@@ -1194,7 +1200,7 @@ will automatically split into the next two.
 @item @i{Other}
 @tab Any other routine with a file not known to be on the search path.
 @item @i{Unresolved}
-@tab An otherwise unkown routine the shell lists as unresolved 
+@tab An otherwise unknown routine the shell lists as unresolved 
 (referenced, but not compiled).
 @end multitable
 
@@ -1266,9 +1272,9 @@ Maximum number of source files displayed in the Routine Info window.
 @end defopt
 
 
-@ifhtml
+@html
 <A NAME="ONLINE_HELP"></A>
-@end ifhtml
+@end html
 @node Online Help, Completion, Routine Info, The IDLWAVE Major Mode
 @section Online Help
 
@@ -1278,20 +1284,38 @@ Maximum number of source files displayed in the Routine Info window.
 @cindex Installing online help
 @cindex Online Help, Installation
 @cindex Speed, of online help
-
-For IDL system routines, RSI provides extensive documentation.
-IDLWAVE can access an HTML version of this documentation very quickly
-and accurately.  This is @emph{much} faster than using the IDL online
-help application, because IDLWAVE usually gets you to the right place
-in the documentation directly --- e.g. a specific keyword of a routine
---- without any additional browsing and scrolling.  For this online
-help to work, an HTML version of the IDL documentation, which is not
-part of the standalone IDLWAVE distribution, is required.  The
-necessary files can be downloaded from @uref{@value{IDLWAVE-HOMEPAGE},
-the maintainers webpage}.  There are a variety of options for
-displaying the HTML help: see below.  Help for routines without HTML
-documentation is also available, using the routine documentation
-header and/or source.
+@cindex XML Help Catalog
+
+For IDL system routines, extensive documentation is supplied with IDL.
+IDLWAVE can access the HTML version of this documentation very quickly
+and accurately, based on the local context.  This can be faster than
+using the IDL online help application, because IDLWAVE usually gets you
+to the right place in the documentation directly --- e.g. a specific
+keyword of a routine --- without any additional browsing and scrolling.
+
+For this online help to work, an HTML version of the IDL documentation
+is required.  Beginning with IDL 6.2, HTML documentation is distributed
+directly with IDL, along with an XML-based catalog of routine
+information.  By default, IDLWAVE automatically attempts to convert this
+XML catalog into a format Emacs can more easily understand, and caches
+this information in your @code{idlwave_config_directory}
+(@file{~/.idlwave/}, by default).  It also re-scans the XML catalog if
+it is newer than the current cached version.  You can force rescan with
+the menu entry @code{IDLWAVE->Routine Info->Rescan XML Help Catalog}.
+
+Before IDL 6.2, the HTML help was not distributed with IDL, and was not
+part of the standalone IDLWAVE distribution, but had to be downloaded
+separately.  This is no longer necessary: all help and routine
+information is supplied with IDL versions 6.2 and later. 
+
+@cindex Eclipse-based help
+Starting with IDL 7.0, the HTML help system and associated IDL Assistant
+tool was dropped for an Eclipse-based help system, without access to the
+documentation mediated via the @samp{idlhelp} tool.
+
+There are a variety of options for displaying the HTML help: see below.
+Help for routines without HTML documentation is also available, by using
+the routine documentation header and/or routine source.
 
 @kindex M-?
 In any IDL program (or, as with most IDLWAVE commands, in the IDL
@@ -1301,19 +1325,21 @@ locations are recognized context for help:
 
 @cindex Context, for online help
 @multitable @columnfractions .25 .75
-@item @i{Routine name}
+@item @i{Routine names}
 @tab The name of a routine (function, procedure, method).
-@item @i{Keyword Parameter}
+@item @i{Keyword Parameters}
 @tab A keyword parameter of a routine.
-@item @i{System Variable}
+@item @i{System Variables}
 @tab System variables like @code{!DPI}.
 @item @i{System Variable Tags}
 @tab System variables tags like @code{!D.X_SIZE}.
-@item @i{IDL Statement}
+@item @i{IDL Statements}
 @tab Statements like @code{PRO}, @code{REPEAT}, @code{COMPILE_OPT}, etc.
-@item @i{Class name}
+@item @i{IDL Controls}
+@tab Control structures like @code{FOR}, @code{SWITCH}, etc.
+@item @i{Class names}
 @tab A class name in an @code{OBJ_NEW} call.
-@item @i{Class Init}
+@item @i{Class Init Keywords}
 @tab Beyond the class name in an @code{OBJ_NEW} call.
 @item @i{Executive Command}
 @tab An executive command like @code{.RUN}.  Mostly useful in the shell.
@@ -1365,52 +1391,68 @@ directly in the originating source file.
 @cindex HTML Help
 @cindex Help using HTML manuals
 @cindex IDL manual, HTML version
+@cindex IDL Assistant
+
+This section is relevant only to version of IDL <7.0, at which point the
+HTML help system was replaced with the Eclipse-based help system.  It is
+not longer possible to browse the HTML help using alternative browsers
+(c.f. the @samp{idlhelp} tool).  IDLWAVE automatically detects which
+help system you have, and uses it.
 
 Help using the HTML documentation is invoked with the built-in Emacs
 command @code{browse-url}, which displays the relevant help topic in a
-browser of your choosing.  There are many possible browsers to choose
+browser of your choosing.  Beginning with version 6.2, IDL comes with
+the help browser @emph{IDL Assistant}, which it uses by default for
+displaying online help on all supported platforms.  This browser
+offers topical searches, an index, and is also now the default and
+recommended IDLWAVE help browser.  The variable
+@code{idlwave-help-use-assistant} controls whether this browser is
+used.  Note that, due to limitations in the Assistant, invoking help
+within IDLWAVE and @code{? topic} within IDL will result in two
+running copies of Assistant.
+
+Aside from the IDL Assistant, there are many possible browsers to choose
 among, with differing advantages and disadvantages.  The variable
-@code{idlwave-help-browser-function} controls which browser help is
-sent to.  This function is used to set the variable
-@code{browse-url-browser-function} locally for IDLWAVE help only.
-Customize this variable to see what choices of browsers your system
-offers.
-
-Certain browsers like @code{w3} (bundled with many versions of Emacs)
-and @code{w3m} (@uref{http://emacs-w3m.namazu.org/}, the author's help
-browser of choice) are run within Emacs, and use Emacs buffers to
-display the HTML help.  This can be convenient, especially on small
-displays, and images can even be displayed in-line on new Emacs
-versions.  However, better formatting results are often achieved with
-external browsers, like Mozilla.  IDLWAVE assumes any browser function
-containing "w3" is displayed in a local buffer.  If you are using
-another Emacs-local browser for which this is not true, set the
-variable @code{idlwave-help-browser-is-local}.
-
-@emph{N.B. For Windows users}: IDLWAVE can bring up RSI help directly
-in the Microsoft HTMLHelp documentation supplied with IDL: no
-additional help files are needed.  Be sure to set
-@code{idlwave-system-directory} and the help file will be found
-automatically (or, alternatively, specify its location directly with
-@code{idlwave-html-help-location}).  The variable
-@code{idlwave-help-use-hh} controls whether HTMLHelp is used, and
-which application is called to invoke it (@code{HH} is the default).
-The free helper application @code{KEYHH}
-(@uref{http://www.keyworks.net/keyhh.htm}) can be used instead, and is
-preferrable, as it permits loading new help topics into the same help
-window.  @code{KEYHH} must be downloaded and installed separately.
+@code{idlwave-help-browser-function} controls which browser help is sent
+to (as long as @code{idlwave-help-use-assistant} is not set).  This
+function is used to set the variable @code{browse-url-browser-function}
+locally for IDLWAVE help only.  Customize the latter variable to see
+what choices of browsers your system offers.  Certain browsers like
+@code{w3} (bundled with many versions of Emacs) and @code{w3m}
+(@uref{http://emacs-w3m.namazu.org/}) are run within Emacs, and use
+Emacs buffers to display the HTML help.  This can be convenient,
+especially on small displays, and images can even be displayed in-line
+on newer Emacs versions.  However, better formatting results are often
+achieved with external browsers, like Mozilla.  IDLWAVE assumes any
+browser function containing "w3" is displayed in a local buffer.  If you
+are using another Emacs-local browser for which this is not true, set
+the variable @code{idlwave-help-browser-is-local}.
+
+With IDL 6.2 or later, it is important to ensure that the variable
+@code{idlwave-system-directory} is set (@pxref{Catalogs}).  One easy way
+to ensure this is to run the IDL Shell (@kbd{C-c C-s}).  It will be
+queried for this directory, and the results will be cached to file for
+subsequent use.
 
 @xref{HTML Help Browser Tips}, for more information on selecting and
 configuring a browser for use with IDL's HTML help system.
 
-@defopt idlwave-html-help-location @file{/usr/local/etc}
-The directory where the @file{idl_html_help} dir or @file{idl.chm}
-HTMLHelp files live.
+@defopt idlwave-html-system-help-location @file{help/online_help}
+Relative directory of the system-supplied HTML help directory,
+considered with respect to @code{idlwave-system-directory}.  Relevant
+for IDL 6.2 and greater.  Should not change.
+@end defopt     
+
+@defopt idlwave-html-help-location @file{/usr/local/etc/}
+The directory where the @file{idl_html_help} HTML directory live.
+Obsolete and ignored for IDL 6.2 and greater
+(@code{idlwave-html-system-help-location} is used instead).
 @end defopt
 
-@defopt idlwave-help-use-hh @code{nil}
-If set to @code{'hh} or @code{'keyhh}, use Windows native HTMLHelp
-with the specified help application.
+@defopt idlwave-help-use-assistant @code{t}
+If set, use the IDL Assistant if possible for online HTML help,
+otherwise use the browser function specified in
+@code{idlwave-help-browser-function}.
 @end defopt
 
 @defopt idlwave-help-browser-function
@@ -1421,8 +1463,8 @@ one of the functions available for setting
 
 @defopt idlwave-help-browser-is-local
 Is the browser selected in @code{idlwave-help-browser-function} run in a
-local Emacs buffer?  Defaults to @code{t} if the function contains
-"-w3".
+local Emacs buffer or window?  Defaults to @code{t} if the function
+contains "-w3".
 @end defopt
 
 @defopt idlwave-help-link-face
@@ -1530,16 +1572,15 @@ The case-insensitive heading word in doclib headers to locate the
 @kindex C-c C-i
 IDLWAVE offers completion for class names, routine names, keywords,
 system variables, system variable tags, class structure tags, regular
-structure tags and file names.  As in many programming modes,
-completion is bound to @kbd{M-@key{TAB}} (or @kbd{@key{TAB}} in the
-IDLWAVE Shell --- @pxref{Using the Shell}).  Completion uses exactly
-the same internal information as routine info, so when necessary
-(rarely) it can be updated with @kbd{C-c C-i}
-(@code{idlwave-update-routine-info}).
+structure tags and file names.  As in many programming modes, completion
+is bound to @kbd{M-@key{TAB}} (or simply @kbd{@key{TAB}} in the IDLWAVE
+Shell --- @pxref{Using the Shell}).  Completion uses exactly the same
+internal information as routine info, so when necessary (rarely) it can
+be updated with @kbd{C-c C-i} (@code{idlwave-update-routine-info}).
 
 The completion function is context sensitive and figures out what to
-complete based location of the point.  Here are example lines and what
-@kbd{M-@key{TAB}} would try to complete when the cursor is on the
+complete based on the location of the point.  Here are example lines and
+what @kbd{M-@key{TAB}} would try to complete when the cursor is on the
 position marked with a @samp{_}:
 
 @example
@@ -1549,7 +1590,7 @@ plot,xra_               @r{Keyword of @code{plot} procedure}
 plot,x,y,/x_            @r{Keyword of @code{plot} procedure}
 plot,min(_              @r{Keyword of @code{min} function}
 obj -> a_               @r{Object method (procedure)}
-a(2,3) = obj -> a_      @r{Object method (function)}
+a[2,3] = obj -> a_      @r{Object method (function)}
 x = obj_new('IDL_       @r{Class name}
 x = obj_new('MyCl',a_   @r{Keyword to @code{Init} method in class @code{MyCl}}
 pro A_                  @r{Class name}
@@ -1668,16 +1709,17 @@ completion.
 @cindex Class ambiguity
 @cindex @code{self} object, default class
 An object method is not uniquely determined without the object's class.
-Since the class is almost always omitted in the calling source, IDLWAVE
-considers all available methods in all classes as possible method name
-completions.  The combined list of keywords of the current method in
-@emph{all} known classes which contain that method will be considered
-for keyword completion.  In the @file{*Completions*} buffer, the
-matching classes will be shown next to each item (see option
+Since the class is almost always omitted in the calling source (as
+required to obtain the true benefits of object-based programming),
+IDLWAVE considers all available methods in all classes as possible
+method name completions.  The combined list of keywords of the current
+method in @emph{all} known classes which contain that method will be
+considered for keyword completion.  In the @file{*Completions*} buffer,
+the matching classes will be shown next to each item (see option
 @code{idlwave-completion-show-classes}).  As a special case, the class
 of an object called @samp{self} is always taken to be the class of the
-current routine.  All classes it inherits from are considered as well
-where appropriate.
+current routine, when in an IDLWAVE buffer.  All inherits classes are
+considered as well.
 
 @cindex Forcing class query.
 @cindex Class query, forcing
@@ -1687,7 +1729,7 @@ narrow down the number of possible completions.  The variable
 @code{idlwave-query-class} can be configured to make such prompting the
 default for all methods (not recommended), or selectively for very
 common methods for which the number of completing keywords would be too
-large (e.g. @code{Init}).  
+large (e.g. @code{Init,SetProperty,GetProperty}).  
 
 @cindex Saving object class on @code{->}
 @cindex @code{->}
@@ -1696,9 +1738,9 @@ completing the method), IDLWAVE can remember it for the rest of the
 editing session.  Subsequent completions in the same statement
 (e.g. keywords) can then reuse this class information.  This works by
 placing a text property on the method invocation operator @samp{->},
-after which the operator will be shown in a different face.  This is not
-enabled by default --- the variable @code{idlwave-store-inquired-class}
-can be used to turn it on.
+after which the operator will be shown in a different face (bold by
+default).  The variable @code{idlwave-store-inquired-class} can be used
+to turn it off or on.
 
 @defopt idlwave-completion-show-classes (@code{1})
 Non-@code{nil} means show up to that many classes in
@@ -1714,14 +1756,14 @@ Non-@code{nil} means fontify the classes in completions buffer.
 Association list governing query for object classes during completion.
 @end defopt
 
-@defopt idlwave-store-inquired-class (@code{nil})
+@defopt idlwave-store-inquired-class (@code{t})
 Non-@code{nil} means store class of a method call as text property on
 @samp{->}.
 @end defopt
 
 @defopt idlwave-class-arrow-face
-Face to highlight object operator arrows @samp{->} which carry a class
-text property.
+Face to highlight object operator arrows @samp{->} which carry a saved
+class text property.
 @end defopt
 
 @node Object Method Completion in the Shell, Class and Keyword Inheritance, Object Method Completion and Class Ambiguity, Completion
@@ -1735,9 +1777,7 @@ routine info, or online help within a method routine, a query is sent to
 determine the class of the object.  If this query is successful, the
 class found will be used to select appropriate completions, routine
 info, or help.  If unsuccessful, information from all known classes will
-be used (as in the buffer).  Setting the variable
-@code{idlwave-store-inquired-class} can eliminate unnecessary repetitive
-queries for the object's class, and speed up completion.
+be used (as in the buffer). 
 
 @node   Class and Keyword Inheritance, Structure Tag Completion, Object Method Completion in the Shell, Completion
 @subsection Class and Keyword Inheritance
@@ -1764,12 +1804,12 @@ entire class inheritance chain.  This is often referred to as
 @emph{chaining}, and is characterized by chained method calls like
 @w{@code{self->MySuperClass::SetProperty,_EXTRA=e}}.
 
-IDLWAVE can accomodate this special synergy between class and keyword
+IDLWAVE can accommodate this special synergy between class and keyword
 inheritance: if @code{_EXTRA} or @code{_REF_EXTRA} is detected among a
 method's keyword parameters, all keywords of superclass versions of
 the method being considered can be included in completion.  There is
 of course no guarantee that this type of keyword chaining actually
-occurrs, but for some methods it's a very convenient assumption.  The
+occurs, but for some methods it's a very convenient assumption.  The
 variable @code{idlwave-keyword-class-inheritance} can be used to
 configure which methods have keyword inheritance treated in this
 simple, class-driven way.  By default, only @code{Init} and
@@ -1794,28 +1834,34 @@ In many programs, especially those involving widgets, large structures
 (e.g. the @samp{state} structure) are used to communicate among
 routines.  It is very convenient to be able to complete structure tags,
 in the same way as for instance variables (tags) of the @samp{self}
-object (@pxref{Object Method Completion and Class Ambiguity}).  Add-in
-code for structure tag completion is available in the form of a loadable
-completion module: @file{idlw-complete-structtag.el}.  Tag completion in
-structures is highly ambiguous (much more so than @samp{self}
-completion), so @code{idlw-complete-structtag} makes an unusual and very
-specific assumption: the exact same variable name is used to refer to
-the structure in all parts of the program.  This is entirely unenforced
-by the IDL language, but is a typical convention.  If you consistently
-refer to the same structure with the same variable name
-(e.g. @samp{state}), structure tags which are read from its definition
-in the same file can be used for completion.
-
-Structure tag completion is not enabled by default.  To enable it,
-simply add the following to your @file{.emacs}:
+object (@pxref{Object Method Completion and Class Ambiguity}).  Tag
+completion in structures is highly ambiguous (much more so than
+@samp{self} completion), so @code{idlw-complete-structtag} makes an
+unusual and very specific assumption: the exact same variable name is
+used to refer to the structure in all parts of the program.  This is
+entirely unenforced by the IDL language, but is a typical convention.
+If you consistently refer to the same structure with the same variable
+name (e.g. @samp{state}), structure tags which are read from its
+definition in the same file can be used for completion.
+
+Structure tag completion is enabled by default.  You'll also be able to
+access online help on the structure tags, using the usual methods
+(@pxref{Online Help}).  In addition, structure variables in the shell
+will be queried for tag names, similar to the way object variables in
+the shell are queried for method names.  So, e.g.:
 
-@lisp
-   (add-hook 'idlwave-load-hook 
-             (lambda () (require 'idlw-complete-structtag)))
-@end lisp
+@example
+IDL> st.[Tab]
+@end example
+
+@noindent will complete with all structure fields of the structure
+@code{st}.
+
+@defopt idlwave-complete-structure-tags (@code{t})
+Non-@code{nil} means complete structure tags in the source buffers and
+shell.
+@end defopt
 
-Once enabled, you'll also be able to access online help on the structure
-tags, using the usual methods (@pxref{Online Help}).
 
 @node Routine Source, Resolving Routines, Completion, The IDLWAVE Major Mode
 @section Routine Source
@@ -1852,7 +1898,8 @@ these buffers.
 The key sequence @kbd{C-c =} calls the command @code{idlwave-resolve}
 and sends the line @samp{RESOLVE_ROUTINE, '@var{routine_name}'} to IDL
 in order to resolve (compile) it.  The default routine to be resolved is
-taken from context, but you get a chance to edit it.
+taken from context, but you get a chance to edit it.  Usually this is
+not necessary, since IDL automatically discovers routines on its path.
 
 @code{idlwave-resolve} is one way to get a library module within reach
 of IDLWAVE's routine info collecting functions.  A better way is to
@@ -2160,14 +2207,16 @@ Non-@code{nil} means re-indent line after END was typed.
 
 Some operators can be automatically surrounded by spaces.  This can
 happen when the operator is typed, or later when the line is indented.
-IDLWAVE can pad the operators @samp{&}, @samp{<}, @samp{>}, @samp{,},
-@samp{=}, and @samp{->}, but this feature is turned off by default.  If
-you want to turn it on, customize the variables
-@code{idlwave-surround-by-blank} and @code{idlwave-do-actions}.  You can
-also define similar actions for other operators by using the function
-@code{idlwave-action-and-binding} in the mode hook.  For example, to
-enforce space padding of the @samp{+} and @samp{*} operators, try this
-in @file{.emacs}
+IDLWAVE can pad the operators @samp{<}, @samp{>}, @samp{,}, @samp{=},
+and @samp{->}, as well as the modified assignment operators
+(@samp{AND=}, @samp{OR=}, etc.).  This feature is turned off by default.
+If you want to turn it on, customize the variables
+@code{idlwave-surround-by-blank} and @code{idlwave-do-actions} and turn
+both on.  You can also define similar actions for other operators by
+using the function @code{idlwave-action-and-binding} in the mode hook.
+For example, to enforce space padding of the @samp{+} and @samp{*}
+operators (outside of strings and comments, of course), try this in
+@file{.emacs}
 
 @lisp
 (add-hook 'idlwave-mode-hook
@@ -2177,14 +2226,26 @@ in @file{.emacs}
      (idlwave-action-and-binding "+" '(idlwave-surround 1 1))))
 @end lisp
 
+Note that the modified assignment operators which begin with a word
+(@samp{AND=}, @samp{OR=}, @samp{NOT=}, etc.) require a leading space to
+be recognized (e.g @code{vAND=4} would be interpreted as a variable
+@code{vAND}).  Also note that, since e.g., @code{>} and @code{>=} are
+both valid operators, it is impossible to surround both by blanks while
+they are being typed.  Similarly with @code{&} and @code{&&}.  For
+these, a compromise is made: the padding is placed on the left, and if
+the longer operator is keyed in, on the right as well (otherwise you
+must insert spaces to pad right yourself, or press simply press Tab to
+repad everything if @code{idlwave-do-actions} is on).
+
 @defopt idlwave-surround-by-blank (@code{nil})
 Non-@code{nil} means enable @code{idlwave-surround}.  If non-@code{nil},
-@samp{=}, @samp{<}, @samp{>}, @samp{&}, @samp{,}, @samp{->} are
+@samp{=}, @samp{<}, @samp{>}, @samp{&}, @samp{,}, @samp{->}, and the
+modified assignment operators (@samp{AND=}, @samp{OR=}, etc.) are
 surrounded with spaces by @code{idlwave-surround}.
 @end defopt
 
 @defopt idlwave-pad-keyword (@code{t})
-Non-@code{nil} means pad @samp{=} for keywords like assignments.
+Non-@code{nil} means space-pad the @samp{=} in keyword assignments.
 @end defopt
 
 @node Case Changes,  , Padding Operators, Actions
@@ -2344,8 +2405,6 @@ Normal hook.  Executed when a buffer is put into @code{idlwave-mode}.
 Normal hook.  Executed when @file{idlwave.el} is loaded.
 @end defopt
 
-
-
 @node The IDLWAVE Shell, Installation, The IDLWAVE Major Mode, Top
 @chapter The IDLWAVE Shell
 @cindex IDLWAVE shell
@@ -2364,11 +2423,12 @@ debug these programs.  The IDLWAVE shell is built on @file{comint}, an
 Emacs packages which handles the communication with the IDL program.
 Unfortunately, IDL for Windows does not have command-prompt versions and
 thus do not allow the interaction with Emacs --- so the IDLWAVE shell
-currently only works under Unix and MacOSX.
+currently works only under UNIX and MacOSX.
 
 @menu
 * Starting the Shell::          How to launch IDL as a subprocess
 * Using the Shell::             Interactively working with the Shell
+* Multi-Line Commands::         
 * Commands Sent to the Shell::  
 * Debugging IDL Programs::      
 * Examining Variables::         
@@ -2387,19 +2447,21 @@ currently only works under Unix and MacOSX.
 The IDLWAVE shell can be started with the command @kbd{M-x
 idlwave-shell}.  In @code{idlwave-mode} the function is bound to
 @kbd{C-c C-s}.  It creates a buffer @file{*idl*} which is used to
-interact with the shell.  If the shell is already running, @kbd{C-c
-C-s} will simply switch to the shell buffer.  The command @kbd{C-c
-C-l} (@code{idlwave-shell-recenter-shell-window}) displays the shell
-window without selecting it.  The shell can also be started
-automatically when another command tries to send a command to it.  To
-enable auto start, set the variable
-@code{idlwave-shell-automatic-start} to @code{t}.
+interact with the shell.  If the shell is already running, @kbd{C-c C-s}
+will simply switch to the shell buffer.  The command @kbd{C-c C-l}
+(@code{idlwave-shell-recenter-shell-window}) displays the shell window
+without selecting it.  The shell can also be started automatically when
+another command tries to send a command to it.  To enable auto start,
+set the variable @code{idlwave-shell-automatic-start} to @code{t}.
 
 In order to create a separate frame for the IDLWAVE shell buffer, call
 @code{idlwave-shell} with a prefix argument: @kbd{C-u C-c C-s} or
-@kbd{C-u C-c C-l}.  If you always want a dedicated frame for the shell
-window, configure the variable
-@code{idlwave-shell-use-dedicated-frame}. 
+@kbd{C-u C-c C-l}.  Two prefix argument (@kbd{C-u C-u C-c C-s}) will
+restore to the single frame mode.  If you always want a dedicated frame
+for the shell window, configure the variable
+@code{idlwave-shell-use-dedicated-frame}.  If you'd prefer the shell
+window to appear in the same frame, but at a reduced height, configure
+@code{idlwave-shell-buffer-height-frac}.
 
 To launch a quick IDLWAVE shell directly from a shell prompt without
 an IDLWAVE buffer (e.g., as a replacement for running inside an
@@ -2462,6 +2524,18 @@ Non-@code{nil} means IDLWAVE should use a special frame to display the
 shell buffer.
 @end defopt
 
+@defopt idlwave-shell-buffer-height-frac  (@code{nil})
+Non-@code{nil} means make the shell buffer this fraction of the total
+frame height.  E.g. 0.25 would mean the shell buffer occupies 1/4 of the
+total frame.  Only relevant if @code{idlwave-shell-use-dedicated-frame}
+is @code{nil}.
+@end defopt
+
+@defopt idlwave-shell-use-dedicated-window (@code{nil})
+Non-@code{nil} means use a dedicated window for the shell, taking care
+not it replace it with other buffers.
+@end defopt
+
 @defopt idlwave-shell-frame-parameters
 The frame parameters for a dedicated idlwave-shell frame.
 @end defopt
@@ -2480,10 +2554,11 @@ The prefix for temporary IDL files used when compiling regions.
 Hook for customizing @code{idlwave-shell-mode}.
 @end defopt
 
-@node Using the Shell, Commands Sent to the Shell, Starting the Shell, The IDLWAVE Shell
+@node Using the Shell, Multi-Line Commands, Starting the Shell, The IDLWAVE Shell
 @section Using the Shell
 @cindex Comint
 @cindex Shell, basic commands
+@cindex History, shell
 
 The IDLWAVE shell works in the same fashion as other shell modes in
 Emacs.  It provides command history, command line editing and job
@@ -2583,19 +2658,19 @@ Size of IDL graphics windows popped up by special IDLWAVE command.
 @cindex Line input mode (Shell)
 @cindex Magic spells, for input mode
 @cindex Spells, magic
-IDLWAVE works in line input mode: You compose a full command line, using
-all the power Emacs gives you to do this.  When you press @key{RET}, the
-whole line is sent to IDL.  Sometimes it is necessary to send single
-characters (without a newline), for example when an IDL program is
-waiting for single character input with the @code{GET_KBRD} function.
-You can send a single character to IDL with the command @kbd{C-c C-x}
-(@code{idlwave-shell-send-char}).  When you press @kbd{C-c C-y}
-(@code{idlwave-shell-char-mode-loop}), IDLWAVE runs a blocking loop
-which accepts characters and immediately sends them to IDL.  The loop
-can be exited with @kbd{C-g}.  It terminates also automatically when the
-current IDL command is finished.  Check the documentation of the two
-variables described below for a way to make IDL programs trigger
-automatic switches of the input mode.
+IDLWAVE works in line input mode: you compose a full command line (or
+multiple lines; see below), using all the power Emacs gives you to do
+this.  When you press @key{RET}, the whole line is sent to IDL.
+Sometimes it is necessary to send single characters (without a newline),
+for example when an IDL program is waiting for single character input
+with the @code{GET_KBRD} function.  You can send a single character to
+IDL with the command @kbd{C-c C-x} (@code{idlwave-shell-send-char}).
+When you press @kbd{C-c C-y} (@code{idlwave-shell-char-mode-loop}),
+IDLWAVE runs a blocking loop which accepts characters and immediately
+sends them to IDL.  The loop can be exited with @kbd{C-g}.  It
+terminates also automatically when the current IDL command is finished.
+Check the documentation of the two variables described below for a way
+to make IDL programs trigger automatic switches of the input mode.
 
 @defopt idlwave-shell-use-input-mode-magic (@code{nil})
 Non-@code{nil} means IDLWAVE should check for input mode spells in
@@ -2603,11 +2678,63 @@ output.
 @end defopt
 
 @defopt idlwave-shell-input-mode-spells
-The three regular expressions which match the magic spells for input
+The three regular expressions which match the ``magic spells'' for input
 modes.
 @end defopt
 
-@node Commands Sent to the Shell, Debugging IDL Programs, Using the Shell, The IDLWAVE Shell
+@node Multi-Line Commands, Commands Sent to the Shell, Using the Shell, The IDLWAVE Shell
+@section Multi-Line Commands
+@cindex Multi-line commands
+@cindex Commands, multi-line
+
+
+IDLWAVE can edit and send groups of commands built from multiple lines
+directly in the shell in many ways.  A main level routine (without a
+@samp{pro} or @samp{function} routine definition statement, but with an
+@samp{END}) can be compiled, or a batch routine or selected region can
+be run (@pxref{Compiling Programs}).  Or, as discussed in this section,
+multi-line commands can be entered directly into the IDLWAVE shell, and
+saved and recalled on the history stack.
+
+Hitting @key{RET} at the end of a command in the shell sends the command
+text between the last prompt and the cursor.  To build up multi-line
+commands, use, e.g., @kbd{C-j}.  By default, each line is sent, one at a
+time, to the IDL process as a separate command.  As in IDL batch files,
+however, no multi-line control statements are allowed
+(e.g. @code{FOR...BEGIN..ENDFOR}).  To group multi-line control or other
+statement together as a single command, use an @samp{&} at the end of
+each line, e.g.:
+
+@example
+IDL> for i=0,3 do begin &
+print,i,' is fun' & 
+print,i^2,' is even more fun' &
+endfor
+@end example
+
+@noindent Note that this is identical syntax to an IDL batch file.  
+Use @kbd{C-c @key{SPACE}} to insert a @samp{&} and newline together.  As
+in an IDLWAVE buffer, @kbd{M-@key{RET}} will add a continuation
+character (@samp{$}) and new line for a continued single command.  With
+a combination of @kbd{C-c @key{SPACE}} and @kbd{M-@key{RET}}, complex
+multi-line commands can be built, e.g.:
+
+@example
+IDL> for i=1,20 do begin &
+print,'Now is the time for all good men to come to the aid of their number ', $
+strtrim(i,2),' countries' &
+endfor &
+print,'(Right now)'
+@end example
+
+As usual, @key{RET} at the very end will send the multi-line command.
+By default, moving through history (@pxref{Using the Shell}) with the
+arrow keys will not inhibit movement within multi-line commands, for
+ease of editing.  Holding @key{SHIFT} while using the arrow keys will
+override this behavior; the command history will be cycled through
+directly.
+
+@node Commands Sent to the Shell, Debugging IDL Programs, Multi-Line Commands, The IDLWAVE Shell
 @section Commands Sent to the Shell
 @cindex Commands in shell, showing
 @cindex Showing commands in shell
@@ -2694,21 +2821,17 @@ buffers.
 The many debugging, compiling, and examination commands provided in
 IDLWAVE are available simultaneously through two different interfaces:
 the original, multi-key command interface, and the new Electric Debug
-Mode.  The functionality they offer is similar, but the way you
-interact with them is quite different.  The main difference is that,
-in Electric Debug Mode, the source buffers are made read-only, and
-single key-strokes are used to step through, examine expressions, set
-and remove breakpoints, etc.  The same variables, prefix arguments,
-and settings apply to both versions, and both can be used
-interchangeably.  By default, when breakpoints are hit, Electric Debug
-Mode is enabled.  The traditional interface is described first.
-@xref{Electric Debug Mode}, for more on that mode.
-
-
-@sp 1
-@noindent @strong{Note that electric debug mode can be prevented from
-activating automatically by customizing the variable
-@code{idlwave-shell-automatic-electric-debug}.}
+Mode.  The functionality they offer is similar, but the way you interact
+with them is quite different.  The main difference is that, in Electric
+Debug Mode, the source buffers are made read-only, and single
+key-strokes are used to step through, examine expressions, set and
+remove breakpoints, etc.  The same variables, prefix arguments, and
+settings apply to both versions, and both can be used interchangeably.
+By default, when breakpoints are hit, Electric Debug Mode is enabled.
+The traditional interface is described first.  @xref{Electric Debug
+Mode}, for more on that mode.  Note that electric debug mode can be
+prevented from activating automatically by customizing the variable
+@code{idlwave-shell-automatic-electric-debug}.
 
 @node Debug Key Bindings, Breakpoints and Stepping, A Tale of Two Modes, Debugging IDL Programs
 @subsection Debug Key Bindings
@@ -2772,7 +2895,7 @@ prefix arg of 1 (i.e. @kbd{C-1 C-c C-d C-b}), the breakpoint gets a
 With a numeric prefix greater than one (e.g. @kbd{C-4 C-c C-d C-b}),
 the breakpoint will only be active the @code{nth} time it is hit.
 With a single non-numeric prefix (i.e. @kbd{C-u C-c C-d C-b}), prompt
-for a condition --- an IDL expression to be evaulated and trigger the
+for a condition --- an IDL expression to be evaluated and trigger the
 breakpoint only if true.  To clear the breakpoint in the current line,
 use @kbd{C-c C-d C-d} (@code{idlwave-clear-current-bp}).  When
 executed from the shell window, the breakpoint where IDL is currently
@@ -2790,10 +2913,10 @@ which was set, so the exact line you specify may not be marked.  You can
 re-sync the breakpoint list and update the display at any time (e.g., if
 you add or remove some on the command line) using @kbd{C-c C-d C-l}.  
 
-By default in recent IDLWAVE versions, the breakpoint line is
-highlighted when the mouse is over it, and a tooltip pops up describing
-the break details.  @kbd{Mouse-3} on the breakpoint line pops up a menu
-of breakpoint actions, including clearing, disabling, and adding or
+In recent IDLWAVE versions, the breakpoint line is highlighted when the
+mouse is moved over it, and a tooltip pops up describing the break
+details.  @kbd{Mouse-3} on the breakpoint line pops up a menu of
+breakpoint actions, including clearing, disabling, and adding or
 changing break conditions or ``after'' break count.
 
 Once the program has stopped somewhere, you can step through it.  The
@@ -2846,7 +2969,14 @@ breakpoint and stepping commands:
 @end multitable
 
 All of these commands have equivalents in Electric Debug Mode, which
-provides faster access (@pxref{Electric Debug Mode}).
+provides faster single-key access (@pxref{Electric Debug Mode}).
+
+The line where IDL is currently stopped, at breakpoints, halts, and
+errors, etc., is marked with a color overlay or arrow, depending on the
+setting in @code{idlwave-shell-mark-stop-line}.  If an overlay face is
+used to mark the stop line (as it is by default), when stepping through
+code, the face color is temporarily changed to gray, until IDL completes
+the next command and moves to the new line.
 
 @defopt idlwave-shell-mark-breakpoints (@code{t})
 Non-@code{nil} means mark breakpoints in the source file buffers.  The
@@ -2864,6 +2994,23 @@ Whether to pop-up a menu and present a tooltip description on
 breakpoint lines.
 @end defopt
 
+@defopt idlwave-shell-mark-stop-line (@code{t})
+Non-@code{nil} means mark the source code line where IDL is currently
+stopped.  The value specifies the preferred method.  Valid values are
+@code{nil}, @code{t}, @code{arrow}, and @code{face}.
+@end defopt
+
+@defopt idlwave-shell-overlay-arrow (@code{">"})
+The overlay arrow to display at source lines where execution halts, if
+configured in @code{idlwave-shell-mark-stop-line}.
+@end defopt
+
+@defopt idlwave-shell-stop-line-face
+The face which highlights the source line where IDL is stopped, if
+configured in @code{idlwave-shell-mark-stop-line}.
+@end defopt
+
+
 @node Compiling Programs, Walking the Calling Stack, Breakpoints and Stepping, Debugging IDL Programs
 @subsection Compiling Programs
 @cindex Compiling programs
@@ -2882,29 +3029,18 @@ re-compiled.
 When developing or debugging a program, it is often necessary to execute
 the same command line many times.  A convenient way to do this is
 @kbd{C-c C-d C-y} (@code{idlwave-shell-execute-default-command-line}).
-This command first resets IDL from a state of interrupted execution by
-closing all files and returning to the main interpreter level.  Then a
-default command line is send to the shell.  To edit the default command
-line, call @code{idlwave-shell-execute-default-command-line} with a
-prefix argument: @kbd{C-u C-c C-d C-y}.  If no default command line has
-been set (or you give two prefix arguments), the last command on the
-@code{comint} input history is sent.
-
-@defopt idlwave-shell-mark-stop-line (@code{t})
-Non-@code{nil} means mark the source code line where IDL is currently
-stopped.  The value specifies the preferred method.  Valid values are
-@code{nil}, @code{t}, @code{arrow}, and @code{face}.
-@end defopt
-
-@defopt idlwave-shell-overlay-arrow (@code{">"})
-The overlay arrow to display at source lines where execution halts, if
-configured in @code{idlwave-shell-mark-stop-line}.
-@end defopt
-
-@defopt idlwave-shell-stop-line-face
-The face which highlights the source line where IDL is stopped, if
-configured in @code{idlwave-shell-mark-stop-line}.
-@end defopt
+This command sends a default command line to the shell.  If none has
+been set, you'll be prompted to enter one.  To edit the default command
+line again, call @code{idlwave-shell-execute-default-command-line} with
+a prefix argument: @kbd{C-u C-c C-d C-y}.  If you give two prefix
+arguments, the last command on the @code{comint} input history is sent.
+
+@kindex C-c C-d C-e
+@cindex Compiling regions
+For quickly compiling and running the currently marked region as a main
+level program @kbd{C-c C-d C-e} (@code{idlwave-shell-run-region}) is
+very useful.  A temporary file is created holding the contents of the
+current region (with @code{END} appended), and run from the shell.
 
 @node Walking the Calling Stack, Electric Debug Mode, Compiling Programs, Debugging IDL Programs
 @subsection Walking the Calling Stack
@@ -2925,26 +3061,27 @@ automatically return to the current level. @xref{Examining Variables},
 for information how to examine the value of variables and expressions on
 higher calling stack levels.
 
-@ifhtml
+@html
 <A NAME="EDEBUG"></A>
-@end ifhtml
+@end html
 @node Electric Debug Mode,  , Walking the Calling Stack, Debugging IDL Programs
 @subsection Electric Debug Mode
 @cindex Electric Debug Mode
 @cindex @samp{*Debugging*}
 
 Even with a convenient debug key prefix enabled, repetitive stepping,
-variable examination (@pxref{Examining Variables}), and other
-debugging activities can be awkward and slow using commands which
-require multiple keystrokes.  Luckily, there's a better way, inspired
-by the lisp e-debug mode, and available through the @emph{Electric
-Debug Mode}.  By default, as soon as a breakpoint is hit, this minor
-mode is enabled.  The buffer showing the line where execution has
-halted is switched to Electric Debug Mode.  This mode is visible as
-@samp{*Debugging*} in the mode line, and a different face (violet by
-default, where color is available) for the line stopped at point.  The
-buffer is made read-only and single-character bindings for the most
-commonly used debugging commands are enabled:
+variable examination (@pxref{Examining Variables}), and other debugging
+activities can be awkward and slow using commands which require multiple
+keystrokes.  Luckily, there's a better way, inspired by the lisp e-debug
+mode, and available through the @emph{Electric Debug Mode}.  By default,
+as soon as a breakpoint is hit, this minor mode is enabled.  The buffer
+showing the line where execution has halted is switched to Electric
+Debug Mode.  This mode is visible as @samp{*Debugging*} in the mode
+line, and a different face (violet by default, if color is available)
+for the line stopped at point.  The buffer is made read-only and
+single-character bindings for the most commonly used debugging commands
+are enabled.  These character commands (a list of which is available
+with @kbd{C-?}) are:
 
 @multitable @columnfractions .2 .8
 @item @kbd{a}
@@ -2953,6 +3090,8 @@ commonly used debugging commands are enabled:
 @tab Set breakpoint, @kbd{C-u b} for a conditional break, @kbd{C-n b} for nth hit (@code{idlwave-shell-break-here})
 @item @kbd{d}
 @tab Clear current breakpoint (@code{idlwave-shell-clear-current-bp})
+@item @kbd{e}
+@tab Prompt for expression to print (@code{idlwave-shell-clear-current-bp}).
 @item @kbd{h}
 @tab Continue to the line at cursor position (@code{idlwave-shell-to-here})
 @item @kbd{i}
@@ -3008,7 +3147,7 @@ with shortcut of examine type.
 
 Most single-character electric debug bindings use the final keystroke
 of the equivalent multiple key commands (which are of course also
-still available), but some differ (e.g. @kbd{t},@kbd{q},@kbd{x}).
+still available), but some differ (e.g. @kbd{e},@kbd{t},@kbd{q},@kbd{x}).
 Some have additional convenience bindings (like @kbd{@key{SPACE}} for
 stepping).  All prefix and other argument options described in this
 section for the commands invoked by electric debug bindings are still
@@ -3018,7 +3157,7 @@ as it did with @kbd{C-u C-c C-d C-b}.
 You can toggle the electric debug mode at any time in a buffer using
 @kbd{C-c C-d C-v} (@kbd{v} to turn it off while in the mode), or from
 the Debug menu.  Normally the mode will be enabled and disabled at the
-appropriate times, but occassionally you might want to edit a file
+appropriate times, but occasionally you might want to edit a file
 while still debugging it, or switch to the mode for conveniently
 setting lots of breakpoints.
 
@@ -3044,15 +3183,24 @@ execution, or retall).  In addition to @code{nil} for never, and
 halts.
 @end defopt
 
+@defopt idlwave-shell-electric-stop-color (Violet)
+Default color of the stopped line overlay when in electric debug mode.
+@end defopt        
+
+@defopt idlwave-shell-electric-stop-line-face 
+The face to use for the stopped line.  Defaults to a face similar to the
+modeline, with color @code{idlwave-shell-electric-stop-color}.
+@end defopt
+
 @defopt idlwave-shell-electric-zap-to-file (@code{t})
 If set, when entering electric debug mode, select the window displaying
 the file where point is stopped.  This takes point away from the shell
 window, but is useful for immediate stepping, etc.
 @end defopt
 
-@ifhtml
+@html
 <A NAME="EXAMINE"></A>
-@end ifhtml
+@end html
 @node Examining Variables, Custom Expression Examination, Debugging IDL Programs, The IDLWAVE Shell
 @section Examining Variables
 @cindex @code{PRINT} expressions
@@ -3063,21 +3211,21 @@ window, but is useful for immediate stepping, etc.
 @cindex Mouse binding to print expressions
 
 @kindex C-c C-d C-p
-Do you find yourself repeatedly typing,
-e.g. @code{print,n_elements(x)}, and similar statements to remind
-yourself of the type/size/structure/value/etc. of variables and
-expressions in your code or at the command line?  IDLWAVE has a suite
-of special commands to automate these types of variable or expression
-examinations.  They work by sending statements to the shell formatted
-to include the indicated expression.
-
-These examination commands can be used in the shell or buffer at any
+Do you find yourself repeatedly typing, e.g. @code{print,n_elements(x)},
+and similar statements to remind yourself of the
+type/size/structure/value/etc. of variables and expressions in your code
+or at the command line?  IDLWAVE has a suite of special commands to
+automate these types of variable or expression examinations.  They work
+by sending statements to the shell formatted to include the indicated
+expression, and can be accessed in several ways.
+
+These @emph{examine} commands can be used in the shell or buffer at any
 time (as long as the shell is running), and are very useful when
 execution is stopped in a buffer due to a triggered breakpoint or error,
 or while composing a long command in the IDLWAVE shell.  In the latter
 case, the command is sent to the shell and its output is visible, but
 point remains unmoved in the command being composed --- you can inspect
-the contituents of a command you're building without interrupting the
+the constituents of a command you're building without interrupting the
 process of building it!  You can even print arbitrary expressions from
 older input or output further up in the shell window --- any expression,
 variable, number, or function you see can be examined.
@@ -3085,19 +3233,23 @@ variable, number, or function you see can be examined.
 If the variable @code{idlwave-shell-separate-examine-output} is
 non-@code{nil} (the default), all examine output will be sent to a
 special @file{*Examine*} buffer, rather than the shell.  The output of
-prior examine commands is saved.  In this buffer @key{c} clears the
-contents, and @key{q} hides the buffer.
+prior examine commands is saved in this buffer.  In this buffer @key{c}
+clears the contents, and @key{q} hides the buffer.
 
 The two most basic examine commands are bound to @kbd{C-c C-d C-p}, to
 print the expression at point, and @kbd{C-c C-d ?}, to invoke help on
 this expression@footnote{Available as @kbd{p} and @kbd{?} in Electric
 Debug Mode (@pxref{Electric Debug Mode})}.  The expression at point is
-either an array expression or a function call, or the contents of a
-pair of parentheses.  The selected expression is highlighted, and
-simultaneously the resulting output is highlighted in the shell.
-Calling the above commands with a prefix argument will use the current
-region as expression instead of using the one at point.  Two prefix
-arguments (@kbd{C-u C-u C-c C-d C-p}) will prompt for an expression.
+either an array expression or a function call, or the contents of a pair
+of parentheses.  The chosen expression is highlighted, and
+simultaneously the resulting output is highlighted in the shell or
+separate output buffer.  Calling the above commands with a prefix
+argument will use the current region as expression instead of using the
+one at point. which can be useful for examining complicated, multi-line
+expressions.  Two prefix arguments (@kbd{C-u C-u C-c C-d C-p}) will
+prompt for an expression to print directly.  By default, when invoking
+print, only an initial portion of long arrays will be printed, up to
+@code{idlwave-shell-max-print-length}.
 
 For added speed and convenience, there are mouse bindings which allow
 you to click on expressions and examine their values.  Use
@@ -3151,6 +3303,11 @@ If non-@code{nil}, re-direct the output of examine commands to a special
 @file{*Examine*} buffer, instead of in the shell itself. 
 @end defopt
 
+@defopt idlwave-shell-max-print-length (200)
+The maximum number of leading array entries to print, when examining
+array expressions.
+@end defopt
+
 @node Custom Expression Examination,  , Examining Variables, The IDLWAVE Shell
 @section Custom Expression Examination
 @cindex Expressions, custom examination
@@ -3221,7 +3378,6 @@ examine command strings to send, after all instances of @code{___}
 (three underscores) are replaced by the indicated expression.
 @end defopt
 
-
 @node Installation, Acknowledgements, The IDLWAVE Shell, Top
 @chapter Installation
 @cindex Installation
@@ -3240,19 +3396,12 @@ examine command strings to send, after all instances of @code{___}
 @cindex IDLWAVE, homepage
 @cindex XEmacs package IDLWAVE
 @cindex Emacs, distributed with IDLWAVE
-@cindex Copyright, of IDL manual
 IDLWAVE is part of Emacs 21.1 and later.  It is also an XEmacs package
 and can be installed from
 @uref{ftp://ftp.xemacs.org/pub/xemacs/packages/,the XEmacs ftp site}
-with the normal package management system on XEmacs 21.  These
-pre-installed versions should work out-of-the-box.  However, the HTML
-files required for online HTML help are not distributed with
-XEmacs/Emacs and have to be installed separately@footnote{Due to
-copyright reasons, the HTML version of the IDL manual cannot be
-distributed under the GPL.}  (@pxref{Installing Online Help}).
-
-You can also download IDLWAVE and install it yourself from
-@uref{@value{IDLWAVE-HOMEPAGE}, the maintainers webpage}.  Follow the
+with the normal package management system on XEmacs 21.  You can also
+download IDLWAVE and install it yourself from
+@uref{@value{IDLWAVEHOMEPAGE}, the maintainers webpage}.  Follow the
 instructions in the INSTALL file.
 
 @node Installing Online Help,  , Installing IDLWAVE, Installation
@@ -3260,19 +3409,28 @@ instructions in the INSTALL file.
 @cindex Installing online help
 @cindex Online Help, Installation
 
-If you want to use the online help display, an additional set of files
-(HTML versions of the IDL documentation) must be installed.  These
-files can also be downloaded from @uref{@value{IDLWAVE-HOMEPAGE}, the
+Starting with IDL v6.2, all necessary online help files and routine
+information are distributed directly with IDL.  Nothing additional is
+required.
+
+For version of IDL prior to 6.2 (and IDLWAVE prior to version 6.0), if
+you want to use the online help display, an additional set of files
+(HTML versions of the IDL documentation) must be installed.  These files
+can also be downloaded from @uref{@value{IDLWAVEHOMEPAGE}, the
 maintainers webpage}.  You need to place the files somewhere on your
-system and tell IDLWAVE where they are with
+system and tell IDLWAVE where they are with:
 
 @lisp
-(setq idlwave-html-help-location "/path/to/help/dir/") ;e.g. /usr/local/etc
+; e.g. /usr/local/etc/
+(setq idlwave-html-help-location "/path/to/help/dir/") 
 @end lisp
 
-Note that the help package only changes with new versions of the IDL
+@noindent The default location is @file{/usr/local/etc}, and if you
+install the directory there, you do not need to set this variable.  Note
+that the help package only changes with new versions of the IDL
 documentation, and need not be updated unless your version of IDL
-changes.
+changes.  Since the help system is distributed with IDL starting at
+version 6.2, no new help packages will be created for these versions.
 
 @node Acknowledgements, Sources of Routine Info, Installation, Top
 @chapter Acknowledgements
@@ -3301,8 +3459,8 @@ manual.
 @item 
 @uref{mailto:jdsmith@@as.arizona.edu, @b{J.D. Smith}}, the current
 maintainer, as of version 4.10, helped shape object method completion
-and most new features introduced in versions 4.x, and added
-significant new capabilities for versions 5.x.
+and most new features introduced in versions 4.x, and introduced many
+new features for IDLWAVE versions 5.x and 6.x.
 @end itemize
 
 @noindent
@@ -3346,6 +3504,10 @@ Phil Sterne <sterne__at__dublin.llnl.gov>
 Paul Sorenson <aardvark62__at__msn.com>
 @end itemize
 
+Doug Dirks was instrumental in providing the crucial IDL XML catalog to
+support HTML help with IDL v6.2 and later, and Ali Bahrami provided
+scripts and documentation to interface with the IDL Assistant.
+
 @noindent
 Thanks to everyone!
 
@@ -3380,24 +3542,26 @@ several places:
 
 @enumerate
 @item 
-@emph{Builtin routines} are defined inside IDL itself.  The source
-code of such routines is not available.
+@emph{Builtin routines} are defined inside IDL itself.  The source code
+of such routines is not available, but instead are learned about through
+the IDL documentation.
 @item
 Routines which are @emph{part of the current program}, are defined in a
 file explicitly compiled by the user.  This file may or may not be
 located on the IDL search path.
 @item 
 @emph{Library routines} are defined in files located on IDL's search
-path, and will not need to be manually compiled.  When a library routine
-is called for the first time, IDL will find the source file and compile
-it dynamically.  A special sub-category of library routines are the
-@emph{system routines} distributed with IDL, and usually available in
-the @file{lib} subdirectory of the IDL distribution.
+path.  When a library routine is called for the first time, IDL will
+find the source file and compile it dynamically.  A special sub-category
+of library routines are the @emph{system routines} distributed with IDL,
+and usually available in the @file{lib} subdirectory of the IDL
+distribution.
 @item
 External routines written in other languages (like Fortran or C) can be
 called with @code{CALL_EXTERNAL}, linked into IDL via @code{LINKIMAGE},
 or included as dynamically loaded modules (DLMs).  Currently IDLWAVE
-cannot provide routine info and completion for such external routines.
+cannot provide routine info and completion for such external routines,
+except by querying the Shell for calling information (DLMs only).
 @end enumerate
 
 @node Routine Information Sources, Catalogs, Routine Definitions, Sources of Routine Info
@@ -3417,15 +3581,15 @@ routines on a system, IDLWAVE collects data from many sources:
 @item
 It has a @emph{builtin list} with information about the routines IDL
 ships with.  IDLWAVE @value{VERSION} is distributed with a list of
-@value{NSYSROUTINES} routines and @value{NSYSKEYWORDS} keywords,
-reflecting IDL version @value{IDLVERSION}.  This list has been created
-by scanning the IDL manuals and is stored in the file
-@file{idlw-rinfo.el}.  @xref{Documentation Scan}, for information on
-how to regenerate this file for new versions of IDL.
+@value{NSYSROUTINES} routines and object methods, reflecting IDL version
+@value{IDLVERSION}.  As of IDL v6.2, the routine info is distributed
+directly with IDL in the form of an XML catalog which IDLWAVE scans.
+Formerly, this list was created (imperfectly) by scanning the IDL
+manuals to produce the file @file{idlw-rinfo.el}.
 
 @item 
-It @emph{scans} all @emph{buffers} of the current Emacs session for
-routine definitions.  This is done automatically when routine
+IDLWAVE @emph{scans} all its @emph{buffers} in the current Emacs session
+for routine definitions.  This is done automatically when routine
 information or completion is first requested by the user.  Each new
 buffer and each buffer saved after making changes is also scanned. The
 command @kbd{C-c C-i} (@code{idlwave-update-routine-info}) can be used
@@ -3435,16 +3599,18 @@ at any time to rescan all buffers.
 If you have an IDLWAVE-Shell running in the Emacs session, IDLWAVE will
 @emph{query the shell} for compiled routines and their arguments.  This
 happens automatically when routine information or completion is first
-requested by the user, and each time an Emacs buffer is compiled with
-@kbd{C-c C-d C-c}.  Though rarely necessary, the command @kbd{C-c C-i}
-(@code{idlwave-update-routine-info}) can be used to update the shell
-routine data.
+requested by the user.  Each time an Emacs buffer is compiled with
+@kbd{C-c C-d C-c}, the routine info for that file is queried.  Though
+rarely necessary, the command @kbd{C-c C-i}
+(@code{idlwave-update-routine-info}) can be used to explicitly update
+the shell routine data.
 
 @item
-Many popular libraries are distributed with routine information
-already scanned into @emph{library catalogs} (@pxref{Library
-Catalogs}).  These per-directory catalog files can also be built by
-the user with the supplied @file{idlwave_catalog} tool.
+Many popular libraries are distributed with routine information already
+scanned into @emph{library catalogs} (@pxref{Library Catalogs}).  These
+per-directory catalog files can also be built by the user with the
+supplied @file{idlwave_catalog} tool.  They are automatically discovered
+by IDLWAVE.
 
 @item
 IDLWAVE can scan selected directories of source files and store the
@@ -3453,9 +3619,10 @@ automatically loaded just like @file{idlw-rinfo.el}. @xref{User
 Catalog}, for information on how to scan files in this way.
 @end enumerate
 
-Loading routine and catalog information can be a time consuming process,
-especially over slow networks.  Depending on the system and network
-configuration it could take up to 30 seconds.  In order to minimize the
+Loading all the routine and catalog information can be a time consuming
+process, especially over slow networks.  Depending on the system and
+network configuration it could take up to 30 seconds (though locally on
+fast systems is usually only a few seconds).  In order to minimize the
 wait time upon your first completion or routine info command in a
 session, IDLWAVE uses Emacs idle time to do the initialization in six
 steps, yielding to user input in between.  If this gets into your way,
@@ -3481,9 +3648,9 @@ Non-@code{nil} means query the shell for info about compiled routines.
 Controls under what circumstances routine info is updated automatically.
 @end defopt
 
-@ifhtml
+@html
 <A NAME="CATALOGS"></A>
-@end ifhtml
+@end html
 @node Catalogs, Load-Path Shadows, Routine Information Sources, Sources of Routine Info
 @appendixsec Catalogs
 @cindex Catalogs
@@ -3522,17 +3689,20 @@ to locate library catalogs.
 @end defopt
 
 @defopt idlwave-library-path
-IDL library path for Windows and MacOS.  Not needed under Unix/MacOSX.
+IDL library path for Windows and MacOS.  Under Unix/MacOSX, will be
+obtained from the Shell when run.
 @end defopt
 
 @defopt idlwave-system-directory
-The IDL system directory for Windows and MacOS.  Not needed under
-Unix/MacOSX (obtained from the Shell).
+The IDL system directory for Windows and MacOS.  Also needed for
+locating HTML help and the IDL Assistant for IDL v6.2 and later.  Under
+Unix/MacOSX, will be obtained from the Shell and recorded, if run.
 @end defopt
 
 @defopt idlwave-config-directory (@file{~/.idlwave})
-Default path where IDLWAVE saves configuration information and any
-user catalog.
+Default path where IDLWAVE saves configuration information, a user
+catalog (if any), and a cached scan of the XML catalog (IDL v6.2 and
+later).
 @end defopt
 
 @menu
@@ -3540,23 +3710,23 @@ user catalog.
 * User Catalog::                
 @end menu
 
-@ifhtml
+@html
 <A NAME="LIBRARY_CATALOGS"></A>
-@end ifhtml
+@end html
 @node Library Catalogs, User Catalog, Catalogs, Catalogs
 @appendixsubsec Library Catalogs
 @cindex @file{.idlwave_catalog}
 @cindex Library catalogs
 @cindex @code{idlwave_catalog}
 
-Library catalogs are files named @file{.idlwave_catalog} stored in
-directories containing @code{.pro} routine files.  They are discovered
-on the IDL search path and loaded automatically when routine information
-is read.  Each catalog file documents the routines found in that
-directory --- one catalog per directory.  Every catalog has a library
-name associated with it (e.g. @emph{AstroLib}).  This name will be shown
-briefly when the catalog is found, and in the routine info of routines
-it documents.
+Library catalogs consist of files named @file{.idlwave_catalog} stored
+in directories containing @code{.pro} routine files.  They are
+discovered on the IDL search path and loaded automatically when routine
+information is read.  Each catalog file documents the routines found in
+that directory --- one catalog per directory.  Every catalog has a
+library name associated with it (e.g. @emph{AstroLib}).  This name will
+be shown briefly when the catalog is found, and in the routine info of
+routines it documents.
 
 Many popular libraries of routines are shipped with IDLWAVE catalog
 files by default, and so will be automatically discovered.  Library
@@ -3569,7 +3739,8 @@ scanned catalog).  Since all catalogs are independent, they can be
 re-scanned automatically to gather updates, e.g. in a @file{cron} job.
 Scanning is much faster than with the built-in user catalog method.  One
 minor disadvantage: the entire IDL search path is scanned for catalog
-files every time IDLWAVE starts up, which might be slow over a network.
+files every time IDLWAVE starts up, which might be slow if accessing IDL
+routines over a slow network.
 
 A Perl tool to create library catalogs is distributed with IDLWAVE:
 @code{idlwave_catalog}.  It can be called quite simply:
@@ -3577,9 +3748,10 @@ A Perl tool to create library catalogs is distributed with IDLWAVE:
 idlwave_catalog MyLib
 @end example
 
-@noindent This would scan all directories recursively beneath the current and
+@noindent This will scan all directories recursively beneath the current and
 populate them with @file{.idlwave_catalog} files, tagging the routines
-found with the name library ``MyLib''.  The full usage information:
+found there with the name library ``MyLib''.  The full usage
+information:
 
 @example
 Usage: idlwave_catalog  [-l] [-v] [-d] [-s] [-f] [-h] libname
@@ -3601,8 +3773,8 @@ info update using a single prefix to @code{idlwave-update-routine-info}:
 @kbd{C-u C-c C-i}.
 
 @defopt idlwave-use-library-catalogs  (@code{t})
-Whether to search for and load library catalogs.  Only disable if
-performance is a problem and the catalogs are not needed.
+Whether to search for and load library catalogs.  Disable if load
+performance is a problem and/or the catalogs are not needed.
 @end defopt
 
 @node User Catalog,  , Library Catalogs, Catalogs
@@ -3647,11 +3819,11 @@ leads to recursive expansion of the path, just like in IDL}:
 (setq idlwave-system-directory "c:/RSI/IDL56/")
 @end lisp
 
-@noindent Under GNU and UNIX, these values will be automatically gathered from
-the IDLWAVE shell.
+@noindent Under GNU/Linux and UNIX, these values will be automatically
+gathered from the IDLWAVE shell, if run.
 
 The command @kbd{M-x idlwave-create-user-catalog-file} (or the menu item
-@samp{IDLWAVE->Routine Info->Select Catalog Directories} can then be
+@samp{IDLWAVE->Routine Info->Select Catalog Directories}) can then be
 used to create a user catalog.  It brings up a widget in which you can
 select some or all directories on the search path.  Directories which
 already contain a library catalog are marked with @samp{[LIB]}, and need
@@ -3729,7 +3901,7 @@ many other reasons.
 @cindex MacOS
 @cindex IDL variable @code{!DIR}
 @cindex @code{!DIR}, IDL variable
-Users of Windows and MacOS also must set the variable
+Users of Windows and MacOS (not X) also must set the variable
 @code{idlwave-system-directory} to the value of the @code{!DIR} system
 variable in IDL.  IDLWAVE appends @file{lib} to the value of this
 variable and assumes that all files found on that path are system
@@ -3745,67 +3917,78 @@ on the load path is routine info display (@pxref{Routine Info}).
 @cindex Scanning the documentation
 @cindex Perl program, to create @file{idlw-rinfo.el}
 
+@strong{Starting with version 6.2, IDL is distributed directly with HTML
+online help, and an XML-based catalog of routine information}.  This
+makes scanning the manuals with the tool @file{get_html_rinfo}, and the
+@file{idlw-rinfo.el} file it produced, as described here, entirely
+unnecessary.  The information is left here for users wishing to produce
+a catalog of older IDL versions' help.
+
+
 IDLWAVE derives its knowledge about system routines from the IDL
 manuals.  The file @file{idlw-rinfo.el} contains the routine information
 for the IDL system routines, and links to relevant sections of the HTML
 documentation.  The Online Help feature of IDLWAVE requires HTML
 versions of the IDL manuals to be available; the HTML documentation is
 not distributed with IDLWAVE by default, but must be downloaded
-separately from the @uref{@value{IDLWAVE-HOMEPAGE}, the maintainers
-webpage}.
+separately from @uref{@value{IDLWAVEHOMEPAGE}, the maintainers webpage}.
 
 The HTML files and related images can be produced from the
 @file{idl.chm} HTMLHelp file distributed with IDL using the free
 Microsoft HTML Help Workshop.  If you are lucky, the maintainer of
-IDLWAVE will always have access to the newest version of IDL and
-provide updates.  The IDLWAVE distribution also contains the Perl
-program @file{get_html_rinfo} which constructs the
-@file{idlw-rinfo.el} file by scanning the HTML documents produced from
-the IDL documentation.  Instructions on how to use
-@file{get_html_rinfo} are in the program itself.
+IDLWAVE will always have access to the newest version of IDL and provide
+updates.  The IDLWAVE distribution also contains the Perl program
+@file{get_html_rinfo} which constructs the @file{idlw-rinfo.el} file by
+scanning the HTML documents produced from the IDL documentation.
+Instructions on how to use @file{get_html_rinfo} are in the program
+itself.
 
 @node HTML Help Browser Tips, Configuration Examples, Sources of Routine Info, Top
 @appendix HTML Help Browser Tips
 @cindex Browser Tips
 
+The following information pertains to IDL versions >=5.0 and
+<7.0.  With IDL v7.0, the IDL Assistant was dropped in favor of the
+Eclipse-based help system, and IDL is no longer distributed with the
+raw HTML help files.
+
 There are a wide variety of possible browsers to use for displaying
 the online HTML help available with IDLWAVE (starting with version
-5.0).  Since IDLWAVE runs on a many different system types, a single
-browser configuration is not possible, but choices abound.
-
-On many systems, the default browser configured in
-@code{browse-url-browser-function}, and hence inherited by default by
+5.0). Since IDL v6.2, a single cross-platform HTML help browser, the
+@emph{IDL Assistant} is distributed with IDL.  If this help browser is
+available, it is the preferred choice, and the default.  The variable
+@code{idlwave-help-use-assistant}, enabled by default, controls
+whether this help browser is used.  If you use the IDL Assistant, the
+tips here are not relevant.
+
+Since IDLWAVE runs on a many different system types, a single browser
+configuration is not possible, but choices abound.  On many systems,
+the default browser configured in @code{browse-url-browser-function},
+and hence inherited by default by
 @code{idlwave-help-browser-function}, is Netscape.  Unfortunately, the
-HTML manuals decompiled from the original RSI source contain
-formatting structures which Netscape 4.x does not handle well, though
-they are still readable.  A much better choice is Mozilla, or one of
-the Mozilla-derived browsers such as
-@uref{http://galeon.sourceforge.net/,Galeon} (Linux),
+HTML manuals decompiled from the original source contain formatting
+structures which Netscape 4.x does not handle well, though they are
+still readable.  A much better choice is Mozilla, or one of the
+Mozilla-derived browsers such as
+@uref{http://galeon.sourceforge.net/,Galeon} (GNU/Linux),
 @uref{http://www.mozilla.org/projects/camino/,Camino} (MacOSX), or
 @uref{http://www.mozilla.org/projects/firebird/,Firebird} (all
 platforms).  Newer versions of Emacs provide a browser-function choice
 @code{browse-url-gnome-moz} which uses the Gnome-configured browser.
 
-Note that the HTML files decompiled from RSI Microsoft Help sources
-contain specific references to the @samp{Symbol} font, which by default
-is not permitted in normal encodings (it's invalid, technically).  Though
-it only impacts a few symbols, you can trick Mozilla-based browsers into
+Note that the HTML files decompiled from the help sources contain
+specific references to the @samp{Symbol} font, which by default is not
+permitted in normal encodings (it's invalid, technically).  Though it
+only impacts a few symbols, you can trick Mozilla-based browsers into
 recognizing @samp{Symbol} by following the directions
-@uref{http://hutchinson.belmont.ma.us/tth/Xfonts.html, here}.  With this
-fix in place, HTML help pages look almost identical to their PDF
-equivalents (yet can be bookmarked, browsed as history, searched, etc.).
+@uref{http://hutchinson.belmont.ma.us/tth/Xfonts.html, here}.  With
+this fix in place, HTML help pages look almost identical to their PDF
+equivalents (yet can be bookmarked, browsed as history, searched,
+etc.).
 
 @noindent Individual platform recommendations:
 
 @itemize @bullet
-@item Windows: The native Microsoft HTMLHelp browser is preferred,
-with even better results using the free
-@uref{http://www.keyworks.net/keyhh.htm,@code{KEYHH}} program to
-permit IDL help to be targetted to a single window.  To use HTMLHelp,
-specify @code{idlwave-help-use-hh} as @code{'hh} or @code{'keyhh}.
-One bonus: since IDL is shipped with the @file{idl.chm} help file, you
-don't need to download the HTML help package.  @xref{Help with HTML
-Documentation}.
 @item Unix/MacOSX: The @uref{http://www.w3m.org,@code{w3m}} browser
 and its associated
 @uref{http://emacs-w3m.namazu.org/,@code{emacs-w3m}} emacs mode
@@ -4000,9 +4183,9 @@ user is King!
                                         "help,___,/STRUCTURE"))))
 @end example
 
-@ifhtml
+@html
 <A NAME="WIN_MAC"></A>
-@end ifhtml
+@end html
 @node Windows and MacOS, Troubleshooting, Configuration Examples, Top
 @appendix Windows and MacOS
 @cindex Windows
@@ -4013,43 +4196,34 @@ IDLWAVE was developed on a UNIX system.  However, thanks to the
 portability of Emacs, much of IDLWAVE does also work under different
 operating systems like Windows (with NTEmacs or NTXEmacs) or MacOS.
 
-The only real problem is that RSI does not provide a command-line
-version of IDL for Windows or MacOS(<=9) with which IDLWAVE can
-interact@footnote{Call your RSI representative and complain --- it
-should be trivial for them to provide one.  And if enough people ask for
-it, maybe they will.  The new MacOSX version of IDL @emph{does} have a
-shell and works well with IDLWAVE.}.  As a result, the IDLWAVE Shell
-does not work and you have to rely on IDLDE to run and debug your
-programs.  However, editing IDL source files with Emacs/IDLWAVE works
-with all bells and whistles, including routine info, completion and fast
-online help.  Only a small amount of additional information must be
-specified in your @file{.emacs} file: the path names which, on a UNIX
-system, are automatically gathered by talking to the IDL program.
+The only real problem is that there is no command-line version of IDL
+for Windows or MacOS(<=9) with which IDLWAVE can interact.  As a
+result, the IDLWAVE Shell does not work and you have to rely on IDLDE
+to run and debug your programs.  However, editing IDL source files
+with Emacs/IDLWAVE works with all bells and whistles, including
+routine info, completion and fast online help.  Only a small amount of
+additional information must be specified in your @file{.emacs} file:
+the path names which, on a UNIX system, are automatically gathered by
+talking to the IDL program.
 
 Here is an example of the additional configuration needed for a Windows
 system.  I am assuming that IDLWAVE has been installed in
 @w{@samp{C:\Program Files\IDLWAVE}} and that IDL is installed in
-@w{@samp{C:\RSI\IDL55}}.
+@w{@samp{C:\RSI\IDL63}}.
 
 @lisp
-;; location of the lisp files (needed if IDLWAVE is not part of 
-;; the X/Emacs installation)
+;; location of the lisp files (only needed if IDLWAVE is not part of
+;; your default X/Emacs installation)
 (setq load-path (cons "c:/program files/IDLWAVE" load-path))
 
-;; The location of the IDL library files, both from RSI and your own.
+;; The location of the IDL library directories, both standard,  and your own.
 ;; note that the initial "+" expands the path recursively
 (setq idlwave-library-path
-        '("+c:/RSI/IDL55/lib/" "+c:/user/me/idllibs" ))
+        '("+c:/RSI/IDL63/lib/" "+c:/path/to/my/idllibs" ))
 
 ;; location of the IDL system directory (try "print,!DIR")
-(setq idlwave-system-directory "c:/RSI/IDL55/")
-
-;; specify using the HTMLHelp documentation for online help, with the
-;;  KEYHH helper routine (Windows only)
-(setq idlwave-use-hh 'keyhh)
+(setq idlwave-system-directory "c:/RSI/IDL62/")
 
-;; file in which to store the user catalog info
-(setq idlwave-user-catalog-file "c:/IDLWAVE/idlcat.el")
 @end lisp
 
 @noindent Furthermore, Windows sometimes tries to outsmart you --- make
@@ -4067,10 +4241,10 @@ Windows users who'd like to make use of IDLWAVE's context-aware HTML
 help can skip the browser and use the HTMLHelp functionality directly.
 @xref{Help with HTML Documentation}.
 
-@ifhtml
+@html
 <A NAME="TROUBLE"></A>
-@end ifhtml
-@node Troubleshooting, Index, Windows and MacOS, Top
+@end html
+@node Troubleshooting, GNU Free Documentation License, Windows and MacOS, Top
 @appendix Troubleshooting
 @cindex Troubleshooting
 
@@ -4132,8 +4306,8 @@ place, and this is the source of the error.  If you recompile (or just
 "make; make install") from source, it should resolve this problem.
 Another option is to recompile the @file{idlw*.el} files by hand using
 @kbd{M-x byte-compile-file}.  Why not take the opportunity to grab the
-latest IDLWAVE version at @uref{@value{IDLWAVE-HOMEPAGE}, the
-maintainers webpage}
+latest IDLWAVE version at @uref{@value{IDLWAVEHOMEPAGE}, the maintainers
+webpage}.
 
 @item @strong{@kbd{M-@key{TAB}} doesn't complete words, it switches
 windows on my desktop.}
@@ -4161,7 +4335,7 @@ with it, as long as you update the prompt it's looking for (@samp{IDL>
 in your @file{.emacs}:
 
 @lisp
-(setq idlwave-shell-prompt-pattern "^\\(ENVI\\|IDL\\)> ")
+(setq idlwave-shell-prompt-pattern "^\r? ?\\(ENVI\\|IDL\\)> ")
 @end lisp
 
 @item @strong{Attempts to set breakpoints fail: no breakpoint is
@@ -4193,7 +4367,8 @@ accomplish this by putting the following in your @file{.emacs}:
 @end lisp
 
 @noindent You can check on your load-path value using @kbd{C-h v
-load-path @key{RET}}.
+load-path @key{RET}}, and @kbd{C-h m} in an IDLWAVE buffer should show
+you the version Emacs is using.
 
 @item @strong{IDLWAVE is screwing up the formatting of my @file{.idl} files.}
 
@@ -4215,10 +4390,10 @@ Information Sources}).  Routines in files visited in a buffer or
 compiled in the shell should be up to date.  For other routines, the
 information is only as current as the most recent scan.  If you have a
 rapidly changing set of routines, and you'd like the latest routine
-information to be available for it, one powerful technique makes use of
-the library catalog tool, @samp{idlwave_catalog}.  Simply add a line to
-your @samp{cron} file (@samp{crontab -e} will let you edit this on some
-systems), like this:
+information to be available for it, one powerful technique is to make
+use of the library catalog tool, @samp{idlwave_catalog}.  Simply add a
+line to your @samp{cron} file (@samp{crontab -e} will let you edit this
+on some systems), like this
 
 @example
 45 3 * * 1-5 (cd /path/to/myidllib; /path/to/idlwave_catalog MyLib)
@@ -4228,6 +4403,7 @@ systems), like this:
 rescan all @file{.pro} files at or below @file{/path/to/myidllib} every
 week night at 3:45am.  You can even scan site-wide libraries with this
 method, and the most recent information will be available to all users.
+Since the scanning is very fast, there is very little impact.
 
 @item @strong{All the Greek-font characters in the HTML help are
 displayed as Latin characters!}
@@ -4235,12 +4411,12 @@ displayed as Latin characters!}
 Unfortunately, the HTMLHelp files RSI provides attempt to switch to
 @samp{Symbol} font to display Greek characters, which is not really an
 permitted method for doing this in HTML.  There is a "workaround" for
-many browsers: @xref{HTML Help Browser Tips}.
+some browsers: @xref{HTML Help Browser Tips}.
 
 @item @strong{In the shell, my long commands are truncated at 256 characters!}
 
 This actually happens when running IDL in an XTerm as well.  There are
-a couple of work arounds: @code{define_key,/control,'^d'} (e.g. in
+a couple of workarounds: @code{define_key,/control,'^d'} (e.g. in
 your @file{$IDL_STARTUP} file) will disable the @samp{EOF} character
 and give you a 512 character limit.  You won't be able to use
 @key{C-d} to quit the shell, however.  Another possibility is
@@ -4255,13 +4431,33 @@ is loaded is one page off, e.g. for @code{CONVERT_COORD}, I get
 You have a mismatch between your help index and the HTML help package
 you downloaded.  You need to ensure you download a ``downgrade kit'' if
 you are using anything older than the latest HTML help package.  A new
-help package apppears with each IDL release (assuming the documentation
-is updated).  See @uref{@value{IDLWAVE-HOMEPAGE}, the maintainers
-webpage} for more.
+help package appears with each IDL release (assuming the documentation
+is updated).  See @uref{@value{IDLWAVEHOMEPAGE}, the maintainers
+webpage} for more.  Note that, starting with IDL 6.2, the HTML help and
+its catalog are distributed with IDL, and so should never be
+inconsistent.
+
+@item @strong{I get errors such as @samp{void-variable
+browse-url-browser-function} or similar when attempting to load IDLWAVE
+under XEmacs.}
+
+You don't have the @samp{browse-url} (or other required) XEmacs package.
+Unlike GNU Emacs, XEmacs distributes many packages separately from the
+main program.  IDLWAVE is actually among these, but is not always the
+most up to date.  When installing IDLWAVE as an XEmacs package, it
+should prompt you for required additional packages.  When installing it
+from source, it won't and you'll get this error.  The easiest solution
+is to install all the packages when you install XEmacs (the so-called
+@samp{sumo} bundle).  The minimum set of XEmacs packages required by
+IDLWAVE is @samp{fsf-compat, xemacs-base, mail-lib}.
 
 @end enumerate
 
-@node Index,  , Troubleshooting, Top
+@node GNU Free Documentation License, Index, Troubleshooting, Top
+@appendix GNU Free Documentation License
+@include doclicense.texi
+
+@node Index,  , GNU Free Documentation License, Top
 @unnumbered Index
 @printindex cp
 
</textarea>
<div id='lijstmetdingen'></div>
		</body>
	</body>
</html>
